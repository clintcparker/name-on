define("HubsExtension/ServicesHealth/ServicesHealthArea",["require","exports","f","o","ko","HubsExtension/ServicesHealth/ServicesHealthClientStrings","HubsExtension/ArmHelpers/ArmApisStartup","HubsExtension/Common/HubsObservables","HubsExtension/ServicesHealth/Models/ServicesHealthModels","HubsExtension/ServicesHealth/ServicesHealthCommon"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function it(n){return{width:n,height:n}}function rt(n,t){return{normal:it(n),large:it(t)}}function l(n,t){return n[(t||"").toLowerCase()]}function bt(n,t,i){return l(n,t)===i}function ut(n){return bt(c,n,c.outage)}function kt(n){return!!t.allowedRegionsFromConfigLowerCased[(n.name||"").toLowerCase()]||!!(n.flags&2)}function dt(n){var t;return n?ut(n&&n.incidentType)&&(t=n.level):t="healthy",t}function ft(n){return l(w,n)||w.information}function gt(n,t){return t.sortCode()-n.sortCode()}function ni(n,t){return n.sortCode()-t.sortCode()}function ti(n,t){var r=t===3?g.wide:g.default,i=l(r,n);return i?i:(p.warning("Unknown icon size option '{0}'".format(n),0),g.default.normal)}function ii(n,t){var r,u;if(!n)return t;if(!t)return n;var f=l(c,n.incidentType)||c.unknown,e=l(c,t.incidentType)||c.unknown,i=f-e;return i===0&&(r=l(a,n.level)||a.unknown,u=l(a,t.level)||a.unknown,i=r-u),i<0?t:n}function ri(n){if(n){var t=n.properties&&n.properties.Region,i=n.properties&&n.properties.IncidentType;return{correlationId:n.correlationId,incidentType:i||null,status:n.status&&n.status.value,level:n.level,regions:t&&t.split(",")||null}}}function ui(n){return n.toLowerCase()===b.name.toLowerCase()}function fi(n){return!ui(n.id)}function ei(n,t,i){var r=n.map((function(n){return e.getEventDigestsApi(n,t,i,"ResourceProvider eq 'Azure.Health'")}));return e.callBatchAndFollowContinuationTokens(r,!0,e.makeResourceManagerTelemetry("ServicesHealth.getEvents"),!0).then((function(n){return n.filter((function(n){var t=n.status;return!(t&&t.value&&t.value.toLowerCase()==="resolved")}))}))}function ot(n){return n.toLowerCase().replace(/ /g,"")}function st(n,t,i){var r=(i.name||"").toLowerCase(),u;t.hasOwnProperty(r)?p.error("Ignoring duplicate location name {0}".format(i),2):(t[r]=n.length,u=0,r===v&&(u=u|1),n.push({name:i.name,displayName:i.displayName||r,longitude:i.longitude,latitude:i.latitude,gridIconName:"",mapIconName:"",iconSizeName:"",correlationId:"",flags:u,sortCode:0}))}function oi(n,t,i){var r=[],u={},f={};return t.forEach((function(n){st(r,u,n,null,!1)})),i.forEach((function(n){var i=n.regions||[],t=ut(n.incidentType);i.forEach((function(i){if(i){var o=void 0,s=i.toLowerCase(),e=ot(s);u.hasOwnProperty(e)||(e===v?st(r,u,b,n,t):p.warning("Unknown location '{0}' reported in event '{1}'".format(e,JSON.stringify(n)),1));u.hasOwnProperty(e)&&(o=r[u[e]]);o&&(f[e]=ii(f[e],n),t&&(o.flags=o.flags|4))}}))})),r.forEach((function(n){var t=f[n.name],r,i;t&&(n.flags|=2);n.correlationId=t&&t.correlationId||"";r=dt(t);i=ft(r);n.gridIconName=i.gridIconName;n.mapIconName=r;n.iconSizeName=i.iconSizeName;n.sortCode=i.sortCode})),n&&r.push(wt),d()?r.filter(kt):r}function ht(n,t,i){var r={id:t.name(),location:new pt.Location(t.latitude(),t.longitude()),metadata:{icon:u.observable(),iconWidth:u.observable(),iconHeight:u.observable()},displayName:t.displayName(),gridIconName:t.gridIconName,correlationId:t.correlationId,flags:t.flags,sortCode:t.sortCode,isGlobal:!!(t.flags()&1),isMatsGlobal:!!(t.flags()&8)};return u.reactor(n,(function(){var u=ft(t.mapIconName()),n=ti(t.iconSizeName(),i());r.metadata.icon(u.mapIconImage);r.metadata.iconWidth(n.width);r.metadata.iconHeight(n.height)})),r}function si(n){var t=!1;return n.forEach((function(n){var r=ot(n.Name).toLowerCase(),u=(n.Status||"").toLowerCase(),i;r===b.name&&(i=et[u]||0,t=i===1)})),t}function ct(n,t,i,r){var f=u.observableArray(),e=u.observableArray(),o;return t.mapInto(n,i,e),o=u.pureComputed((function(){var n=e();return r(n)})),o.subscribe(n,(function(n){f(n)})),f}function hi(n){return n.slice(0).sort(gt)}function ci(n){return n.filter(fi).sort(ni)}var a,d,et,lt;r.defineProperty(t,"__esModule",{value:!0});var at=i.Azure,y=i.Base,vt=y.Diagnostics,yt=y.Resources,pt=i.ViewModels.Controls.Visualization.Map,tt=f.ServiceHealth,p=vt.createLog(n),v="multi-region",w=s.KnownSeverityInfo,b={name:v,displayName:tt.globalLocationDisplayName,latitude:-1e10,longitude:-1e10},k=w.error,wt={name:v,displayName:tt.globalAzureStatusDisplayName,latitude:-1e10,longitude:-1e10,gridIconName:k.gridIconName,mapIconName:"critical",iconSizeName:k.iconSizeName,correlationId:"",flags:15,sortCode:k.sortCode},c;(function(n){n[n.unknown=-1]="unknown";n[n.advisory=0]="advisory";n[n.maintenance=1]="maintenance";n[n.action=2]="action";n[n.outage=3]="outage"})(c||(c={})),(function(n){n[n.unknown=-1]="unknown";n[n.informational=0]="informational";n[n.warning=1]="warning";n[n.error=2]="error";n[n.critical=3]="critical"})(a||(a={}));t.allowedRegionsFromConfigLowerCased=i.extendArrayIntoMap({},i.getEnvironmentValue("servicesHealthAllowedRegions")||[],(function(n){return n.toLowerCase()}));d=function(){return!!r.keys(t.allowedRegionsFromConfigLowerCased).length};t.icon=h.areaIcon;var g={"default":rt(15,20),wide:rt(11,15)},nt={name:"HubsExtension._LocationEvents",properties:{name:null,displayName:null,longitude:null,latitude:null,correlationId:null,gridIconName:null,mapIconName:null,iconSizeName:null,flags:null,sortCode:null,region:null},entityType:!0,idProperties:[]},li=(function(){function n(){}return n})();et={red:1,orange:2,yellow:2,green:4,blue:3};lt=(function(){function n(){var n=this;this._lastMetadata={subscriptionIds:[],startTime:new Date,endTime:new Date};this._query=new i.Data.QueryCache({entityTypeName:nt.name,sourceUri:function(){return"loc"},supplyData:function(){var t=n._supplyData();return t.finally((function(){n.isLoading(!1)})),t},serializeParams:function(){return"loc"}});this.isLoading=u.observable(!0);i.Data.Metadata.setTypeMetadata(nt.name,nt)}return n.prototype.getServicesHealthLoadMetadata=function(){return this._lastMetadata},n.prototype.createGridView=function(n,t){var r=this,i=this._query.createView(n),u=ct(n,i.items,(function(n,i){return ht(n,i,t)}),hi),f=function(){return i.fetch({})};return{items:u,fetch:f,refresh:function(){return r._refreshQuery(n)}}},n.prototype.createMapView=function(n,t){var r=this,i=this._query.createView(n),u=ct(n,i.items,(function(n,i){return ht(n,i,t)}),ci),f=function(){return i.fetch({})};return{items:u,fetch:f,refresh:function(){return r._refreshQuery(n)}}},n.prototype._refreshQuery=function(n){return this._query.refresh({},n)},n.prototype._supplyData=function(){var i=this,t=new Date,n=new Date;n.setDate(n.getDate()-1);var u=at.getAllSubscriptions(),f=o.getLocations(),e=d()?Q(y.Net.ajax({uri:yt.getAppRelativeUri("/api/ServiceHealth")}).then((function(n){return(n.value||[]).some((function(n){return si(n.Regions||[])}))}))):Q(!1);return u.then((function(u){var o=u.map((function(n){return n.subscriptionId})),s=ei(o,n,t).then((function(n){if(n.length){var t={};n.forEach((function(n){var i=n.subscriptionId;i&&(t[i]=!0)}));o=r.keys(t)}return n.map(ri)}));return e.then((function(r){return f.then((function(u){return s.then((function(f){return i._lastMetadata={subscriptionIds:o,startTime:n,endTime:t},oi(r,u,f)}))}))}))}))},n})();t.DataContext=lt}))