define("HubsExtension/Common/HubsPermissions",["require","exports","f","FxHubs/Permissions","HubsExtension/ArmHelpers/ArmApisStartup","HubsExtension/Common/HubsObservables","HubsExtension/Common/SubscriptionsCommon"],(function(n,t,i,r,u,f,e){"use strict";var o;return (function(n){function o(n){var i=[],e=Q(!1),r;return t.isResourceManagerId(n)&&(r=t.parseResourceManagerDescriptor(n).subscription,r&&(e=f.isCoAdminOnSub(r))),e.then((function(t){if(t)return h;var r=u.callWithContinuation([u.getPermissionsApi(n)],(function(n){n.actions=n.actions||[];n.notActions=n.notActions||[];i=i.concat(n)}),(function(n){throw n.reason;}),u.makeResourceManagerTelemetry("HubsPermissions.getPermissions"));return r.then((function(){return i})).catch((function(n){var t=n&&n.jqXHR&&n.jqXHR.status;switch(t){case 403:case 401:return[{actions:[],notActions:[]}]}throw n;}))}))}var t=i.ViewModels.Services.ResourceTypes,h=[{actions:["*"],notActions:[]}],s;n.getPermissionsFromArm=o,(function(i){function u(t,i,r){return n.hubsChecker.hasPermission(t,i,r)}function s(){return n.hubsChecker.getDiagnostics()}i.hasPermission=u;i.getDiagnostics=s;var h=(function(){function n(n){this._permissionsCache=r.createCachedPermissionsGetter(o,n)}return n.prototype.hasPermission=function(n,t,i){var f=this,u=r.PermissionChecker;return u.isRDFEAction(t)?this.hasRdfePermissions(n):u.hasPermission(n,t,i,(function(n){return f._permissionsCache.getPermissions(n)}))},n.prototype.getDiagnostics=function(){return this._permissionsCache.getCachedPermissions()},n.prototype.hasRdfePermissions=function(n){return t.isSubscriptionId(n)?f.getSubscription(t.parseSubscriptionDescriptor(n).subscription).then(e.subscriptionRequiresRdfe):Q(!1)},n})();i.HubsPermissionsChecker=h})(s=n.Internal||(n.Internal={}));n.hubsChecker=new s.HubsPermissionsChecker})(o||(o={})),o}));
define("HubsExtension/Common/PopulationPromiseCache",["require","exports"],(function(){"use strict";var n;return (function(n){var t=(function(){function n(){this._cache={}}return n.prototype.isPopulationRunning=function(n){return!!this._cache[n]},n.prototype.getPopulatePromise=function(n){if(!this.isPopulationRunning(n))throw new Error("Population for this key is not running");return this._cache[n]},n.prototype.addPopulatePromise=function(n,t){var i=this;if(this.isPopulationRunning(n))throw new Error("Population for this key is already running");this._cache[n]=t;t.finally((function(){delete i._cache[n]}))},n})();n.PopulationPromiseCache=t})(n||(n={})),n}));
define("HubsExtension/Locks/LocksArea",["require","exports","f","i","o","ko","HubsExtension/Locks/LocksClientStrings","HubsExtension/ArmHelpers/ArmApis","HubsExtension/ArmHelpers/ArmApisStartup","HubsExtension/Common/HubsPermissions"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function st(n,t){var i=typeof n=="number"?n:y(n,t,!1);switch(i){case 1:return e.thisResource;case 2:return e.parentResource;case 3:return e.resourceGroup;case 4:return e.subscription;default:return e.childResource}}function y(n,t,i){if(i===void 0&&(i=!0),n=i?p(n):n,c.isParentResource(t,n))return 0;if(c.isResourceId(n)){if(t.toLowerCase()===n.toLowerCase())return 1;if(c.isParentResource(n,t))return 2}return c.isResourceGroupId(n)?3:c.isSubscriptionId(n)?4:void 0}function p(n){return n.slice(0,n.lastIndexOf("/providers"))}function ht(n){et.Log.writeEntry(1,"HubsExtension.locks",n)}function it(n,t){return n.name.localeCompare(t.name)}function rt(n){var t=[],i=o.locksOnResourceApi(n),u=s.makeResourceManagerTelemetry("LocksArea.getLocks");return s.call(i,"GET",null,u,!1).then((function(n){return n.value.forEach((function(n){t.push(n)})),t=t.sort(it)})).catch((function(i){return ht("Error getting locks for "+n+". Error: "+r.Azure.buildSimplifiedError(i)),t=t.sort(it)}))}function ct(n){return rt(n.resourceId).then((function(t){return t=t.filter((function(t){return t.properties.level,tt[t.properties.level]>=tt[n.lockLevel]&&y(t.id,n.resourceId,!0)!==0})),!!t.length}))}var a,l,w;u.defineProperty(t,"__esModule",{value:!0});var ut=h.Internal,ft=i.Base,b=i.Data.Metadata,et=ft.Diagnostics,ot=i.Data,c=i.ViewModels.Services.ResourceTypes,v=i.Hubs.Notifications,k=v.NotificationStatus,d=c.isParentResource,g=e.AddEdit,nt=e.Delete,tt={CanNotDelete:1,ReadOnly:2};t.LockLevelMap={ReadOnly:e.readOnly,CanNotDelete:e.delete};t.getScopeRelationship=st;t.getScopeRelationshipEnum=y;t.getResourceIdFromLockScope=p;t.LockLevels=u.keys(t.LockLevelMap);t.getIsLocked=ct;a="HubsExtension.TypeMetadata.Locks.Lock";l=w=(function(){function n(){b.getTypeMetadata(a)||b.setTypeMetadata(a,{properties:{key:null,value:null,compound:null,commandGroup:null,allowEdits:null,resourceId:null},entityType:!0})}return u.defineProperty(n.prototype,"locksCache",{get:function(){return w.locksCache},enumerable:!0,configurable:!0}),n.prototype.putLock=function(n,t,i){var e=this,h=o.createLockOnResourceApi(n,t),u=i.properties,f;return u.notes=u.notes||"",f=s.makeResourceManagerTelemetry("LocksArea.putLock"),s.callRaw({armApiOrUri:h,httpMethod:"PUT",data:i,telemetry:f}).then((function(n){e._applyChanges(n.content)}),(function(n){var i=r.Azure.buildSimplifiedError(n.jqXHR);new v.ClientNotification({title:g.failureTitle,description:g.failureDescription.format(t,i.message),status:k.Error}).publish()}))},n.prototype.deleteLock=function(n){var t=this,i=o.deleteLockOnResourceApi(n),r=s.makeResourceManagerTelemetry("LocksArea.deleteLock");return s.callRaw({armApiOrUri:i,httpMethod:"DELETE",telemetry:r,useApiInvoke:!1,noBatch:!1}).then((function(){t._applyChanges(null,n)})).catch((function(t){new v.ClientNotification({title:nt.failureTitle,description:nt.failureDescription.format(n.slice(n.lastIndexOf("/")+1),JSON.stringify(t)),status:k.Error}).publish()}))},n.prototype.getLockPermissions=function(n,t){return ut.hasPermission(n,["Microsoft.Authorization/locks/"+t],[])},n.prototype._applyChanges=function(n,t){var i=!1;t=n&&n.id||(i=!0)&&t;this.locksCache.applyChanges((function(r,u){var e=u.data().first((function(n){return n.id()===t})),o,s,h;e?i?u.removeItem(e):(o=e.properties(),s=n.properties,e.id(n.id),e.name(n.name),o.level(s.level),o.notes(s.notes)):(h={id:f.observable(n.id),name:f.observable(n.name),properties:f.observable({level:f.observable(n.properties.level),notes:f.observable(n.properties.notes)})},u.addItems(0,[h],null,!1,u.data().tags))}),(function(n){var i=p(t);return n.resourceId===i||d(n.resourceId,i)||d(i,n.resourceId)}))},n})();l.locksCache=new ot.QueryCache({httpMethod:"GET",serializeParams:function(n){return n.resourceId},supplyData:function(n,t,i,r,u){return rt(u.resourceId)},entityTypeName:a});l=w=__decorate([i.Composition.ProxyCompatibilityMode,__metadata("design:paramtypes",[])],l);t.DataContext=l}));
define("HubsExtension/Locks/ViewModels/AddLockFormViewModel",["require","exports","f","ko","Fx/Controls/DropDown","HubsExtension/Locks/LocksClientStrings","HubsExtension/Locks/LocksArea"],(function(n,t,i,r,u,f,e){"use strict";var o;return (function(n){var t=i.ViewModels,c=i.Base.Images,l=t.Toolbars,a=t.Dialogs,s=t.Forms.TextBox.ViewModel,v=t.getValidationResult,o=t.getValidationResultPromise,y=90,h="\\s~!@#$%^&*+=<>,\\?/\\\\\\:;'\"\\[\\]\\{\\}\\|",p=(function(n){function i(i,l){var w=n.call(this)||this,p=new s(i,{label:r.observable(f.lockName)}),k,d,b;return p.validations.push(new t.CustomValidation(f.nameRequired,function(n){var t=!n||!n.length;return o(t&&f.nameRequired)})),p.validations.push(new t.LengthRangeValidation(0,y,f.nameInvalid)),p.validations.push(new t.RegExMatchValidation("^[^"+h+"]*[^."+h+"]$",f.nameInvalid)),p.validations.push(new t.CustomValidation(f.nameUnique,function(n){return Q(l.nameIsUnique(n)).then((function(n){return v(!n&&f.nameUnique)}))})),k=new s(i,{label:r.observable(f.notes)}),d=u.create(i,{label:r.observable(f.lockType),items:r.observableArray(e.LockLevels.map((function(n){return{text:r.observable(e.LockLevelMap[n]),value:n}}))),validations:r.observableArray([new t.CustomValidation(f.levelRequired,function(n){var t=!n||!n.length;return o(t&&f.levelRequired)})])}),d.validations.push(new t.CustomValidation(f.levelRequired,function(n){var t=!n||!n.length;return o(t&&f.levelRequired)})),b=new a.FormDialog(f.addLock),b.row1column1=p,b.row1column2=d,b.row2column1=k,w.label(f.add),w.icon(c.Add()),w.dialogOptions=b,w.command={execute:function(n){return n===1?Q.reject():l.context.putLock(l.resourceId(),p.value(),{properties:{level:d.value(),notes:k.value()}}).then((function(){p.value("");k.value("")}))},canExecute:r.observable(!0)},w}return __extends(i,n),i})(l.DialogButton);n.AddLockFormViewModel=p})(o||(o={})),o}));
define("HubsExtension/Locks/ViewModels/LocksBladeViewModel",["require","exports","f","ko","HubsExtension/Locks/LocksClientStrings","HubsExtension/_generated/ExtensionDefinition","HubsExtension/Common/PopulationPromiseCache","HubsExtension/Locks/LocksArea","HubsExtension/Locks/ViewModels/AddLockFormViewModel"],(function(n,t,i,r,u,f,e,o,s){"use strict";var h;return (function(t){function w(n){return h.isResourceId(n)?h.buildSubscriptionIdFromResourceId(n):h.isResourceGroupId(n)?h.buildSubscriptionIdFromResourceGroupId(n):void 0}function b(n){if(h.isResourceId(n)&&!h.isTenantResource(n)){var t=h.parseResourceDescriptor(n);try{return h.buildParentResourceIdFromDescriptor(t)}catch(i){return h.buildResourceGroupIdFromDescriptor(t)}}}var d=e.PopulationPromiseCache,g=s.AddLockFormViewModel,v=i.Base,nt=v.Diagnostics,l=i.ViewModels,tt=l.Blade,h=l.Services.ResourceTypes,a=l.Toolbars,y=i.Base.Images,c=l.Controls.Lists.Grid,it=l.Controls.InfoBox,rt=i.Resources.Strings.Part.SettingList,p=nt.createLog(n),k;t.parseRootId=w;t.parseParentId=b;k=(function(n){function t(t,i,f){var e=n.call(this)||this;return e.resourceId=r.observable(),e.type=r.observable(),e.launchParentId=r.observable(),e.launchRootId=r.observable(),e.editLockId=r.observable(),e.gridLocks=r.observableArray(),e.cantEditFromScopeInfoBox=r.observable(),e._permissions=r.observable({}),e._context=f,e._container=t,e._initializeToolbar(t),e._populationPromiseCache=new d,e._createGrid(),e._createCantEditFromScopeMessage(),e._initializeCollector(),e.title(u.managementLocks),e}return __extends(t,n),t.prototype.onInputsSet=function(n){var t=this,i=n.resourceId,u=i.split("/").last(),r;return this.subtitle(u),this.type(n.type),this.resourceId(n.resourceId),r=this._context.getLockPermissions,h.isSubscriptionId(i)&&this.title(rt.locksForSubscriptions),Q.spread([r(i,"Write"),r(i,"Read"),r(i,"Delete"),],(function(n,r,u){var e,s;return t._resourceLockView=t._context.locksCache.createView(t._container),t.locks=t._resourceLockView.items,t._resourceLockView.items.subscribe(t._container,(function(n){t.gridLocks(n.map((function(n){var e=n.id,i=t.resourceId(),r=o.getScopeRelationshipEnum(n.id(),i),u;return r===undefined?(p.error("Lock <'"+e()+"'> is not in the scope <'"+i+"'>"),{}):(u=n.properties(),{name:n.name,level:u.level,id:e,scope:o.getScopeRelationship(r,i),scopeEnum:r,notes:u.notes,commandGroup:t._permissions().delete?f.CommandGroupNames.lockCommands:undefined})})).filter((function(n){return!!n.scope})))})),t._permissions({read:r,write:n,"delete":u}),e=[],n&&e.push(new g(t._container,{resourceId:t.resourceId,context:t._context,nameIsUnique:function(n){return Q(!t.locks().first((function(t){return t.name()===n})))}})),t.launchParentId(s=b(i)),s&&(t.openParentLocksButton.label(o.getScopeRelationship(s,t.resourceId())),e.push(t.openParentLocksButton)),t.launchRootId(s=w(i)),s&&(t.openSubscriptionLocksButton.label(o.getScopeRelationship(s,t.resourceId())),e.push(t.openSubscriptionLocksButton)),e.push(t._createRefreshBladeButton()),t.commandBar.setItems(e),t._runPopulate()}),null),Q()},t.prototype._initializeToolbar=function(n){this.commandBar=new a.Toolbar(n);this.openParentLocksButton=this._createOpenBladeButton(u.parentLocks);this.openSubscriptionLocksButton=this._createOpenBladeButton(u.rootLocks)},t.prototype._createOpenBladeButton=function(n){var t=new a.OpenBladeButton;return t.label(n),t.icon(y.Lock()),t},t.prototype._createRefreshBladeButton=function(){var t=this,n=new a.CommandButton;return n.label(u.refresh),n.icon(y.Refresh()),n.command={execute:function(){return t.gridLocks([]),t._resourceLockView.refresh()},canExecute:r.observable(!0)},n},t.prototype._createCantEditFromScopeMessage=function(){var n=this,t;this.cantEditFromScopeInfoBox(new it.ViewModel(this._container,null,null,{text:r.computed(this._container,(function(){return n._permissions().write?u.editScopeMessage:u.editPermissionMessage})),image:r.observable(v.Images.Warning()),size:r.observable(0)}));t=this.gridLocks.map(this._container,(function(t,i){var r=n.locksGridViewModel.getRowMetadata(i),u;return r&&r.disabled(!n._permissions().write),u=n.resourceId(),i.scopeEnum>o.getScopeRelationshipEnum(u,u,!1)&&r&&r.disabled(!0),r&&r.disabled()}));this.locksDisabled=r.computed(this._container,(function(){return!!~t().indexOf(!0)}))},t.prototype._createGrid=function(){var t=this,i={selectableRow:{selectionMode:1,itemMatchesSelection:function(n,t){return n.id()===t.id()},createSelection:function(n){return t.locks().first((function(t){return t.id()===n.id()}))}}},n=new c.ViewModel(this._container,this.gridLocks,c.Extensions.SelectableRow|c.Extensions.ContextMenuShortcut,i),f=[{itemKey:"name",name:r.observable(u.name),format:c.Format.Text,width:r.observable("15%"),activatable:r.observable(!0)},{itemKey:"level",name:r.observable(u.lockType),format:c.Format.TextLookup,formatOptions:{textLookup:o.LockLevelMap},width:r.observable("15%")},{itemKey:"scope",name:r.observable(u.scope),format:c.Format.Text,width:r.observable("20%")},{itemKey:"notes",name:r.observable(u.notes),format:c.Format.Text,width:r.observable("50%")},];n.columns=r.observableArray(f);n.showHeader=!0;n.noRowsMessage=r.observable(u.noLocks);n.selectableData.itemsArePinnable(!1);this.locksGridViewModel=n},t.prototype._initializeCollector=function(){var n=this;this.lockCollector=new l.ParameterCollector(this._container,{supplyInitialData:function(n){return n},receiveResult:function(t){var i=r.toJS(t);n._context.putLock(o.getResourceIdFromLockScope(i.id),i.name,{properties:i.properties})},selectableSet:this.locksGridViewModel.selectableData})},t.prototype._runPopulate=function(){var r=this,n=this.resourceId(),t=this._populationPromiseCache,i;return t.isPopulationRunning(n)?t.getPopulatePromise(n):(i=this._permissions().read?this._resourceLockView.fetch({resourceId:n}).catch((function(t){p.verbose("Error retrieving entity locks: '"+n+"' with error: '"+t+"'");r.locksGridViewModel.noRowsMessage(u.lockError)})):Q(),this._permissions().read||this.locksGridViewModel.noRowsMessage(u.readPermissionMessage),t.addPopulatePromise(n,i),i)},t})(tt);t.LocksBladeViewModel=k})(h||(h={})),h}));
define("HubsExtension/_generated/Blades/LocksBlade",["require","exports","o","HubsExtension/Locks/ViewModels/LocksBladeViewModel"],(function(n,t,i){"use strict";i.defineProperty(t,"__esModule",{value:!0});t.blade={name:"LocksBlade",entryPoint:{module:"HubsExtension/Locks/ViewModels/LocksBladeViewModel","export":"LocksBladeViewModel"},inputs:["resourceId"],templateKeyInputs:["resourceId"],viewModelName:"Locks$LocksBladeViewModel",lenses:[],toolbar:{source:{valuesFrom:[{referenceType:0,property:"content.commandBar"}]}},templateBlade:{details:[{selectablePath:"content.openParentLocksButton.selectable",blade:"LocksBlade",selectableBindings:[{property:"resourceId",valuesFrom:[{referenceType:3,property:"content.launchParentId"}]}]},{selectablePath:"content.openSubscriptionLocksButton.selectable",blade:"LocksBlade",selectableBindings:[{property:"resourceId",valuesFrom:[{referenceType:3,property:"content.launchRootId"}]}]},{selectablePath:"content.locksGridViewModel.selectableData",blade:"LockEditBlade",selectableBindings:[{property:"lockId",valuesFrom:[{referenceType:6,property:"id"}]}],parameterCollector:"content.lockCollector"}],partSize:0,htmlTemplateInline:{file:"LockResourceListPart.html",content:"<div data-bind=\"visible: locksDisabled, pcControl: cantEditFromScopeInfoBox\"><\/div> <div data-bind='pcGrid: locksGridViewModel'><\/div>"},styleSheets:[]},attributes:0}}))