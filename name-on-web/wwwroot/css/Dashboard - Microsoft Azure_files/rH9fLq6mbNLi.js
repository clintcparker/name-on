define("ApplicationManagement/ApplicationProxy/ApplicationProxyData",["require","exports","f","o","a","ko","Shared/AjaxExtensions","CommonConstants","ApplicationManagement/Constants","ApplicationManagement/ApplicationProxy/Utilities/GeneralUtils","Permissions/Permission","Shared/Utilities"],(function(n,t,i,r,u,f,e,o,s,h,c,l){"use strict";var w,b;r.defineProperty(t,"__esModule",{value:!0});var a=ApplicationManagement.ApplicationProxy.MsGraph.Beta,v=ApplicationManagement.MsGraph,p=i.Data.Metadata,y;(function(n){n[n.None=0]="None";n[n.Success=1]="Success";n[n.InProgress=2]="InProgress";n[n.Failure=3]="Failure"})(y=t.ApplicationProxyOperationStatus||(t.ApplicationProxyOperationStatus={})),(function(n){n[n.None=0]="None";n[n.NoLicense=1]="NoLicense";n[n.NoPermissionsForTenantSettings=2]="NoPermissionsForTenantSettings";n[n.NoPermissionsForTenantUpdateSettings=3]="NoPermissionsForTenantUpdateSettings";n[n.NoPermissionsForAppSettings=4]="NoPermissionsForAppSettings";n[n.Disabled=5]="Disabled";n[n.NotAvailableInRegion=6]="NotAvailableInRegion";n[n.FederatedSsoEnabled=7]="FederatedSsoEnabled";n[n.NoActiveConnectorsFoundForTenant=8]="NoActiveConnectorsFoundForTenant"})(w=t.ApplicationProxyContentState||(t.ApplicationProxyContentState={}));i.Data.Metadata.setTypeMetadata(o.booleanEntityType.name,o.booleanEntityType);b=(function(){function n(n){var t=this;this._connectorGroupsListOperationUriTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/ConnectorGroups");this._connectorGroupEntityOperationUriTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/ConnectorGroups/{0}");this._connectorEntityOperationUriTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/Connectors/{0}");this._getConnectorGroupAppsListUriTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/ConnectorGroups/{0}/Applications");this._appProxyTenantSettingsTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/TenantSettings");this._getApplicationSettingsTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/Applications/{0}");this._updateApplicationSettingsTemplate=i.Base.Resources.getAppRelativeUri("/api/ApplicationProxy/Applications/{0}?origExternalUrl={1}&&isFirstApp={2}&&enableAppProxy={3}");this._getVerifiedDomainsTemplate=i.Base.Resources.getAppRelativeUri("api/Common/VerifiedDomains");this._getDirectoryTemplate=i.Base.Resources.getAppRelativeUri("api/ApplicationProxy/Directory");this._validateExternalUrlTemplate=i.Base.Resources.getAppRelativeUri("api/ApplicationProxy/ValidateExternalUrl?appUrl={0}");this._setHeaderBasedAuthTemplate=i.Base.Resources.getAppRelativeUri("api/ApplicationProxy/Applications/{0}/HeaderBasedSso");this._removeOnPremSsoTemplate=i.Base.Resources.getAppRelativeUri("api/Application/Applications/{0}/RemoveOnPremSso");this.isUrlValidNotifier=f.observable();this.defaultGroupId=f.observable("");this.newAppServicePrincipalId=f.observable("");this.ApplicationProxyContentState=f.observable(null);this.businessScenarios=l.getBusinessScenarios();this.parentDataContext=n;this.operationNotifiers={appSettings:f.observable(null),tenantSettings:f.observable(null),connector:f.observable(null),connectorGroup:f.observable(null)};this.AppProxyConnectorGroupListQuery=new i.Data.QueryCache({entityTypeName:a.ConnectorGroupType,sourceUri:function(){return t._connectorGroupsListOperationUriTemplate},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyData(t.businessScenarios.applicationProxy(),"GetConnectorGroups","GetConnectorGroups","Retrieve list of connector groups",n,i,r,u,f,o)}});this.AppProxyConnectorGroupAppsQuery=new i.Data.QueryCache({entityTypeName:v.ApplicationType,sourceUri:function(n){return t._getConnectorGroupAppsListUriTemplate.format(n.id)},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyDataPerTargetObject(t.businessScenarios.applicationProxy(),"GetConnectorGroupApps","GetConnectorGroupApps","Get applications associated with a connector group",f.id,"AppProxyConnectorGroup",n,i,r,u,f,o)}});this.AppProxyVerifiedDomainsListQuery=new i.Data.QueryCache({entityTypeName:ApplicationManagement.Graph.v16.DomainType,sourceUri:function(){return t._getVerifiedDomainsTemplate},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyData(t.businessScenarios.domains(),"GetVerifiedDomains","GetVerifiedDomains","Retrieve list of verified domains",n,i,r,u,f,o)}});this.AppProxyDirectoryPropertiesEntity=new i.Data.EntityCache({entityTypeName:Directories.DataModels.DirectoryType,sourceUri:function(){return t._getDirectoryTemplate},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyData(t.businessScenarios.applicationProxy(),"GetDirectoryProperties","GetDirectoryProperties","Get directory properties",n,i,r,u,f,o)}});this.AppProxyConnectorEntity=new i.Data.EntityCache({entityTypeName:a.ConnectorType,sourceUri:function(n){return t._connectorEntityOperationUriTemplate.format(n.id)},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyDataPerTargetObject(t.businessScenarios.applicationProxy(),"GetConnector","GetConnector","Get connector",f.id,"AppProxyConnector",n,i,r,u,f,o)}});this.AppProxyConnectorGroupEntity=new i.Data.EntityCache({entityTypeName:a.ConnectorGroupType,sourceUri:function(n){return t._connectorGroupEntityOperationUriTemplate.format(n.id)},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyDataPerTargetObject(t.businessScenarios.applicationProxy(),"GetConnectorGroup","GetConnectorGroup","Get connector group",f.id,"AppProxyConnectorGroup",n,i,r,u,f,o)},findCachedEntity:{queryCache:this.AppProxyConnectorGroupListQuery,entityMatchesId:function(n,t){return n.id()===t.id}}});this.AppProxyApplicationSettingsEntity=new i.Data.EntityCache({entityTypeName:v.ApplicationType,sourceUri:function(n){return t._getApplicationSettingsTemplate.format(n.appId)},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyDataPerTargetObject(t.businessScenarios.applicationProxy(),"GetApplicationSettings","GetApplicationSettings","Get application settings",f.appId,"Application",n,i,r,u,f,o)}});this.AppProxyTenantSettingsEntity=new i.Data.EntityCache({entityTypeName:a.OnPremTenantSettingsType,sourceUri:function(){return t._appProxyTenantSettingsTemplate},poll:!1,supplyData:function(n,i,r,u,f,o){return e.AuthenticatedToAdIbizaUx.trackedSupplyData(t.businessScenarios.applicationProxy(),"GetTenantSettings","GetTenantSettings","Get tenant settings",n,i,r,u,f,o)}});this.ConnectorDetailsEditScopeCache=i.Data.EditScopeCache.createNew({dataCache:this.AppProxyConnectorEntity,entityTypeName:a.ConnectorType,serializeParams:function(n){return n.id},saveEditScopeChanges:function(n,r){var u=r.root;return e.AuthenticatedToAdIbizaUx.trackedAjax(t.businessScenarios.applicationProxy(),"UpdateConnectorDetails","UpdateConnectorDetails","Update connector details",{uri:t._connectorEntityOperationUriTemplate.format(encodeURI(u.id())),type:o.httpVerbs.patch,data:f.toJSON(u),contentType:o.httpContentTypes.applicationJson}).then((function(){return t.AppProxyConnectorGroupListQuery.applyChanges((function(n,i){t._moveConnectorInCache(u,r.getOriginal(u).connectorGroupId(),u.connectorGroupId(),!1,i)})),t.AppProxyConnectorGroupEntity.applyChanges((function(n,i){t._moveConnectorInCache(u,r.getOriginal(u).connectorGroupId(),u.connectorGroupId(),!1,i)})),{action:i.Data.AcceptEditScopeChangesAction.AcceptClientChanges}}))}});this.ConnectorGroupDetailsEditScopeCache=i.Data.EditScopeCache.createNew({entityTypeName:a.ConnectorGroupType,serializeParams:function(n){return n.id},dataCache:this.AppProxyConnectorGroupEntity,supplyNewData:function(){return{id:f.observable(""),name:f.observable(""),members:f.observableArray(),isDefault:f.observable(!1)}},saveEditScopeChanges:function(n,r){var u=r.root,e=u.id()==="",f=t._getUpdateConnectorGroupQuery(r),o=e?t.addConnectorGroup(f,u,r):t.updateConnectorGroup(f,u,r);return o.then((function(){return{action:i.Data.AcceptEditScopeChangesAction.AcceptClientChanges}}))}});this.ApplicationSettingsEditScopeCache=i.Data.EditScopeCache.createNew({supplyExistingData:function(n){if(!n.appId||n.appId===""||!!n.defaultRoot)return Q(n.defaultRoot);var i={appId:n.appId};return t.AppProxyApplicationSettingsEntity.fetch(i,null).then((function(t){var i=t.data();if(!!n.defaultRoot&&!!n.defaultRoot.onPremisesPublishing()){i.onPremisesPublishing(n.defaultRoot.onPremisesPublishing());i.connectorGroupId(n.defaultRoot.connectorGroupId())}return i}))},entityTypeName:v.ApplicationType,serializeParams:function(n){return n.appId},refreshEditScope:function(n){var i={appId:n.appId};return t.AppProxyApplicationSettingsEntity.refresh(i,null).then((function(){return t.AppProxyApplicationSettingsEntity.fetch(i,null).then((function(n){return n.data()}))}))},saveEditScopeChanges:function(n,r){var u=r.root,s=r.getOriginal(u),h=u,c=f.observable(!1),l=f.observable(!1);return s.onPremisesPublishing().internalUrl()?h=t._getAppPatchObject(s,u):s.connectorGroupId()===""&&(c(!0),t.ApplicationProxyContentState()!==w.NoPermissionsForTenantUpdateSettings&&l(!0)),h.onPremisesPublishing().verifiedCustomDomainCertificatesMetadata(null),e.AuthenticatedToAdIbizaUx.trackedAjax(t.businessScenarios.applicationProxy(),"UpdateApplicationSettings","UpdateApplicationSettings","Update the application settings",{uri:t._updateApplicationSettingsTemplate.format(u.appId(),encodeURIComponent(t._origExternalUrl(s,u)),c(),l()),type:o.httpVerbs.patch,data:f.toJSON(h),contentType:o.httpContentTypes.applicationJson}).then((function(){return n.appId?{action:i.Data.AcceptEditScopeChangesAction.RefreshFromServerImplicitly}:{action:i.Data.AcceptEditScopeChangesAction.AcceptClientChanges}}))}})}return n.prototype.updateTenantSettings=function(n){var t=this;return e.AuthenticatedToAdIbizaUx.trackedAjax(this.businessScenarios.applicationProxy(),"UpdateTenantSettings","UpdateTenantSettings","Update tenant settings",{uri:this._appProxyTenantSettingsTemplate,type:o.httpVerbs.post,data:f.toJSON(n),contentType:o.httpContentTypes.applicationJson}).then((function(){var i={status:y.Success,operationType:c.ActionType.Update,resultData:n.isOnPremPublishingEnabled()};t.operationNotifiers.tenantSettings.notifySubscribers(i)}))},n.prototype.deleteConnectorGroup=function(n,t){var i=this;if(n&&t)return e.AuthenticatedToAdIbizaUx.trackedAjaxPerTargetObject(this.businessScenarios.applicationProxy(),"DeleteConnectorGroup","DeleteConnectorGroup","Delete a connector group",n,"AppProxyConnectorGroup",{uri:this._connectorGroupEntityOperationUriTemplate.format(encodeURI(n)),type:o.httpVerbs.delete}).then((function(){i.AppProxyConnectorGroupListQuery.applyChanges((function(t,r){i._removeConnectorGroupFromCache(n,r)}));i.AppProxyConnectorGroupEntity.applyChanges((function(t,r){i._removeConnectorGroupFromCache(n,r)}))}))},n.prototype.validateExternalUrl=function(n){var t=this;return e.AuthenticatedToAdIbizaUx.trackedAjax(this.businessScenarios.applicationProxy(),"ValidateExternalUrl","ValidateExternalUrl","Validate if the external url is valid",{uri:this._validateExternalUrlTemplate.format(encodeURIComponent(n)),type:o.httpVerbs.get}).then((function(n){t.isUrlValidNotifier.notifySubscribers(n)}))},n.prototype.addConnectorGroup=function(n,t,i){var r=this;return!t||!n?null:e.AuthenticatedToAdIbizaUx.trackedAjax(this.businessScenarios.applicationProxy(),"AddConnectorGroup","AddConnectorGroup","Add a connector group",{uri:this._connectorGroupsListOperationUriTemplate,type:o.httpVerbs.post,data:f.toJSON(n),contentType:o.httpContentTypes.applicationJson}).then((function(n){t.id(n);r.AppProxyConnectorGroupListQuery.applyChanges((function(n,i){r._addConnectorGroupToCache(t,i)}));r.AppProxyConnectorGroupEntity.applyChanges((function(n,i){r._addConnectorGroupToCache(t,i)}));var i={status:y.Success,operationType:c.ActionType.Create,resultData:t};r.operationNotifiers.connectorGroup.notifySubscribers(i)})).catch((function(n){i.revertAll();r.AppProxyConnectorGroupListQuery.refreshAll();throw n;}))},n.prototype.updateConnectorGroup=function(n,t,i){var r=this;return!t||!n?null:e.AuthenticatedToAdIbizaUx.trackedAjax(this.businessScenarios.applicationProxy(),"UpdateConnectorGroup","UpdateConnectorGroup","Update a connector group",{uri:this._connectorGroupEntityOperationUriTemplate.format(encodeURI(t.id())),type:o.httpVerbs.patch,data:f.toJSON(n),contentType:o.httpContentTypes.applicationJson}).then((function(){r.AppProxyConnectorGroupListQuery.applyChanges((function(i,u){r._updateConnectorGroupToCache(t.id(),n,u)}));r.AppProxyConnectorGroupEntity.applyChanges((function(i,u){r._updateConnectorGroupToCache(t.id(),n,u)}))})).catch((function(n){i.revertAll();r.AppProxyConnectorGroupListQuery.refreshAll();throw n;}))},n.prototype.setHeaderBasedSso=function(n){return e.AuthenticatedToAdIbizaUx.trackedAjaxPerTargetObject(this.businessScenarios.applicationProxy(),"SetHeaderBasedSso","SetHeaderBasedSso","Set header based SSO",n,"Application",{uri:this._setHeaderBasedAuthTemplate.format(n),type:o.httpVerbs.patch})},n.prototype.removeOnPremSso=function(n,t){return e.AuthenticatedToAdIbizaUx.trackedAjaxPerTargetObject(this.businessScenarios.applicationProxy(),"RemoveOnPremSso","RemoveOnPremSso","Remove on-premises SSO",n,"Application",{uri:this._removeOnPremSsoTemplate.format(n),type:o.httpVerbs.patch,data:f.toJSON(t),contentType:o.httpContentTypes.applicationJson})},n.prototype._getUpdateConnectorGroupQuery=function(n){var t=n.root,i=n.getOriginal(n.root),r=t.members().map((function(n){return n.id()})),u=i.members().map((function(n){return n.id()})),e=f.observableArray(r.filter((function(n){return u.indexOf(n)<0}))),o=f.observableArray(u.filter((function(n){return r.indexOf(n)<0}))),s=t.name()!==i.name()?f.observable(t.name()):f.observable();return{name:s,assignedConnectorIds:e,removedConnectorIds:o}},n.prototype._findCachedConnectorGroup=function(n,t){var r=null,i=t.data();return u.isArray(i)?i.first((function(t){return t.id()===n?(r=t,!0):!1})):r=i.id()===n?i:null,r},n.prototype._findCachedConnector=function(n,t){var f=this,i=null,r=t.data();return u.isArray(r)?r.forEach((function(t){i==null&&(i=f._findConnectorInConnectorGroup(n,t))})):i=this._findConnectorInConnectorGroup(n,r),i},n.prototype._findConnectorInConnectorGroup=function(n,t){var r=null,i=t.members();return i?i.length===0?null:(i.first((function(t){return t.id()===n?(r=t,!0):!1})),r):null},n.prototype._removeConnectorGroupFromCache=function(n,t){var i=this._findCachedConnectorGroup(n,t);i!=null&&t.removeItem(i)},n.prototype._addConnectorGroupToCache=function(n,t){var i=this;n.id&&(f.utils.arrayForEach(n.members(),(function(r){var u=i._findCachedConnector(r.id(),t);u&&(i._moveConnectorInCache(r,u.connectorGroupId(),n.id(),!0,t),r.connectorGroupId(n.id()))})),t.addItems(0,[n]))},n.prototype._updateConnectorGroupToCache=function(n,t,i){var r=this,u=this._findCachedConnectorGroup(n,i);u&&(t.name()&&u.name(t.name()),t.removedConnectorIds().forEach((function(n){var t=r._findConnectorInConnectorGroup(n,u);t!=null&&r._moveConnectorInCache(t,t.connectorGroupId(),r.defaultGroupId(),!1,i)})),t.assignedConnectorIds().forEach((function(t){var u=r._findCachedConnector(t,i);u!=null&&r._moveConnectorInCache(u,u.connectorGroupId(),n,!1,i)})),i.data.notifySubscribers(i.data()))},n.prototype._moveConnectorInCache=function(n,t,i,r,u){var e,f,o;(t||r)&&i&&t!==i&&(r||(n.connectorGroupId(i),e=this._findCachedConnectorGroup(i,u),e!=null&&e.members.push(n)),f=this._findCachedConnectorGroup(t,u),o=u.data(),f!=null&&(f.members.remove((function(t){return t.id()===n.id()?!0:!1})),h.isUnassignedConnectorGroup(f.name())&&f.members().length===0&&o.remove(f)),u.data.notifySubscribers(o))},n.prototype._getAppPatchObject=function(n,t){var i=p.createEmptyObject(v.ApplicationType),r;i.id(t.id());i.appId(t.appId());n.connectorGroupId()!==t.connectorGroupId()&&i.connectorGroupId(t.connectorGroupId());r=this._onPremPublishingSettingsChanged(n.onPremisesPublishing(),t.onPremisesPublishing());i.onPremisesPublishing(r);return i},n.prototype._onPremPublishingSettingsChanged=function(n,t){var r=p.createEmptyObject(v.ApplicationType),i=r.onPremisesPublishing();return n.isOnPremPublishingEnabled()!==t.isOnPremPublishingEnabled()?i.isOnPremPublishingEnabled(t.isOnPremPublishingEnabled()):i.isOnPremPublishingEnabled(null),n.internalUrl()!==t.internalUrl()&&i.internalUrl(t.internalUrl()),n.externalUrl()!==t.externalUrl()&&i.externalUrl(t.externalUrl()),n.externalAuthenticationType()!==t.externalAuthenticationType()&&i.externalAuthenticationType(t.externalAuthenticationType()),n.applicationServerTimeout()!==t.applicationServerTimeout()&&i.applicationServerTimeout(t.applicationServerTimeout()),n.isTranslateHostHeaderEnabled()!==t.isTranslateHostHeaderEnabled()?i.isTranslateHostHeaderEnabled(t.isTranslateHostHeaderEnabled()):i.isTranslateHostHeaderEnabled(null),n.isTranslateLinksInBodyEnabled()!==t.isTranslateLinksInBodyEnabled()?i.isTranslateLinksInBodyEnabled(t.isTranslateLinksInBodyEnabled()):i.isTranslateLinksInBodyEnabled(null),t.verifiedCustomDomainPasswordCredential()&&t.verifiedCustomDomainKeyCredential()?(i.verifiedCustomDomainPasswordCredential(t.verifiedCustomDomainPasswordCredential()),i.verifiedCustomDomainKeyCredential(t.verifiedCustomDomainKeyCredential())):(i.verifiedCustomDomainPasswordCredential(null),i.verifiedCustomDomainKeyCredential(null)),i},n.prototype._origExternalUrl=function(n,t){if(n.onPremisesPublishing().internalUrl()==="")return t.onPremisesPublishing().externalUrl();var i=t.onPremisesPublishing().externalUrl()!==n.onPremisesPublishing().externalUrl();return i?n.onPremisesPublishing().externalUrl():""},n.prototype.markAppAsOnPrem=function(n){var t=this;this.parentDataContext.applicationCapabilities.applyChanges((function(n,i){t._updateAppCapabilities(i)}),(function(t){return t===n}));this.parentDataContext.applicationEntities.applyChanges((function(n,i){t._updateAppTags(i)}),(function(t){return t===n}))},n.prototype._updateAppCapabilities=function(n){var t=n.data(),i={capabilityType:f.observable(s.EnterpriseManagementCapabilityType[s.EnterpriseManagementCapabilityType.WindowsAuthenticationSingleSignOn])};t.push(i)},n.prototype._updateAppTags=function(n){var t=n.data();t.tags.push(s.onPremAppTag)},n.prototype.handleNewOnPremApp=function(){var n=this.newAppServicePrincipalId();n!==""&&(this.markAppAsOnPrem(n),this.newAppServicePrincipalId(""))},n.prototype.IsOnPremApp=function(n){return!!n&&!!n.tags()&&n.tags().indexOf(s.onPremAppTag)>-1?!0:this.newAppServicePrincipalId()===n.objectId()?(this.markAppAsOnPrem(n.objectId()),this.newAppServicePrincipalId(""),!0):!1},n})();t.ApplicationProxyData=b}))