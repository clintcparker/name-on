define("ReleaseManagement/TypeScript/Utilities/AppServiceArmApiManager",["require","exports","f","o","ko","Core/TypeScript/TFS.Azure","ReleaseManagement/TypeScript/Utilities/LogHelper","ReleaseManagement/TypeScript/Utilities/Utils","AzureProject/TypeScript/Utilities/AzureProjectLogHelper"],(function(n,t,i,r,u,f,e,o,s){"use strict";r.defineProperty(t,"__esModule",{value:!0});var h=i.Base.Diagnostics.Telemetry,c="ResourceTemplateProviderBase|{0}",l=(function(){function n(){var n=this;this._appServicesResourceData=u.observable();this._appServiceArmVersion="?api-version=2015-08-01";this.appServiceResourceData=u.pureComputed((function(){var t=n._appServicesResourceData(),i={name:"",isSlot:!1,id:"",type:"",location:"",subscriptionId:"",properties:{hostNames:[""],resourceGroup:"",sku:"",serverFarmId:"",reserved:!1}};return t&&t.properties&&(t.properties.hostNames&&t.properties.hostNames.length>0&&(i.properties.hostNames=t.properties.hostNames),t.properties.sku&&(i.properties.sku=t.properties.sku,h.trace({source:"AppServiceArmApiManager",action:"WebAppSku"+i.properties.sku})),t.properties.resourceGroup&&(i.properties.resourceGroup=t.properties.resourceGroup),t.properties.serverFarmId&&(i.properties.serverFarmId=t.properties.serverFarmId),i.properties.reserved=t.properties.reserved),t&&t.location&&(i.location=t.location,h.trace({source:"AppServiceArmApiManager",action:"WebAppLocation"+i.location})),t&&t.id&&(i.id=t.id),t&&t.type&&(i.type=t.type,i.type==="Microsoft.Web/sites/slots"&&(i.isSlot=!0)),t&&t.name&&(i.name=t.name),i.subscriptionId=n._getSubscriptionId(),i}))}return n.prototype.setWebSiteResourceUri=function(n){this._websiteResourceUri!==n&&(this._fetchingDataPromise=null);this._websiteResourceUri=n},n.prototype.getWebSiteResourceUri=function(){return this._websiteResourceUri},n.prototype.clearCachedSlots=function(){this._fetchingSlotListPromise=null},n.prototype.clearCachedWebAppList=function(){this._fetchingWebAppsPromise=null},n.prototype.clearCachedWebAppSettings=function(){this._fetchingWebAppSettingPromise=null},n.prototype.clearAppServiceResourceData=function(){this._fetchingDataPromise=null},n.prototype.fetchAppServiceResourceData=function(){var n=this,t;return this._fetchingDataPromise||(t=Q.defer(),this._fetchingDataPromise=t.promise,this._getCsmUrl().then((function(r){var u=r+n._websiteResourceUri+n._appServiceArmVersion;i.Base.Net2.ajax({uri:u,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(i){e.LogHelper.LogInfo("fetchAppServiceResourceData, OutCome: Success, Website resource uri: {0}".format(n._websiteResourceUri));n._appServicesResourceData(i);t.resolve()}),(function(i){n._appServicesResourceData(undefined);e.LogHelper.LogError("fetchAppServiceResourceData, OutCome: Failure, Website resource uri: {0}, error: {1}".format(n._websiteResourceUri,JSON.stringify(i)));t.reject(i)}))}))),this._fetchingDataPromise},n.prototype.beginGetSlotList=function(){var n=this,t;return this._fetchingSlotListPromise||(t=Q.defer(),this._fetchingSlotListPromise=t.promise,this.fetchAppServiceResourceData().then((function(){var r=n._websiteResourceUri;n.appServiceResourceData().isSlot&&(r=o.ResourceUriHelper.truncateUriFromEnd(r,2));n._getCsmUrl().then((function(u){var f=u+r+"/slots"+n._appServiceArmVersion;i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){e.LogHelper.LogInfo("beginGetSlotList, OutCome: Success, csmRequest uri: {0}".format(f));t.resolve(n)}),(function(n){e.LogHelper.LogError("beginGetSlotList, OutCome: Failed, csmRequest uri: {0}, error: {1}".format(f,JSON.stringify(n)));t.reject()}))}))}),(function(){e.LogHelper.LogError("beginGetSlotList: Failed to fetch app resource Data")}))),this._fetchingSlotListPromise},n.prototype.beginGetWebAppsList=function(){var t=this,n;return this._fetchingWebAppsPromise||(n=Q.defer(),this._fetchingWebAppsPromise=n.promise,this.fetchAppServiceResourceData().then((function(){var r=t._websiteResourceUri,u;r=t.appServiceResourceData().isSlot?o.ResourceUriHelper.truncateUriFromEnd(r,3):o.ResourceUriHelper.truncateUriFromEnd(r,1);u=t._getWebAppListQueryUrl(r);i.Base.Net2.ajax({uri:u,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(t){e.LogHelper.LogInfo("beginGetWebAppsList, OutCome: Success, csmRequest uri: {0}".format(u));n.resolve(t)}),(function(t){e.LogHelper.LogError("beginGetWebAppsList, OutCome: Failed, csmRequest uri: {0}, error: {1}".format(u,t));n.reject()}))}),(function(){e.LogHelper.LogError("beginGetWebAppsList: Failed to fetch app resource Data")}))),this._fetchingWebAppsPromise},n.prototype.beginGetAppServiceSiteConfig=function(n){var r=this,t=Q.defer();return this._getCsmUrl().then((function(u){n||(n=r._websiteResourceUri);var f=u+n+"/config/web"+r._appServiceArmVersion;i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){t.resolve(n)}),(function(n){e.LogHelper.LogError("beginGetAppServiceSiteConfig, OutCome: Failed, csmRequest uri: {0}, error: {1}".format(f,JSON.stringify(n)));t.reject(n)}))})),t.promise},n.prototype.beginGetAppSettings=function(n){var r=this,t;return this._fetchingWebAppSettingPromise||(t=Q.defer(),this._fetchingWebAppSettingPromise=t.promise,this._getCsmUrl().then((function(u){n||(n=r._websiteResourceUri);var f=u+n+"/config/appsettings/list"+r._appServiceArmVersion;i.Base.Net2.ajax({uri:f,type:"POST",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){t.resolve(n)}),(function(n){e.LogHelper.LogError("beginGetAppSettings, OutCome: Failed, csmRequest uri: {0}, error: {1}".format(f,JSON.stringify(n)));t.reject()}))}))),this._fetchingWebAppSettingPromise},n.prototype.beginGetAppServiceType=function(n){var r=this,t=Q.defer();return this._getCsmUrl().then((function(u){i.isNullOrUndefined(n)&&(e.LogHelper.LogError("beginGetAppServiceType, Empty Server Farm Url"),t.reject());var f=u+n+r._appServiceArmVersion;i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){t.resolve(n)}),(function(n){e.LogHelper.LogError("beginGetAppServiceType, OutCome: Failed, csmRequest uri: {0}, error: {1}".format(f,JSON.stringify(n)));t.reject()}))})),t.promise},n.prototype.beginUpdateAppServiceSiteConfig=function(n,t){var u=this,r=Q.defer();return this._getCsmUrl().then((function(f){t||(t=u._websiteResourceUri);var o=f+t+"/config/web"+u._appServiceArmVersion;i.Base.Net2.ajax({uri:o,type:"PATCH",dataType:"json",data:JSON.stringify(n),cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){r.resolve(n)}),(function(n){e.LogHelper.LogError("beginUpdateAppServiceSiteConfig, OutCome: Failed, csmRequest uri: {0}, error:{1}".format(o,JSON.stringify(n)));r.reject(n)}))})),r.promise},n.prototype.beginGetAppServiceMetaData=function(){var t=this,n=Q.defer();return this._getCsmUrl().then((function(r){var u=r+t._websiteResourceUri+"/config/metadata/list"+t._appServiceArmVersion;i.Base.Net2.ajax({uri:u,type:"POST",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(t){n.resolve(t)}),(function(t){e.LogHelper.LogError("beginGetAppServiceMetaData, OutCome: Failed, csmRequest uri: {0}, error:{1}".format(u,JSON.stringify(t)));n.reject(t)}))})),n.promise},n.prototype.beginPushAppServiceDeploymentLog=function(n,t,r){var f=this,u=Q.defer();return this._getCsmUrl().then((function(o){var s=o+t+"/deployments/"+r+f._appServiceArmVersion;i.Base.Net2.ajax({uri:s,type:"PUT",dataType:"json",data:JSON.stringify(n),contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){u.resolve(n)}),(function(n){e.LogHelper.LogError("beginPushAppServiceDeploymentLog, OutCome: Failed, csmRequest uri: {0}, error:{1}".format(s,JSON.stringify(n)));u.reject(n)}))})),u.promise},n.prototype.beginGetSiteExtensions=function(n){var r=this,t=Q.defer();return this._getCsmUrl().then((function(u){n||(n=r._websiteResourceUri);var f=u+n+"/siteextensions"+r._appServiceArmVersion;i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){t.resolve(n)}),(function(n){e.LogHelper.LogError("beginGetSiteExtensions, OutCome: Failed, csmRequest uri: {0}, error:{1}".format(f,JSON.stringify(n)));t.resolve([])}))})),t.promise},n.prototype.beginGetRuntimeStack=function(n){var r=this,t=Q.defer();return this._getCsmUrl().then((function(u){var f=u+"/providers/Microsoft.Web/availableStacks"+r._appServiceArmVersion+"&osTypeSelected="+n;i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){e.LogHelper.LogInfo("beginGetRuntimeStack, OutCome: Success, csmRequest uri: {0}".format(f));t.resolve(n)}),(function(n){s.AzureProjectLogHelper.logError(s.AzureProjectLogHelper.getDetailedError(n,c.format(["beginGetRuntimeStack"])));t.resolve("")}))})),t.promise},n.prototype._getSubscriptionId=function(){var n=this._websiteResourceUri;return!n?"":(n=n.toLowerCase(),n.substring(n.indexOf("subscriptions/")+14,n.indexOf("/resourcegroups")))},n.prototype._getWebAppListQueryUrl=function(n){return this._getCsmUrl()+n+this._appServiceArmVersion},n.prototype._getCsmUrl=function(){var n=Q.defer();return f.extensionReadyWithoutAccountsLoad().then((function(){var t=f.getCsmUrl();t===""&&(t="https://management.azure.com/");n.resolve(t)})),n.promise},n})();t.AppServiceArmApiManager=l}))