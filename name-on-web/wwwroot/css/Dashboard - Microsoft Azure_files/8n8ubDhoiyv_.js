var __extends=this&&this.__extends||
(function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}})();
define("Core/TypeScript/TFS.Location.WebApi",["require","exports","o","Core/TypeScript/TFS.WebApi"],(function(n,t,i,r){"use strict";var u,f;i.defineProperty(t,"__esModule",{value:!0}),(function(n){n.AreaName="location";n.ServiceDefinitionsResource="ServiceDefinitions";n.ServiceDefinitionsLocationId="D810A47D-F4F4-4A62-A03F-FA1860585C4C"})(u=t.LocationConstants||(t.LocationConstants={}));f=(function(n){function t(t){return n.call(this,t)||this}return __extends(t,n),t.prototype.beginGetServiceDefinitions=function(n){return this._beginRequest({area:u.AreaName,locationId:u.ServiceDefinitionsLocationId,responseIsCollection:!0,routeValues:{serviceType:n}})},t})(r.VssHttpClient);t.LocationHttpClient=f}));
define("Core/TypeScript/TFS.Stats",["require","exports","o","Core/TypeScript/TFS.Core"],(function(n,t,i,r){"use strict";function c(n,t,i){f&&u.push(n,t,i)}function l(n,t,i){var h,o,c;if(f||console.warn("Stats module is not enabled. Call TFS.Stats.enable() to enable metric collection."),h=u.extract(n),i=i||!1,t==="rowcount"){console.log("ROWCOUNT: %f",h.length);return}for(o=0,c=0;c<h.length;++c){var l=h[c],s=l.name,e=l.metrics;switch(t){case"sum":console.log("\tSUM(%s): %f",s,e.sum());o+=e.sum();break;case"latest":console.log("\tLATEST(%s): %f [%o]",s,e.latest().value,r.DateUtils.ago(e.latest().timestamp));o+=e.latest().value;break;case"frequency":console.log("\tFREQ(%s): %f / minute",s,e.frequency());o+=e.frequency();break;case"count":console.log("\tCOUNT(%s): %f",s,e.count());o+=e.count();break;case"average":console.log("\tAVG(%s): %f",s,e.average());o+=e.average();break;default:console.log("\t%s: %O",s,e)}}i&&console.log("ROLLUP: %f",o)}function a(){f||console.warn("Stats module is not enabled. Call TFS.Stats.enable() to enable metric collection.");u.dump()}function v(n){var i,s,t;f||console.warn("Stats module is not enabled. Call TFS.Stats.enable() to enable metric collection.");var h=u.extract(n),c={},l=null;for(i=0;i<h.length;++i){var e=h[i],o=e.name.split("."),a=o[o.length-1];for(l=o.slice(0,o.length-1).join("."),s=0;s<e.metrics.raw().length;++s)t=e.metrics.raw()[s],c[t.sequence]={id:a,value:t.value,ago:r.DateUtils.ago(t.timestamp),timestamp:t.timestamp,fullname:e.name}}console.table(c)}function y(){f=!0}function p(){f=!1}function w(){u=new e}function b(){u=null}i.defineProperty(t,"__esModule",{value:!0});var o=(function(){function n(n,t,i){this.value=n;this.timestamp=t;this.sequence=i}return n})(),s=(function(){function n(){this._metricList=[]}return n.prototype.push=function(n){this._metricList.push(n)},n.prototype.raw=function(){return this._metricList},n.prototype.sum=function(){for(var t=0,n=0;n<this._metricList.length;++n)t+=this._metricList[n].value;return t},n.prototype.count=function(){return this._metricList.length},n.prototype.first=function(){return this._metricList[0]},n.prototype.latest=function(){return this._metricList[this._metricList.length-1]},n.prototype.average=function(){return this.sum()/this.count()},n.prototype.frequency=function(){var n=(this.latest().timestamp.getTime()-this.first().timestamp.getTime())*(1/6e4);return this.count()/n},n})(),h=(function(){function n(n,t){this.name=n;this.metrics=t}return n})(),e=(function(){function n(){this._sequence=0;this._store={}}return n.prototype.push=function(n,t,i){this._store.hasOwnProperty(n)||(this._store[n]=new s);this._store[n].push(new o(t,i||new Date,this._sequence++))},n.prototype.extract=function(n){var i=[],r=new RegExp(n,"i");for(var t in this._store)this._store.hasOwnProperty(t)&&r.test(t)&&i.push(new h(t,this._store[t]));return i},n.prototype.dump=function(){for(var n in this._store)this._store.hasOwnProperty(n)&&console.log("%s: %O",n,this._store[n].raw())},n})(),u=new e,f=!1;t.pushMetric=c;t.query=l;t.dump=a;t.details=v;t.enable=y;t.disable=p;t.reset=w;t.dispose=b}));__extends=this&&this.__extends||
(function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}})();
define("Core/TypeScript/TFS.Message",["require","exports","f","o","$","Core/TypeScript/TFS.Azure","Core/TypeScript/TFS.Azure.Context","Core/TypeScript/TFS.Diag","Core/TypeScript/TFS.Location.WebApi","Core/TypeScript/TFS.Stats","Core/TypeScript/TFS.Core","Core/TypeScript/TFS","Core/TypeScript/TFS.Core.Utils"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a){"use strict";function k(){return e.isPortalFeatureEnabled("VisualStudio.Services.Commerce.DisableSignalRForMonitoring")}function p(){return w||(w=new d),w}function rt(n,t,i){var u=this,r;i===void 0&&(i=y.MAXCALLBACKDELAYMS);i>0?(r={messages:[],callback:t,messageType:n,wrappedCallback:null},r.wrappedCallback=function(n,t){if(r.messages.push({tfsContext:n,message:t}),!r.delayedMethod){var f=g(1,i);r.delayedMethod=c.delay(u,f,(function(){for(var n=0,t=r.messages.length;n<t;n++)r.callback(r.messages[n].tfsContext,r.messages[n].message);r.messages=[];r.delayedMethod=null}))}},b.push(r),p().registerCallback(n,r.wrappedCallback)):p().registerCallback(n,t);h.pushMetric("message."+n+".events.registerCallback",1)}function ut(n,t){var i=p(),r=[];u.each(b,(function(u,f){if(n===f.messageType&&f.callback===t)return i.unregisterCallback(n,f.wrappedCallback),!1;r.push(f)}));b=r;i.unregisterCallback(n,t);h.pushMetric("message."+n+".events.unregisterCallback",0)}function g(n,t){return Math.floor(Math.random()*(t-n+1)+n)}function ft(){p()}function et(n){if(!k()){var t=p();c.delay(t,1,t.publishMessage,[n])}}var w,y,v,d,b,nt,tt,it;r.defineProperty(t,"__esModule",{value:!0});t.IsSignalRDisabled=k;w=null;y=(function(){function n(){}return n})();y.MINRECONNECTDELAYMS=5e3;y.MAXRECONNECTDELAYMS=6e4;y.MAXCALLBACKDELAYMS=5e3;v=(function(){function n(){}return n})();v.Commit="commit";v.Repository="repository";v.Checkin="checkin";v.BuildCompleted="buildcompleted";v.BuildStarted="buildstarted";v.BuildDeleted="builddeleted";v.BuildDefinition="builddefinition";v.BuildsQueued="buildsqueued";v.ProjectCreated="projectcreated";v.ProjectRenamed="projectrenamed";v.SourceFavoriteAdded="sourcefavoriteadded";v.SourceFavoriteRemoved="sourcefavoriteremoved";v.Shelveset="shelveset";t.MessageTypes=v;d=(function(){function n(){var n=this;this._connections={};this._callbackMap={};this._accountsToMonitor=[];k()||f.addAccountRegisteredCallback((function(t){n._monitorAccount(t)}))}return n.prototype._monitorAccount=function(n){var i=this,t=0,r=function(n){i._getConnection(n.tfsDeploymentUrl).done((function(u){u.startConnection();i._getAccountCollectionIds(n.accountId).done((function(t){for(var i=0,r=t.length;i<r;i++)u.monitorCollection(n.accountId,t[i])})).fail((function(){o.logInfo("MessageManager - _monitorAccount - failed getting collections");t=t+1;t<6&&setTimeout((function(){r(n)}),t*t*5e3)}))}))};r(n)},n.prototype._getAccountCollectionIds=function(n){var i=f.mapAccountIdToTfsContext(n,!0),r=new s.LocationHttpClient(i.getHostUrl()),t=u.Deferred();return o.logInfo("MessageManager - _monitorAccount - getting collections"),r.beginGetServiceDefinitions("LocationService2").then((function(n){for(var r,u,f=[],i=0;i<n.length;++i)r=n[i],u=r.properties["Microsoft.TeamFoundation.Location.CollectionName"],u&&u.$value==="DefaultCollection"&&f.push(r.identifier);t.resolve(f)}),(function(){t.reject()})),t.promise()},n.prototype._getConnection=function(n){var r=this,t=u.Deferred(),f=this._connections[n],o;return f?(t.resolve(f),t.promise()):(o=e.isHosted()?i.Base.Security.getAuthorizationToken():u.Deferred().resolve(null),o.then((function(i){var u=r._connections[n],f;u||(f=i?i.header:null,u=new it(n,f),u.registerCallback((function(n){r._invokeCallbacks(n)})),r._connections[n]=u);t.resolve(u)})),t.promise())},n.prototype.registerCallback=function(n,t){o.logInfo("MessageManager - registerCallback - type: "+n);var i=this._callbackMap[n];i||(i=[],this._callbackMap[n]=i);i.push(t)},n.prototype.unregisterCallback=function(n,t){o.logInfo("MessageManager - unregisterCallback - type: "+n);var i=this._callbackMap[n];i&&i.remove(t)},n.prototype.publishMessage=function(n){o.logInfo("MessageManager - publishMessage - type: "+n.messageType);h.pushMetric("messages."+n.messageType+"events.publish",0);this._invokeCallbacks(n)},n.prototype._invokeCallbacks=function(n){var i=this._callbackMap[n.messageType],t=0,r=f.mapAccountIdToTfsContext(n.accountId);if(i)for(t=0;t<i.length;t++)if(i[t])try{o.logInfo("MessageManager - messageReceived - invoking callbacks");i[t](r,n)}catch(u){o.log(o.LogVerbosity.Warning,c.StringUtils.format("An error occurred while processing message callback for type {0}.  Error:{1} ",n.messageType,l.getErrorMessage(u)))}},n})();b=[];t.registerCallback=rt;t.unregisterCallback=ut;t.initialize=ft;t.publish=et;nt=(function(){function n(){}return n.getMessagePropertyValue=function(n,t){for(var i=0;i<n.properties.length;++i)if(n.properties[i].name===t)return n.properties[i].value;return null},n})();t.Utils=nt;tt=(function(){function n(n,t){this._endpointUrl=n;this._authToken=t;this._collectionMonitorStates={};this._collectionsToMonitor=[];this._callbacks=[];this._retryCount=0}return n.prototype.getEndpointUrl=function(){return this._endpointUrl},n.prototype.getAuthToken=function(){return this._authToken},n.prototype.registerCallback=function(n){this._callbacks.push(n)},n.prototype._invokeCallbacks=function(n){for(var t=0,i=this._callbacks.length;t<i;t++)this._callbacks[t].call(this,n)},n.prototype.monitorCollection=function(n,t){this._collectionsToMonitor.push({accountId:n,collectionId:t});this.startConnection();this._startMonitoring()},n.prototype._initializeConnection=function(){},n.prototype._startConnection=function(){return u.Deferred().resolve()},n.prototype._startMonitoringCollection=function(){return u.Deferred().resolve(!0)},n.prototype._stopConnection=function(){},n.prototype.startConnection=function(){var n=this;this._connectionStarted||this._currentlyConnected||(this._connectionInitialized||(o.logInfo("MessagingConnection._initializeConnection: "+this._endpointUrl),this._initializeConnection(),this._connectionInitialized=!0),this._connectionStarted=!0,o.logInfo("MessagingConnection - _startConnection"),this._startConnection().done((function(){n._retryCount=0;n._currentlyConnected=!0;n._connectionStarted=!1;o.logInfo("MessagingConnection - hub started");n._startMonitoring();o.logInfo("MessagingConnection - hub started completed initialization")})).fail((function(){n._currentlyConnected=!1;n._connectionStarted=!1;o.logInfo("MessagingConnection - hub failed");n._collectionMonitorStates={}})),this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null))},n.prototype._onError=function(n){o.logInfo("MessagingConnection - _onError: "+n);this._handleDisconnect()},n.prototype._onDisconnect=function(){o.logInfo("MessagingConnection - _onDisconnect");this._handleDisconnect()},n.prototype._handleDisconnect=function(){var t=this,n;this._currentlyConnected=!1;this._collectionMonitorStates={};this._reconnectTimeout||this._forceKill||(this._retryCount++,n=g(y.MINRECONNECTDELAYMS,y.MAXRECONNECTDELAYMS),this._retryCount>=4&&this._retryCount<7?n=n+6e4:this._retryCount>=7&&this._retryCount<10?n=n+18e4:this._retryCount>=10&&this._retryCount<15?n=n+3e5:this._retryCount>=15&&(n=n+9e5),this._retryCount<=20&&(this._reconnectTimeout=setTimeout((function(){t.startConnection();t._startMonitoring()}),n)))},n.prototype._onReconnect=function(){o.logInfo("MessagingConnection - _onReconnect");this._currentlyConnected=!0;this._collectionMonitorStates={};this._forceKill||this._startMonitoring()},n.prototype._startMonitoring=function(){for(var n=0,n=0;n<this._collectionsToMonitor.length;n++)this._initializeCollectionMonitoring(this._collectionsToMonitor[n])},n.prototype._initializeCollectionMonitoring=function(n){var t=this;o.logInfo("MessagingConnection - _initializeAccountMonitoring");this._currentlyConnected&&(this._collectionMonitorStates[n.collectionId]||(this._collectionMonitorStates[n.collectionId]="initializing",o.logInfo("MessageManager - startMonitoring - starting monitoring for id: "+n.collectionId),this._startMonitoringCollection(n.collectionId).done((function(i){i?(t._collectionMonitorStates[n.collectionId]="monitoring",o.logInfo("MessageManager - startMonitoring - monitoring started for id: "+n.collectionId)):(o.logInfo("MessageManager - startMonitoring - force kill"),t._collectionMonitorStates[n.collectionId]=null,t._forceKill=!0,t._stopConnection())})).fail((function(){o.logInfo("MessageManager - startMonitoring - failed for id: "+n.collectionId);t._collectionMonitorStates[n.collectionId]=null}))))},n})();it=(function(n){function t(t,i){return n.call(this,t,i)||this}return __extends(t,n),t.prototype._initializeConnection=function(){var n=this.getEndpointUrl(),t;n&&n[n.length-1]==="/"||(n+="/");n+="signalr";t=u.hubConnection(n,{useDefaultPath:!1}).createHubProxies();this._notificationHub=t.realTimeNotificationHub;this._notificationHub.connection.reconnected(c.delegate(this,this._onReconnect));this._notificationHub.connection.disconnected(c.delegate(this,this._onDisconnect));this._notificationHub.connection.error(c.delegate(this,this._onError));this._notificationHub.client.messageReceived=c.delegate(this,this._invokeCallbacks)},t.prototype._startConnection=function(){var n,t,i;return this._notificationHub?(n={},t=a.getCookie("chat.transport"),t&&(n.transport=t.split(",")),i=this.getAuthToken(),i&&(this._notificationHub.connection.qs="Authorization="+i),this._notificationHub.connection.socket=null,this._notificationHub.connection.start(n)):u.Deferred().reject()},t.prototype._startMonitoringCollection=function(n){return this._notificationHub?this._notificationHub.server.startMonitor(n):u.Deferred().fail()},t.prototype._stopConnection=function(){this._notificationHub&&this._notificationHub.connection.stop()},t})(tt)}));__extends=this&&this.__extends||
(function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}})();
define("Core/TypeScript/TFS.Data.Cache",["require","exports","f","o","$","Core/TypeScript/TFS.Core.Utils","Core/TypeScript/TFS.Message","Core/TypeScript/TFS.Stats","Core/TypeScript/TFS.Core"],(function(n,t,i,r,u,f,e,o,s){"use strict";function y(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.filter((function(n){return!!n})).join("-")}function c(n){return{loader:new v({},n)}}function p(n){return new i.Data.QueryCache(c(n))}function w(n){return new i.Data.EntityCache(c(n))}function l(n){var t=n.properties||[],r={};u.each(t,(function(n,t){var i=typeof t.mergeInfo.isArray=="undefined"?!0:t.mergeInfo.isArray;r[t.name]={itemType:t.mergeInfo.typeName,isArray:i}}));i.Data.Metadata.setTypeMetadata(n.typeName,{name:n.typeName,idProperties:[n.id],properties:r});u.each(t,(function(n,t){l(t.mergeInfo)}))}function k(){for(var e,r,n,t,u=Q.defer(),f=[],i=0;i<h.length;++i)for(e=h[i],r=e.getActiveDataSets(),n=0;n<r.length;++n)t=r[n],f.push({typeName:t.typeName,dataSetName:t.dataSetName,params:t.params});return u.resolve(f),u.promise}function d(){for(var r,u,t,n,f=0,i=0;i<h.length;++i)for(r=h[i],u=r.getActiveDataSets(),t=0;t<u.length;++t)n=u[t],f+=1,r.loadDataSetForParams(n.dataSetName,n.params).then((function(t){console.log("type: %s | numObjects: %d | params: %s | setName: %s",n.typeName,t.data().length,JSON.stringify(n.params),n.dataSetName);o.query(n.dataSetName+".*fetchedcount","latest");o.query(n.dataSetName+".*fetchDataSuccess","count")}),(function(){console.error("Could not load data set: %s | type: %s | params %o",n.dataSetName,n.typeName,JSON.stringify(n.params))}));f===0&&console.log("No datasets loaded right now.")}var a;r.defineProperty(t,"__esModule",{value:!0});t.getName=y;t.createDataCacheConfig=c;t.createQueryCache=p;t.createEntityCache=w;a=(function(){function n(n,t,i){this._typename=n;this._refreshRate=t||6e4;this._evictionDelay=i||3e4}return n.prototype.createNewContext=function(){return null},n.prototype.getTypeName=function(){return this._typename},n.prototype.getDataSetName=function(){return null},n.prototype.getMergeInfo=function(){return null},n.prototype.getRefreshRate=function(){return this._refreshRate},n.prototype.getEvictionDelay=function(){var n=f.getCookieAsInt("TFS-DATA-EVICTION-DELAY");return isNaN(n)?this._evictionDelay:n},n.prototype.preserveOrdering=function(){return!1},n.prototype.preventItemRemoval=function(){return!0},n.prototype.getData=function(){return u.Deferred().reject(null).promise()},n.prototype.postProcessData=function(){},n.prototype.getMessagesToSubscribeTo=function(){return[]},n.prototype.shouldRefreshForMessage=function(){return!1},n})();t.ContextAwareLoadable=a;var b=(function(){function n(n,t){this.params=n;this.context=t}return n})(),h=[],v=(function(n){function t(t,i){var r=n.call(this,t)||this,u;return o.pushMetric("cachedataset.cacheloader."+i.getTypeName()+".events.create",1),r._loadable=i,u=i.getMergeInfo(),u&&l(u),r._dataSetNameToParamsAndContext={},r._configureRefresh(i),h.push(r),r}return __extends(t,n),t.prototype.serializeParams=function(n){return this._loadable.getDataSetName(n)},t.prototype.loadDataSetForParams=function(n,t){var r=this,f;return this._dataSetNameToParamsAndContext[n]=new b(t,this._loadable.createNewContext()),o.pushMetric("cachedataset.name."+n+".forParams."+this.serializeParams(t),-1),f={uri:"dummy-to-make-forceRefresh-work-correctly",dataSetName:n,type:this._loadable.getTypeName(),pollFrequency:i.Data.PollFrequency.Never,preserveNewItemsOrdering:this._loadable.preserveOrdering(),preventItemRemoval:this._loadable.preventItemRemoval(),loaderOptions:{fetchData:function(){var t=u.Deferred();return r._loadable.getData(r._dataSetNameToParamsAndContext[n].params,r._dataSetNameToParamsAndContext[n].context).done((function(i){o.pushMetric("cachedataset."+n+".events.fetchDataSuccess",1);o.pushMetric("cachedataset."+n+".fetchedcount",i.length);t.resolve(i)})).fail((function(){o.pushMetric("cachedataset."+n+".events.fetchDataFail",1);t.resolve([])})),t.promise()},processResult:[function(t,i){return r._loadable.postProcessData(i.data,r._dataSetNameToParamsAndContext[n].params,r._dataSetNameToParamsAndContext[n].context),!0}]}},this.loadDataSet(n,f)},t.prototype.loadDataSet=function(t,i){return o.pushMetric("cachedataset."+t+".events.loadDataSet",1),n.prototype.loadDataSet.call(this,t,i)},t.prototype.refreshDataSet=function(t){return o.pushMetric("cachedataset."+t.dataSetName+".events.refreshDataSet",2),n.prototype.refreshDataSet.call(this,t)},t.prototype.disposeDataSet=function(t){return o.pushMetric("cachedataset."+t.dataSetName+".events.disposeDataSet",0),delete this._dataSetNameToParamsAndContext[t.dataSetName],n.prototype.disposeDataSet.call(this,t)},t.prototype._configureRefresh=function(n){var i=n.getMessagesToSubscribeTo(),t;if(i.length)for(this._refreshDelegate=s.delegate(this,this._onSubscribedMessage),t=0;t<i.length;++t)e.registerCallback(i[t],this._refreshDelegate)},t.prototype._onSubscribedMessage=function(n,t){for(var i in this._dataSetNameToParamsAndContext)this._dataSetNameToParamsAndContext.hasOwnProperty(i)&&this._loadable.shouldRefreshForMessage(n,t,this._dataSetNameToParamsAndContext[i].params,this._dataSetNameToParamsAndContext[i].context)&&this.refreshDataSet({dataSetName:i,then:null})},t.prototype.getActiveDataSets=function(){var t=[];for(var n in this._dataSetNameToParamsAndContext)this._dataSetNameToParamsAndContext.hasOwnProperty(n)&&n&&t.push({dataSetName:n,params:this._dataSetNameToParamsAndContext[n].params,context:this._dataSetNameToParamsAndContext[n].context,typeName:this._loadable.getTypeName()});return t},t})(i.Data.DataCacheLoader);t.CacheLoader=v;t.testDump=k;t.dump=d}))