define("MsPortalImpl/UI/Compositions/UI.Composition.Util",["require","exports","MsPortalImpl/Extension/Extension.Definition.Locator"],(function(n,t,i){"use strict";var r;return (function(n){function t(n){var t=n.locator;return t&&(t.type===i.LocatorType.Blade||t.type===i.LocatorType.PartInstance||t.type===i.LocatorType.StartboardPartInstance)?n.getAssetId():Q.reject()}n.getCompositionAssetId=t})(r||(r={})),r}));
define("MsPortalImpl/UI/UI.Desktop.Actions",["require","exports","f","i","$","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Hubs/UI.NotificationManager","MsPortalImpl/Services/Services.AssetTypes","MsPortalImpl/UI/Compositions/UI.Composition.PartSize","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.StartboardPart","MsPortalImpl/UI/Compositions/UI.Composition.Util","MsPortalImpl/Parts/Parts"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";var y;return (function(t){function st(n,t){var u=t.desktop;if(u.startBoard.notFound())return w(k.errorTitle,d.failToPinBlade,p.Error),Q();var e=n.locator,s=n.defaultMenuItemId,r=e.getExtensionLocator(),i=new f.DefinitionFinderImpl(t.extensionManager),h=ft(i,t),o;return o=n.onPin?Q(n.onPin()).then((function(n){return rt(i,n,r.name)})):i.locateAsync(e).then((function(t){var i=r.withPartType(t.pinnedPart),u=(t.inputs||[]).concat(t.optionalInputs||[]),f=u.reduce((function(t,i){return t[i]=c.getModelValue(n.model,i).value,t}),{});return{locator:i,model:f}})),o.then((function(t){var o=t.model,e=t.locator;return Q(i.locateAsync(e)).then((function(){var a,b,v,p,c;e.type===f.LocatorType.PartType&&(b=nt.forPartTypeRedirect(r.name,e.name),v={},i.tryLocate(b,v)&&(p=v.value,e=r.withPartType(p.toPart),a=p.bindings));c=l.create(h,e,o,{filters:t.filters});a&&(c.getInstanceBindings=function(){return a});var w=t.initialSize,k=t.initialHeight,d=t.initialWidth;y.InternalPartSize[w]&&(c.initialSize=w,w===99&&(c.initialHeight=k,c.initialWidth=d));u.pinPartComposition(c);c.defaultMenuItemId=s;c.deepLink=n.deepLink;g(n.bladeTitle)}))}))}function ht(n,t){var r=t.desktop;if(r.startBoard.notFound())return w(k.errorTitle,d.failToPinPart,p.Error),u.Deferred().resolve().promise();var s=new f.DefinitionFinderImpl(t.extensionManager),c=ft(s,t),e=i.Helpers.Deferred(),o=ut(n.extension.name,n.partDefinition),a=n.cloneAs((function(t,i){return l.create(c,n.locator,t,{overridesModel:i,filters:n.filters})}),!0);return a.done((function(t){if(h.isVariableSize(t.initialSize)&&o&&o.length>0){var i=o.first((function(n){return h.isFixedSize(n)}));i!==null&&i>=0?(t.initialSize=i,t.widgetState().NormalState.size=i):e.rejectWith(r)}r.pinPartComposition(t);g(n.getTitle());e.resolveWith(r,[t])})).fail((function(){tt.error("Pin Part to Startboard Failed: The target part could not pinned. Part: {0}".format(n.toString()))})),e.promise()}function ct(n,t,i,r,u){if(i.length<1)return Q();if(n.startBoard.notFound())return w(k.errorTitle,d.failToPinPart,p.Error),Q();var f=i.map((function(i){return rt(t,i,r).then((function(t){return n.addPartToStartBoard({model:t.model,originPartLocator:t.locator,initialSize:t.initialSize,initialHeight:t.initialHeight,initialWidth:t.initialWidth,filters:t.filters})}))}));return Q.allSettled(f).then((function(){(typeof u=="undefined"||u)&&g()}))}function it(n){var t={location:n.locator?n.locator.toString():"ROOT",assetId:"no asset ID"},i=Q.defer();return a.getCompositionAssetId(n).then((function(n){t.assetId=n}),(function(){})).then((function(){if(n.children&&n.children.length){var r=[];t.children=[];n.children.forEach((function(n,i){r.push(it(n).then((function(n){t.children[i]=n})))}));Q.all(r).then((function(){i.resolve(t)}))}else i.resolve(t)})),i.promise}function lt(n,t,i,r,u){var o=n.getActiveJourney(),h=n.startBoard,f,c,e,l;return f=h?h.getComposedParts().filter((function(n){return b.isEqualDescriptor(t,n.extension)})):[],e=o&&o.blades,e&&(f=f.concat(e.mapMany((function(n){var i=[];return n.extension&&b.isEqualDescriptor(n.extension,t)&&i.push(n),i.concat(n.getComposedParts().filter((function(){return b.isEqualDescriptor(n.extension,t)})))}))),c=e.some((function(t){return!n.canCloseBlade(t.id)}))),l=f.map((function(n){return n.getAssetInstanceMetadataAsync().done((function(t){if(t&&t.type===i&&s.compareAssetId(t.id,r)){var f=c||n.dirtyAndNotSaving;n.disableForAssetDeleted(!f,u)}}))})),Q.allSettled(l)}function rt(n,t,i){var h=t.partName,c=t.parameters,u=t.options,l=u.extensionName,a=u.filters,r=u.initialSize,f=u.initialHeight,e=u.initialWidth,s=l||i,v=nt.forExtension(s),o=v.withPartType(h);return n.locateAsync(o).then((function(n){if(y.InternalPartSize[r]){var t=y.InternalPartSize[n.initialSize]?n.initialSize:2,u=ut(s,n)||[];t!==r&&u.indexOf(r)===-1&&(tt.error("Extension {0} attempted to pin using an unsupported size of part with locator '{1}'. Requested size was '{2}'. Pinned with size '{3}'.".format(i,o.toString(),y.InternalPartSize[r],y.InternalPartSize[t])),r=t,r===99?(f=f||n.initialHeight,e=e||n.initialWidth):f=e=undefined)}return{model:c,locator:o,initialSize:r,initialHeight:f,initialWidth:e,filters:a}}))}function ut(n,t){if(typeof t.partKind=="number"){var i=v.getPartFactory(n,t,{});return i.supportedSizes}}function ft(n,t){return i.extend2(t,{finder:n,sharedSettings:t.settings})}function w(n,t,i){var r=o.getNotificationManager();r&&(r.removeNotification(t),r.addClientNotification({title:n,description:t,status:i,timestamp:new Date,correlationIds:[t],uri:"#"}))}function g(n){var t=n?e.Shell.pinnedToStartBoardWithTitle.format(n):e.Shell.pinnedToStartBoard;w(t,t,p.Information)}var nt=f.Locator,b=r.Extension,et=i.Base,ot=et.Diagnostics,p=i.Hubs.Notifications.NotificationStatus,y=i.Parts,tt=ot.createLog(n),k=e.Dashboard.Notification,d=e.Dashboard.NotFound;t.pinBladeToStartboard=st;t.pinPartToStartboard=ht;t.pinMultipleParts=ct;t.dumpCompositionAssets=it;t.handleAssetDeleted=lt})(y||(y={})),y}))