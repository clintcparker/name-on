define("ReleaseManagement/TypeScript/Utilities/ArmUtils",["require","exports","f","o","Core/TypeScript/TFS.Azure","Core/TypeScript/TFS.Core","ReleaseManagement/TypeScript/Utilities/Utils","ReleaseManagement/TypeScript/Utilities/LogHelper"],(function(n,t,i,r,u,f,e,o){"use strict";r.defineProperty(t,"__esModule",{value:!0});var s=(function(){function n(){}return n.beginGetContinuousDeploymentMetadata=function(n){var r=this,i=Q.defer(),t={};return n.appServiceArmManager.fetchAppServiceResourceData().then((function(){var u=r.getAppServiceBaseUri(n.appServiceArmManager.appServiceResourceData().id,n.appServiceArmManager.appServiceResourceData().isSlot);n.appServiceArmManager.beginGetAppServiceMetaData().then((function(n){var o="";e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_ProdAppName)||(o=n.properties.VSTSRM_ProdAppName,t.prodAppDetails=r.getAppServiceNameDetails(o),t.prodAppUri=r.getAppServiceUri(u,t.prodAppDetails));e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_SlotName)||(t.slotAppName=n.properties.VSTSRM_SlotName,t.slotAppUri=f.StringUtils.format("{0}/{1}/slots/{2}",u,t.prodAppDetails.appServiceBaseName,t.slotAppName));e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_TestAppName)||(t.testAppName=n.properties.VSTSRM_TestAppName,t.testAppUri=f.StringUtils.format("{0}/{1}",u,t.testAppName));e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_AccountId)||(t.vstsAccountId=n.properties.VSTSRM_AccountId);e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_ProjectId)||(t.vstsProjectId=n.properties.VSTSRM_ProjectId);e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_BuildDefinitionId)||(t.vstsBuildDefinitionId=n.properties.VSTSRM_BuildDefinitionId);e.StringHelper.isNullOrEmpty(n.properties.VSTSRM_ConfiguredCDEndPoint)||(t.vstsConfiguredCDEndpoint=n.properties.VSTSRM_ConfiguredCDEndPoint);i.resolve(t)}),(function(n){o.LogHelper.LogError("beginGetContinuousDeploymentMetadata: Failed to get App Service metadata. Error : "+n);i.reject(n)}))}),(function(n){o.LogHelper.LogError("beginGetContinuousDeploymentMetadata: Failed to fetchAppServiceResourceData. Error: "+n);i.reject(n)})),i.promise},n.getAppServiceBaseUri=function(n,t){return t?e.ResourceUriHelper.truncateUriFromEnd(n,3):e.ResourceUriHelper.truncateUriFromEnd(n,1)},n.getAppServiceUri=function(n,t){return e.StringHelper.isNullOrEmpty(t.appServiceSlotName)?f.StringUtils.format("{0}/{1}",n,t.appServiceBaseName):f.StringUtils.format("{0}/{1}/slots/{2}",n,t.appServiceBaseName,t.appServiceSlotName)},n.beginGetCDEnabled=function(n){var t=Q.defer();return n.appServiceArmManager.beginGetAppServiceSiteConfig().then((function(n){!n||!n.properties||f.StringUtils.ignoreCaseComparer(n.properties.scmType,"VSTSRM")!==0||t.resolve(!0)}),(function(n){o.LogHelper.LogError("beginGetCDEnabled: Failed to getAppServiceSiteConfig. Error : "+n);t.resolve(!1)})),t.promise},n.beginGetScmType=function(n,t){var i=Q.defer();return n.appServiceArmManager.beginGetAppServiceSiteConfig(t).then((function(n){n&&n.properties&&n.properties.scmType?i.resolve(n.properties.scmType):i.resolve("")}),(function(n){o.LogHelper.LogError("beginGetScmType: Failed to getAppServiceSiteConfig. Error : "+n);i.reject(n)})),i.promise},n.beginGetGitHubToken=function(){var n=Q.defer();return u.ready().then((function(){var t=u.getCsmUrl(),r;t===""&&(t="https://management.azure.com/");r=t+"/providers/Microsoft.Web/sourcecontrols/GitHub?api-version=2015-08-01";i.Base.Net.ajax({uri:r,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).done((function(t){var i=t&&t.properties&&t.properties.token?t.properties.token:null;n.resolve(i)})).fail((function(){o.LogHelper.LogError("beginGetGitHubToken : Failed to fetch the GitHub access token");n.reject({valid:!1,message:"Failed to fetch the GitHub access token"})}))})),n.promise},n.getAppServiceNameDetails=function(n){return n.indexOf("/")!==-1?{appServiceName:n.replace("/","-"),appServiceBaseName:n.substr(0,n.indexOf("/")),appServiceSlotName:n.substr(n.indexOf("/")+1)}:{appServiceName:n,appServiceBaseName:n,appServiceSlotName:""}},n})();t.AppServiceArmApiUtilities=s}))