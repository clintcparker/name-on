define("MsPortalImpl/Controls/Helpers/Validators",["require","exports","f","ko","MsPortalImpl.Controls/Fields/Base/FormValidation","MsPortalImpl/Controls/Helpers/Validation","Viva.Controls/Controls/Base/ValidationPlacements/Viva.Css","Viva.Controls/Controls/Base/ValidationPlacements/Viva.DockedBalloon","Viva.Controls/Controls/Base/Viva.Validators"],(function(n,t,i,r,u,f,e,o,s){"use strict";var h;return (function(n){var h=r.observable,t=r.observableArray,c=(function(){function n(n,i,f,e){var o=this,s;this._validationInitialized=!1;this._doNotTriggerValidStyleChange=!1;this._lastValidated=undefined;this._pendingCount=0;this._pendingResults=[];this._widget=i;this._element=this._widget.element;this._noValidationBalloon=e;this._validationElement=f||this._element;this._viewModel=i.options||i.vm;this.ltm=n;this.validationPlacements=t();this.internalValidators=t();this.validationResults=this._viewModel.validationResults||r.observableArray();this._validatable={validators:t(),enableValidation:this._viewModel.enableValidation,valid:this._viewModel.valid,validationState:h(0)};this.validationState=this._validatable.validationState;s=r.unwrap(this._viewModel.validations);s&&s.length>0&&(r.unwrap(this._viewModel.validations).forEach((function(n){o._addValidation(n)})),this._intializeValidation());r.isObservable(this._viewModel.validations)&&this._subscribeValidationChanges(this._viewModel.validations);this._subscribeValidationChanges(this.internalValidators);this.valid=this._viewModel.valid;this._viewModel._msPortalFxTriggerValidation((function(){return o.triggerValidation()}));this._viewModel._msPortalFxClearValidation((function(){return o._clearValidation(!0),Q()}));u.markFormFieldElement(this._element[0],this._viewModel,this._validatable,this)}return n.prototype.triggerValidation=function(){var n=this,r=[],u=this._viewModel.value(),t;if(this._shouldValidate())t=this._validate(),this._pendingResults=[],this._pendingCount=0,this._validatable.validators().forEach((function(t){t.validationState()===3&&r.push(Q.promise((function(i){n._pendingCount++;t.validationState.fxAwaitAndRun(n.ltm,(function(n){return n!==3})).then((function(t){n._pendingCount--;var r=t===2;i(Q(r));n._pendingResults.push(r);n._setValidViaPendingStates()}))})))})),this._viewModel.valid()!==t?this._setValid(t):this._setValidState(t),r.push(Q(t));else return Q(!0);return this._lastValidated=u,Q.all(r).then((function(n){return n.every(i.identity)}))},n.prototype._subscribeValidationChanges=function(n){var t=this;n.subscribeArrayEdits(this.ltm,(function(n){var i=[];t._clearValidation();n.forEach((function(n){n.status==="added"?t._addValidation(n.value):n.status==="deleted"&&i.push(n.value)}));i.length>0&&t._removeValidations(i);t._validationInitialized?t.triggerValidation():t._intializeValidation()}))},n.prototype._intializeValidation=function(){var n=this,t,i;this._validationInitialized=!0;t=this.ltm;i=function(){n.triggerValidation()};this._viewModel.value.subscribe(t,i);this._viewModel.dirty.subscribe(t,(function(t){t&&n._lastValidated!==n._viewModel.value()&&i()}));this._viewModel.validate.subscribe(t,i);this._viewModel.ensureValidation.subscribe(t,i);this._initializeValidationPlacements();this._viewModel.valid.subscribe(t,(function(t){n._doNotTriggerValidStyleChange||n._setValidState(t)}));this._viewModel.enableValidation.subscribe(t,(function(t){n._validatable.validationState(0);t&&n._viewModel.dirty()?i():n._clearValidation(!0)}));this._widget.$disabled.subscribe(t,(function(t){t&&n._clearValidation()}));this._viewModel.dirty()&&i();r.reactor(this.ltm,(function(){n.validationResults(s.getValidationResults(n._validatable.validators))}))},n.prototype._initializeValidationPlacements=function(){var i=this,n=this.ltm,t=this.validationPlacements.removeAll();t.push(new e.Css(n));this._noValidationBalloon||t.push(new o.DockedBalloon(n,o.DockedBalloon.defaultOptions));this.validationPlacements.subscribeArrayChanges(n,(function(n){n.initialize(i._validationElement,i._validatable)}),(function(n){n.dispose()}));this.validationPlacements(t)},n.prototype._validate=function(n){var r=this,u=this._validatable.validators(),i=this._viewModel.value(),t=!0,f;return n&&i!==undefined&&!this._viewModel.showValidationMessagesBelowControl&&(f=u.some((function(n){return n.valid()})),f!==this._viewModel.valid()&&this._setValidState()),this._shouldValidate()&&u.forEach((function(n){var f=n&&n.fxViewModel&&n.fxViewModel.map,u,e=function(i){return i!==n.validate()?n.validate(i):i===undefined&&i===n.validate()||n.type===21?n.validate.notifySubscribers(i):u!==undefined&&n.validationState(u),n.validationState()===1&&(t=!1,!r._viewModel.showValidationMessagesBelowControl)?t:void 0};f?n.validationState.fxOnceAndRun(r.ltm,(function(t){u=t;n.validationState(3);Q(f(i)).then(e).catch((function(){return n.validationState()===3&&n.validationState(u)}))}),(function(n){return n!==3})):e(i)})),t!==this._viewModel.valid()&&this._setValidState(),t},n.prototype._setValid=function(n){this._widget.$disabled()?this._clearValidation():this._viewModel.valid(n)},n.prototype._setValidState=function(n,t){if(this._widget.$disabled())this._validatable.validationState(0);else{var i=n||this._viewModel.valid(),r=this._validatable.validators().some((function(n){return n.validationState()===1}));(this._pendingCount>0||t)&&!r?(this._setValidWithoutTriggeringStyleUpdate(!1),this._validatable.validationState(3)):i?this._validatable.validationState(2):this._validatable.validationState(1)}},n.prototype._setValidViaPendingStates=function(){var n=!0,t=!1,i;n=this._pendingResults.every((function(n){return n}));n&&this._validatable.validators().every((function(i){var r=i.validationState();return(r===1||r===3)&&(n=!1,r===3&&(t=!0)),n&&!t}));i=this._viewModel.valid();n===i?this._setValidState(n,t):this._setValid(n)},n.prototype._setValidWithoutTriggeringStyleUpdate=function(n){this._doNotTriggerValidStyleChange=!0;this._setValid(n);this._doNotTriggerValidStyleChange=!1},n.prototype._addValidation=function(n){var t=f.convertValidation(this.ltm,n);t&&this._validatable.validators.push(t)},n.prototype._removeValidations=function(n){f.removeValidations(this._validatable,n)},n.prototype._clearValidation=function(n){n&&this.internalValidators([]);this._validatable.validators().forEach((function(n){n.type&&(n.type!==21&&n.validate(undefined),n.validationState(0))}));this._validatable.validationState(0);n&&this._setValidWithoutTriggeringStyleUpdate(!0);this._viewModel.valid(!0)},n.prototype._shouldValidate=function(){var n=r.unwrap(this._viewModel.validations),t=r.unwrap(this._viewModel.visible);return this._viewModel.enableValidation()&&!this._widget.$disabled()&&t&&n&&n.length>0?!0:this.internalValidators().length>0?!0:!1},n})();n.Validators=c})(h||(h={})),h}))