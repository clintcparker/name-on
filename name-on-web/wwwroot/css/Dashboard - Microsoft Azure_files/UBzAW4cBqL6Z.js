var __extends;
define("ReleaseManagement/TypeScript/Models/VSTSModels",["require","exports","o"],(function(n,t,i){"use strict";var r,u,f,e;i.defineProperty(t,"__esModule",{value:!0}),(function(n){n[n.None=0]="None";n[n.Capabilities=2]="Capabilities";n[n.AssignedRequest=4]="AssignedRequest";n[n.LastCompletedRequest=8]="LastCompletedRequest"})(r=t.DeploymentTargetExpands||(t.DeploymentTargetExpands={})),(function(n){n[n.Offline=1]="Offline";n[n.Online=2]="Online";n[n.All=3]="All"})(u=t.TaskAgentStatusFilter||(t.TaskAgentStatusFilter={})),(function(n){n[n.Failed=1]="Failed";n[n.Passed=2]="Passed";n[n.NeverDeployed=4]="NeverDeployed";n[n.All=7]="All"})(f=t.TaskAgentJobResultFilter||(t.TaskAgentJobResultFilter={})),(function(n){n[n.Succeeded=0]="Succeeded";n[n.SucceededWithIssues=1]="SucceededWithIssues";n[n.Failed=2]="Failed";n[n.Canceled=3]="Canceled";n[n.Skipped=4]="Skipped";n[n.Abandoned=5]="Abandoned"})(e=t.TaskResult||(t.TaskResult={}))}));__extends=this&&this.__extends||
(function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}})();
define("ReleaseManagement/TypeScript/Service/TaskAgentHttpClient",["require","exports","o","Core/TypeScript/TFS.WebApi"],(function(n,t,i,r){"use strict";i.defineProperty(t,"__esModule",{value:!0});var u=(function(n){function t(t){return n.call(this,t,!0)||this}return __extends(t,n),t.prototype.createDeploymentGroup=function(n,t){var i={name:t};return this.beginRequestQ({httpMethod:"POST",data:i,area:"distributedtask",locationId:"083c4d89-ab35-45af-aa11-7cf66895c53e",responseType:{fields:null},responseIsCollection:!0,routeValues:{project:n},queryParams:{apiVersion:"4.1-preview.1"}})},t.prototype.getDeploymentGroups=function(n,t){var i={name:t,apiVersion:"4.1-preview.1"};return this.beginRequestQ({httpMethod:"GET",area:"distributedtask",locationId:"083c4d89-ab35-45af-aa11-7cf66895c53e",responseType:{fields:null},responseIsCollection:!0,routeValues:{project:n},queryParams:i})},t.prototype.getDeploymentTargetsWithContinuationToken=function(n,t,i,r,u,f,e,o,s,h){var l=Q.defer(),c={name:i,apiVersion:"4.1-preview.1",tags:r&&r.join(","),partialNameMatch:u,$expand:f,agentStatus:e,agentJobResult:o,continuationToken:s,$top:h};return this.beginRequest2Q({httpMethod:"GET",area:"distributedtask",locationId:"2f0aa599-c121-4256-a5fd-ba370e0ae7b6",responseType:{fields:null},responseIsCollection:!0,routeValues:{project:n,deploymentGroupId:t},queryParams:c}).then((function(n){return{deploymentTargets:n.resolvedData,continuationToken:n.jqXHR.getResponseHeader("x-ms-continuationtoken")}}))},t.prototype.getAgentRequestsForDeploymentMachine=function(n,t,i){var r={machineId:i,apiVersion:"4.1-preview.1"};return this.beginRequestQ({httpMethod:"GET",area:"distributedtask",locationId:"a3540e5b-f0dc-4668-963b-b752459be545",responseType:{fields:null},responseIsCollection:!0,routeValues:{project:n,deploymentGroupId:t},queryParams:r})},t.prototype.getAgentRequestsForDeploymentTarget=function(n,t,i){var r={targetId:i,apiVersion:"4.1-preview.1"};return this.beginRequestQ({httpMethod:"GET",area:"distributedtask",locationId:"2fac0be3-8c8f-4473-ab93-c1389b08a2c9",responseType:{fields:null},responseIsCollection:!0,routeValues:{project:n,deploymentGroupId:t},queryParams:r})},t.prototype.deleteDeploymentTarget=function(n,t,i){return this.beginRequestQ({httpMethod:"DELETE",area:"distributedtask",locationId:"2f0aa599-c121-4256-a5fd-ba370e0ae7b6",responseType:{fields:null},routeValues:{project:n,deploymentGroupId:t,targetId:i},queryParams:{apiVersion:"4.1-preview.1"}})},t})(r.VssHttpClient);t.TaskAgentHttpClient=u}));
define("ReleaseManagement/TypeScript/Utilities/DeploymentGroupWebApiManager",["require","exports","o","Core/TypeScript/TFS.Azure","Core/TypeScript/TFS.WebApi","ReleaseManagement/TypeScript/Service/TaskAgentHttpClient","ReleaseManagement/TypeScript/Resources/ReleaseManagementResources","ReleaseManagement/TypeScript/Utilities/ReleaseManagementUtils","ReleaseManagement/TypeScript/Models/VSTSModels"],(function(n,t,i,r,u,f,e,o,s){"use strict";i.defineProperty(t,"__esModule",{value:!0});var h=(function(){function n(){this._defaultDeploymentTargetsCount=1e3}return n.prototype.beginGetDeploymentGroupMachineJobs=function(n,t,i,u){var l=this,s=Q.defer(),v=r.getAccountId(n),a=r.getAccountMapping(v),h,c;return a?(h={account:n,teamProject:t,deploymentGroup:null,deploymentMachine:null,jobs:null},c=new f.TaskAgentHttpClient(a.tfsAccountUrl),this.beginGetDeploymentGroups(n,t,i).then((function(r){if(r&&r.length===1){var f=r[0].id;return h.deploymentGroup=r[0],[l.getDeploymentTargets(n,t,f,u),f]}s.reject(e.vmCDFetchDeploymentGroupFailed.format(i))})).spread((function(n,i){if(n&&n.length===1){var r=n[0].id;return(h.deploymentMachine=n[0],!o.ReleaseManagementUtils.isFeatureEnabled("VisualStudio.Services.PortalExtension.DeprecateDeploymentMachineJobRequestsGetCall"))?c.getAgentRequestsForDeploymentMachine(t,i,r):c.getAgentRequestsForDeploymentTarget(t,i,r)}s.reject(e.vmCDFetchDeploymentMachineJobsFailed.format(u))})).then((function(n){h.jobs=n;s.resolve(h)})).catch((function(n){s.reject(l._toErrorMessage(n))}))):s.reject(e.vmCDFetchAccountFailed.format(n)),s.promise},n.prototype.getDeploymentTargets=function(n,t,i,r,u){var f=Q.defer();return this._getDeploymentTargetsRecursively(n,t,i,r,u,null,[]).then((function(n){f.resolve(n)}),(function(n){f.reject(n)})),f.promise},n.prototype._getDeploymentTargetsRecursively=function(n,t,i,u,o,h,c){var y=this,l=Q.defer(),p=r.getAccountId(n),a=r.getAccountMapping(p),v;return a?(v=new f.TaskAgentHttpClient(a.tfsAccountUrl),v.getDeploymentTargetsWithContinuationToken(t,i,u,o,!1,s.DeploymentTargetExpands.Capabilities,s.TaskAgentStatusFilter.All,s.TaskAgentJobResultFilter.All,h,this._defaultDeploymentTargetsCount).then((function(r){if(r.continuationToken){var f=y._getDeploymentTargetsRecursively(n,t,i,u,o,h,c.concat(r.deploymentTargets));f.then((function(n){return l.resolve(n)}),(function(n){return l.reject(n)}))}else return l.resolve(c.concat(r.deploymentTargets))}),(function(n){return l.reject(n)}))):l.reject(e.vmCDFetchAccountFailed.format(n)),l.promise},n.prototype.beginGetDeploymentGroups=function(n,t,i){var h=this,u=Q.defer(),c=r.getAccountId(n),o=r.getAccountMapping(c),s;return o?(s=new f.TaskAgentHttpClient(o.tfsAccountUrl),s.getDeploymentGroups(t,i).then((function(n){if(!n||!!i&&n.length!==1)return u.reject(e.vmCDFetchDeploymentGroupFailed.format(i));u.resolve(n)})).catch((function(n){u.reject(h._toErrorMessage(n))}))):u.reject(e.vmCDFetchAccountFailed.format(n)),u.promise},n.prototype.beginCreateDeploymentGroup=function(n,t,i){var h=this,u=Q.defer(),c=r.getAccountId(n),o=r.getAccountMapping(c),s;return o?(s=new f.TaskAgentHttpClient(o.tfsAccountUrl),s.createDeploymentGroup(t,i).then((function(n){u.resolve(n)})).catch((function(n){var r=e.createDeploymentGroupFailed.format(i,t,h._toErrorMessage(n));u.reject(r)}))):u.reject(e.vmCDFetchAccountFailed.format(n)),u.promise},n.prototype.deleteDeploymentGroupMachine=function(n,t,i,u){var c=this,o=Q.defer(),l=r.getAccountId(n),s=r.getAccountMapping(l),h;return s?(h=new f.TaskAgentHttpClient(s.tfsAccountUrl),h.deleteDeploymentTarget(t,i,u).then((function(){o.resolve()})).catch((function(n){o.reject(c._toErrorMessage(n))}))):o.reject(e.vmCDFetchAccountFailed.format(n)),o.promise},n.prototype.beginGetPatTokenToManageDeploymentGroup=function(n){var s=this,t=Q.defer(),h=r.getAccountId(n),f=r.getAccountMapping(h);if(f){var c=f.accountId,i=new Date,l="AzureVMCDExtensionToken "+i.toUTCString();i.setDate(i.getDate()+90);var a={scope:"vso.machinegroup_manage",targetAccounts:[c],displayName:l,validTo:i.toUTCString()},v=o.ReleaseManagementUtils.getSpsLocation(),y=new u.VssHttpClient(v,!0);y.beginRequestQ({area:"Token",locationId:"ADA996BC-8C18-4193-B20C-CD41B13F5B4D",httpMethod:"POST",httpResponseType:"JSON",data:a,responseType:{fields:null},queryParams:{tokentype:"compact",apiVersion:"4.1-preview.1"}}).then((function(n){return t.resolve(n.token)}),(function(i){var r=e.createPATFailed.format(n,s._toErrorMessage(i));return t.reject(r)}))}else t.reject(e.vmCDFetchAccountFailed.format(n));return t.promise},n.prototype._toErrorMessage=function(n){return n?!!n&&!!n.message?n.message:n.toString():""},n})();t.DeploymentGroupWebApiManager=h}));
define("ReleaseManagement/TypeScript/Utilities/NotificationsHelper",["require","exports","f","o","ReleaseManagement/TypeScript/Resources/ReleaseManagementResources"],(function(n,t,i,r,u){"use strict";r.defineProperty(t,"__esModule",{value:!0});var f=(function(){function n(){this._refreshTime=5e3}return n.prototype.publishInProgressNotification=function(n,t){this._notification=i.Hubs.Notifications.ClientNotification.publish({title:u.cDInProgressMessage,description:u.cDInProgressForAccount.format(n),status:i.Hubs.Notifications.NotificationStatus.InProgress,uri:"#resource/"+t+"/vstscd"})},n.prototype.publishDisconnectInProgressNotification=function(){this._notification=i.Hubs.Notifications.ClientNotification.publish({title:u.disconnectCIInprogressTitle,description:u.disconnectCIInprogressTitle,status:i.Hubs.Notifications.NotificationStatus.InProgress})},n.prototype.updateNotification=function(n,t,i){this._notification.title=n;this._notification.status=t;!i||(this._notification.description=i);this._notification.publish()},n.prototype.updateNotificationDescription=function(n){this._notification.description=n;this._notification.publish()},n.prototype.getNotificationStatus=function(){return!this._notification?null:this._notification.status},n})();t.NotificationsHelper=f}));__extends=this&&this.__extends||
(function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}})();
define("ReleaseManagement/TypeScript/Service/BuildHttpClient",["require","exports","o","Core/TypeScript/TFS.WebApi","Core/TypeScript/Generated/TFS.Build.Common"],(function(n,t,i,r,u){"use strict";i.defineProperty(t,"__esModule",{value:!0});var f=(function(n){function t(t){return n.call(this,t,!0)||this}return __extends(t,n),t.prototype.beginQueueBuild=function(n,t){return this._beginRequest({httpMethod:"POST",area:u.BuildResourceIds.AreaName,locationId:u.BuildResourceIds.Builds,routeValues:{project:n},data:t,httpResponseType:"JSON",responseType:{fields:null},queryParams:{"api-version":"3.1"}})},t.prototype.getBuildDefinition=function(n,t){return this._beginRequest({area:u.BuildResourceIds.AreaName,locationId:u.BuildResourceIds.Definitions,routeValues:{project:t,definitionId:n},httpMethod:"GET",httpResponseType:"JSON",responseType:{fields:null},queryParams:{"api-version":"3.1"}})},t})(r.VssHttpClient);t.BuildHttpClient=f}));
define("ReleaseManagement/TypeScript/Utilities/ReleaseManagementWebApiManager",["require","exports","o","Core/TypeScript/TFS.Azure","Core/TypeScript/TFS.Core","Build/TypeScript/TFS.Build.WebApi","Core/TypeScript/TFS.Azure.Context","ReleaseManagement/TypeScript/Service/BuildHttpClient","ReleaseManagement/TypeScript/Service/RMHttpClient","ReleaseManagement/TypeScript/Utilities/LogHelper","ReleaseManagement/TypeScript/Resources/ReleaseManagementResources","ReleaseManagement/TypeScript/Service/ContinuousDeliveryHttpClient","ReleaseManagement/TypeScript/Utilities/ReleaseManagementUtils"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a){"use strict";i.defineProperty(t,"__esModule",{value:!0});var v=(function(){function n(){}return n.prototype.beginRemoveContinuousIntegrationTrigger=function(n,t,i){var f=this,u=Q.defer();return r.awaitTfsContext({accountId:t}).then((function(){var e=r.getAccountMapping(t);e==null?(r.setFlagToRefreshAccountList(),r.refreshAccounts().then((function(){if(e=r.getAccountMapping(t),e==null){u.reject("beginRemoveContinuousIntegrationTrigger failed to find the account even after refresh for the account with Id:"+t+" builddefinitionid: "+n+" projectId:"+i);return}f._disconnectInternal(u,e,n,i)}),(function(){u.reject("beginRemoveContinuousIntegrationTrigger failed to refresh Accounts for the account with Id:"+t+" builddefinitionid: "+n+" projectId:"+i)}))):f._disconnectInternal(u,e,n,i)})),u.promise},n.prototype._disconnectInternal=function(n,t,i,r){var e=new f.BuildHttpClient(t.tfsAccountUrl);e.getBuildDefinition(i,r).then((function(f){var o=f.triggers,s;!!o&&o.length>0&&(s=o.filter((function(n){return u.StringUtils.ignoreCaseComparer(n.triggerType,"continuousIntegration")===0})),!!s&&s.length>0&&(u.ArrayUtils.remove(o,s[0]),e.updateBuildDefinition(i,f,r).then((function(){h.LogHelper.LogInfo("beginRemoveContinuousIntegrationTrigger succeeded");n.resolve()}),(function(){n.reject("beginRemoveContinuousIntegrationTrigger failed to update build definition for tfsAccountUrl: "+t.tfsAccountUrl+" builddefinitionId:"+i+" projectId:"+r)}))));n.resolve()}),(function(){n.reject("beginRemoveContinuousIntegrationTrigger failed to get build definition for tfsAccountUrl: "+t.tfsAccountUrl+" builddefinitionId:"+i+" projectId:"+r)}))},n.prototype.beginQueueBuild=function(n,t,i){var f=this,u=Q.defer();return r.awaitTfsContext({accountId:n}).then((function(){var e=r.getAccountMapping(n);e==null?(r.setFlagToRefreshAccountList(),r.refreshAccounts().then((function(){if(e=r.getAccountMapping(n),e==null){h.LogHelper.LogError("beginQueueBuild failed to find the account even after refresh for the account with Id:"+n+" builddefinitionid: "+t+" projectId:"+i);u.reject();return}f._beginQueueBuild(u,e,t,i)}),(function(){h.LogHelper.LogError("beginQueueBuild failed for the account with Id:"+n+" builddefinitionid: "+t+" projectId:"+i);u.reject()}))):f._beginQueueBuild(u,e,t,i)})),u.promise},n.prototype._beginQueueBuild=function(n,t,i,r){var u=new o.BuildHttpClient(t.tfsAccountUrl);u.getBuildDefinition(i,r).then((function(t){var f,e,o;if(t.repository&&t.repository.defaultBranch)f=t.repository.defaultBranch;else return n.reject(c.branchNotFound);e={id:i};o={definition:e,sourceBranch:f};u.beginQueueBuild(r,o).then((function(t){n.resolve(t)})).catch((function(){return n.reject()}))})).catch((function(){return n.reject()}))},n.prototype.beginCreateProvisioningConfiguration=function(n,t,i){return a.ReleaseManagementUtils.setFlagToRefreshAccountList(),a.ReleaseManagementUtils.refreshAccounts(i).then((function(){var n=!1;e.isMsaAccount(i)&&(n=!0);var u=r.getAccountId(i),f=r.getAccountMapping(u),o=new l.ContinuousDeliveryHttpClient(f.peAccountUrl);return o.createProvisioningConfiguration(t,n)}))},n.prototype.beginGetProvisioningConfiguration=function(n,t){var i=!1;e.isMsaAccount(t)&&(i=!0);var u=r.getAccountId(t),f=r.getAccountMapping(u),o=new l.ContinuousDeliveryHttpClient(f.peAccountUrl);return o.getProvisioningConfiguration(n,i)},n.prototype.getReleases=function(n,t,i){var u=r.getAccountId(n),f=r.getAccountMapping(u),e=new s.RMHttpClient(f.rmAccountUrl);return e.getReleases(t,i)},n})();t.ReleaseManagementWebApiManager=v}));
define("ReleaseManagement/TypeScript/Models/VmServicesModels",["require","exports","o"],(function(n,t,i){"use strict";var r,u;i.defineProperty(t,"__esModule",{value:!0});r=(function(){function n(){this.message=""}return n})();t.AzureError=r;u=(function(){function n(){this.content="";this.message=""}return n})();t.AzureResponse=u}));
define("ReleaseManagement/TypeScript/Utilities/VmArmApiManager",["require","exports","f","o","ko","ReleaseManagement/TypeScript/Models/VmServicesModels","Core/TypeScript/TFS.Azure","ReleaseManagement/TypeScript/Utilities/LogHelper"],(function(n,t,i,r,u,f,e,o){"use strict";r.defineProperty(t,"__esModule",{value:!0});var s=(function(){function n(){this._vmResourceData=u.observable(null);this._vmArmVersion="?api-version=2017-03-30"}return n.prototype.setVmUri=function(n){this._vmUri!==n&&(this._fetchingDataPromise=null);this._vmUri=n},n.prototype.getVmUri=function(){return this._vmUri},n.prototype.getVmData=function(){return this._vmResourceData()},n.prototype.fetchVmResourceData=function(n){var t=this,r,u,f;return this._fetchingDataPromise&&!n||(r=Q.defer(),this._fetchingDataPromise=r.promise,u=this._getCsmUrl(),f=u+this._vmUri+this._vmArmVersion,i.Base.Net2.ajax({uri:f,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){o.LogHelper.LogInfo("fetchVmResourceData, OutCome: Success, VM resource uri: {0}".format(t._vmUri));t._vmResourceData(n);r.resolve(n)}),(function(){t._vmResourceData(undefined);o.LogHelper.LogError("fetchVmResourceData, OutCome: Failure, VM resource uri: {0}".format(t._vmUri));r.resolve()}))),this._fetchingDataPromise},n.prototype.createVmExtension=function(n,t){var f=this,r=Q.defer(),e=this._getCsmUrl(),u=this._vmUri+"/extensions/{0}".format(n),s=e+u+this._vmArmVersion;return i.Base.Net2.ajaxExtended({uri:s,type:"PUT",data:t,dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){var t=f.ToResponse(n);if(t.statusCode!=200&&t.statusCode!=201)return o.LogHelper.LogInfo("putVmExtension, OutCome: {0}, VM extension uri: {1}".format(t.statusCode,u)),r.reject(t.statusCode);o.LogHelper.LogInfo("putVmExtension, OutCome: Success, VM extension uri: {0}".format(u));r.resolve(t)}),(function(n){var t=f.ToError(n);o.LogHelper.LogError("putVmExtension, OutCome: Failure, VM resource uri: {0}, Error: {1}".format(u,t.message));r.reject(t)})),r.promise},n.prototype.deleteVmExtension=function(n){var u=this,t=Q.defer(),f=this._getCsmUrl(),r=this._vmUri+"/extensions/{0}".format(n),e=f+r+this._vmArmVersion;return i.Base.Net2.ajaxExtended({uri:e,type:"DELETE",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){var i=u.ToResponse(n);if(i.statusCode!=202&&i.statusCode!=204)return o.LogHelper.LogInfo("deleteVmExtension, OutCome: {0}, VM extension uri: {1}".format(i.statusCode,r)),t.reject(i.statusCode);o.LogHelper.LogInfo("deleteVmExtension, OutCome: Success, VM extension uri: {0}".format(r));t.resolve(i)}),(function(n){var i=u.ToError(n);o.LogHelper.LogError("deleteVmExtension, OutCome: Failure, VM resource uri: {0}, Error: {1}".format(r,i.message));t.reject(i)})),t.promise},n.prototype.getOperationResult=function(n,t){var u=this,r=Q.defer();return i.Base.Net2.ajaxExtended({uri:n,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){var t=u.ToResponse(n);r.resolve(t)}),(function(n){var i=u.ToError(n);if(t)return o.LogHelper.LogWarning("getOperationResult : Failed to get operation result: "+i.message),r.resolve(i);o.LogHelper.LogError("getOperationResult : Failed to get operation result: "+i.message);r.reject(i)})),r.promise},n.prototype._getCsmUrl=function(){var n=e.getCsmUrl();return n===""&&(n="https://management.azure.com/"),n},n.prototype.ToError=function(n){var t=new f.AzureError;return n?(n.data&&(t.statusCode=n.data.status),t.message=n.message,n.jqXHR&&(n.jqXHR.responseJSON&&n.jqXHR.responseJSON.error&&n.jqXHR.responseJSON.error.message?t.message=n.jqXHR.responseJSON.error.message:n.jqXHR.responseText&&(t.message=n.jqXHR.responseText)),t):t},n.prototype.ToResponse=function(n){var t=new f.AzureResponse;return n?(n.content&&(t.content=n.content,n.content.error&&n.content.error.message&&(t.message=n.content.error.message)),n.jqXHR&&(t.statusCode=n.jqXHR.status,t.asyncOperation=n.jqXHR.getResponseHeader("Azure-AsyncOperation")||n.jqXHR.getResponseHeader("location"),t.retryAfter=parseInt(n.jqXHR.getResponseHeader("retry-after"))),t):t},n})();t.VmArmAPIManager=s}));
define("ReleaseManagement/TypeScript/Utilities/VmssArmApiManager",["require","exports","f","o","ko","Core/TypeScript/TFS.Azure","ReleaseManagement/TypeScript/Utilities/LogHelper","ReleaseManagement/TypeScript/Utilities/Utils"],(function(n,t,i,r,u,f,e,o){"use strict";r.defineProperty(t,"__esModule",{value:!0});var s=(function(){function n(){this._vmssResourceData=u.observable(null);this._vmssArmVersion="?api-version=2016-04-30-preview";this._fetchStorageAccountsUri="/subscriptions/{0}/providers/Microsoft.Storage/storageAccounts?api-version=2015-06-15";this._allStorageAccounts=u.observable()}return n.prototype.setVmssUri=function(n){this._vmssUri!==n&&(this._fetchingDataPromise=null);this._vmssUri=n},n.prototype.getVmssUri=function(){return this._vmssUri},n.prototype.getVmssData=function(){return this._vmssResourceData()},n.prototype.fetchStorageAccounts=function(){var n=this,t;return this._fetchingStorageAccountsDataPromise||(t=Q.defer(),this._fetchingStorageAccountsDataPromise=t.promise,f.ready().then((function(){var u=n._getCsmUrl(),f=o.ResourceUriHelper.getSubscriptionIdFromUri(n._vmssUri),r=u+n._fetchStorageAccountsUri.format(f);i.Base.Net2.ajax({uri:r,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(i){e.LogHelper.LogInfo("fetchStorageAccounts, OutCome: Success, Csm uri: {0}".format(r));n._allStorageAccounts(i.value);t.resolve(i.value)}),(function(){n._allStorageAccounts(undefined);e.LogHelper.LogError("fetchStorageAccounts, OutCome: Failure, Csm uri: {0}".format(r));t.resolve()}))}))),this._fetchingStorageAccountsDataPromise},n.prototype.getStorageAccountResourceGroup=function(n){for(var r,i=this._allStorageAccounts(),t=0;t<i.length;t++)if(n===i[t].name)return r=i[t].id,o.ResourceUriHelper.getResourceGroupNameFromUri(r);return""},n.prototype.fetchVmssResourceData=function(n){var t=this,r;return this._fetchingDataPromise&&!n||(r=Q.defer(),this._fetchingDataPromise=r.promise,f.ready().then((function(){var n=t._getCsmUrl(),u=n+t._vmssUri+t._vmssArmVersion;i.Base.Net2.ajax({uri:u,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){e.LogHelper.LogInfo("fetchVmssResourceData, OutCome: Success, Vmss resource uri: {0}".format(t._vmssUri));t._vmssResourceData(n);r.resolve(n)}),(function(){t._vmssResourceData(undefined);e.LogHelper.LogError("fetchVmssResourceData, OutCome: Failure, Vmss resource uri: {0}".format(t._vmssUri));r.resolve()}))}))),this._fetchingDataPromise},n.prototype.updateTags=function(n){var r=this,t=Q.defer(),u=this._getCsmUrl(),f=u+this._vmssUri+this._vmssArmVersion;return typeof n=="object"&&(n=JSON.stringify(n)),i.Base.Net2.ajax({uri:f,type:"PATCH",data:n,cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){e.LogHelper.LogInfo("Updating tags, OutCome: Success, Vmss resource uri: {0}".format(r._vmssUri));t.resolve(n)}),(function(n){e.LogHelper.LogError("Updating tags, OutCome: Failure, Vmss resource uri: {0}, error: {1}".format(r._vmssUri,JSON.stringify(n)));t.reject()})),t.promise},n.prototype.isGalleryImageVmss=function(){var n=this.getVmssData().properties.virtualMachineProfile;return!!n&&!!n.storageProfile&&!!n.storageProfile.imageReference?!0:!1},n.prototype.getVmssOsType=function(){var n=this.getVmssData().properties.virtualMachineProfile;return!!n&&!!n.storageProfile&&!!n.storageProfile.osDisk&&!!n.storageProfile.osDisk.osType?n.storageProfile.osDisk.osType:null},n.prototype._getCsmUrl=function(){var n=f.getCsmUrl();return n===""&&(n="https://management.azure.com/"),n},n})();t.VmssArmAPIManager=s}));
define("ReleaseManagement/TypeScript/Utilities/VirtualMachineExtensionManager",["require","exports","f","o","Core/TypeScript/TFS.Core","ReleaseManagement/TypeScript/Models/ContinuousIntegrationModel","ReleaseManagement/TypeScript/Utilities/LogHelper","ReleaseManagement/TypeScript/Resources/ReleaseManagementResources"],(function(n,t,i,r,u,f,e,o){"use strict";r.defineProperty(t,"__esModule",{value:!0});var s=i.Base.Diagnostics.Telemetry,h=(function(){function n(){}return n.prototype.getTeamServicesAgentExtension=function(n){var t=[],i=this.getTeamServicesAgentExtensionMetadata(n);return!n.resources||n.resources.length===0?(e.LogHelper.LogWarning("Found no installed extension of type TeamServicesAgent."),null):(t=n.resources.filter((function(n){if(u.StringUtils.ignoreCaseComparer(n.type,"Microsoft.Compute/virtualMachines/extensions")===0&&n.properties){var t=n.properties;if(!!t&&u.StringUtils.ignoreCaseComparer(t.publisher,i.publisher)===0&&u.StringUtils.ignoreCaseComparer(t.type,i.type)===0)return!0}})),!t||t.length===0)?(e.LogHelper.LogWarning("Found no installed extension of type TeamServicesAgent."),null):(t.length>1&&e.LogHelper.LogWarning("Found more than one installed extension of type TeamServicesAgent. Second one will be ignored."),t[0])},n.prototype.getTeamServicesAgentExtensionMetadata=function(n){var t=u.StringUtils.ignoreCaseComparer(this._getVMOSType(n),"Windows")===0;return t?{type:"TeamServicesAgent",publisher:"Microsoft.VisualStudio.Services",typeHandlerVersion:"1.0"}:{type:"TeamServicesAgentLinux",publisher:"Microsoft.VisualStudio.Services",typeHandlerVersion:"1.0"}},n.prototype.uninstallVmExtension=function(n,t){var i=this;return n.vmApiManager.deleteVmExtension(t).then((function(r){var u=r.asyncOperation,f;u||(f=o.vmCDRemoveExtensionErrorReason1.format(t),i.notifyUninstallFailure(n,f));n.notificationsHelper.updateNotificationDescription(o.vmCDRemovingExtension.format(t));i._startMonitoringJobForVMExtensionUninstallation(u,n,!1)})).catch((function(t){var r=!t.message?t:t.message;i.notifyUninstallFailure(n,r)}))},n.prototype.uninstallAndReinstallVmExtension=function(n,t,i,r){var u=this;return n.vmApiManager.deleteVmExtension(t).then((function(f){var s=f.asyncOperation;if(!s)return e.LogHelper.LogWarning("Either extension "+t+" is not installed on VM or has already been uninstalled."),u.installTeamServicesAgentExtension(n,i,r);n.notificationsHelper.updateNotificationDescription(o.vmCDRemovingFailedExtension.format(t));u._startMonitoringJobForVMExtensionUninstallation(s,n,!0,i,r)}))},n.prototype.installTeamServicesAgentExtension=function(n,t,i){var r=this;return this._installTeamServicesAgentExtension(n,t.VSTSAccountName,t.TeamProject,t.DeploymentGroup,t.Tags,i).then((function(t){var i=t.asyncOperation,u;i||(u=o.vmCDInstallExtensionErrorReason1,r.notifyInstallFailure(n,u));n.notificationsHelper.updateNotificationDescription(o.vmCDInstallingExtension);r._startMonitoringJobForVMExtensionInstallation(i,n)})).catch((function(t){var i=!t.message?t:t.message;r.notifyInstallFailure(n,i)}))},n.prototype.notifyUninstallFailure=function(n,t){n.continuousIntegrationBladeState(3);n.continuousIntegrationBladeStateMessage(o.vmCDdisconnectFailureMessage.format(t));n.notificationsHelper.updateNotification(o.disconnectCIFailureTitle,i.Hubs.Notifications.NotificationStatus.Error,o.disconnectVmExtensionFailure);n.notificationsHelper.updateNotificationDescription(o.vmCDRemovingExtensionFailed);n.vmCDContext.continuousDeliveryStatus(f.ContinuousDeliveryStatus.Configured);n.vmCDContext.continuousDeliveryStatus.valueHasMutated();e.LogHelper.LogError("VMContinuousDelivery: Exited Disconnect CD with failure: "+t);s.trace({source:"VMContinuousDelivery",action:"CDDisconnectFailed"})},n.prototype.notifyUninstallSuccess=function(n){n.continuousIntegrationBladeState(1);n.continuousIntegrationBladeStateMessage(o.disconnectCISuccessTitle);n.notificationsHelper.updateNotification(o.disconnectCISuccessTitle,i.Hubs.Notifications.NotificationStatus.Success,o.disconnectCISuccessTitle);n.vmCDContext.continuousDeliveryStatus(f.ContinuousDeliveryStatus.NotConfigured);e.LogHelper.LogInfo("VMContinuousDelivery: Exited Disconnect CD with success");s.trace({source:"VMContinuousDelivery",action:"CDDisconnected"})},n.prototype.notifyInstallFailure=function(n,t){n.continuousIntegrationBladeState(3);n.continuousIntegrationBladeStateMessage("{0}. Error: {1}".format(o.cDFailedNotificationMessage,t));n.notificationsHelper.updateNotification(o.cDFailedNotificationMessage,i.Hubs.Notifications.NotificationStatus.Error,o.vmCDExtensionInstallationFailed);n.vmCDContext.continuousDeliveryStatus(f.ContinuousDeliveryStatus.NotConfigured);n.vmCDContext.continuousDeliveryStatus.valueHasMutated();e.LogHelper.LogError("VMContinuousDelivery: Exited Configure CD with failure: "+t);s.trace({source:"VMContinuousDelivery",action:"CDConfigurationFailed"})},n.prototype.notifyInstallSuccess=function(n){n.continuousIntegrationBladeState(1);n.continuousIntegrationBladeStateMessage(o.cDSuccessNotificationMessage);n.notificationsHelper.updateNotification(o.cDSuccessNotificationMessage,i.Hubs.Notifications.NotificationStatus.Success,o.vmCDExtensionInstalled);n.vmCDContext.continuousDeliveryStatus(f.ContinuousDeliveryStatus.Configured);e.LogHelper.LogInfo("VMContinuousDelivery: Exited Configure CD with success");s.trace({source:"VMContinuousDelivery",action:"CDConfigured"})},n.prototype._installTeamServicesAgentExtension=function(n,t,r,u,f,e){i.isFeatureEnabled("canmodifyextensions")&&(t=!i.getFeatureValue("extAccountName")?t:i.getFeatureValue("extAccountName"),r=!i.getFeatureValue("extProject")?r:i.getFeatureValue("extProject"),u=!i.getFeatureValue("extdg")?u:i.getFeatureValue("extdg"),e=!i.getFeatureValue("extToken")?e:i.getFeatureValue("extToken"));var o=n.vmApiManager.getVmData(),s=this.getTeamServicesAgentExtensionMetadata(o),h={location:o.location,properties:{type:s.type,publisher:s.publisher,typeHandlerVersion:s.typeHandlerVersion,autoUpgradeMinorVersion:!0,settings:{VSTSAccountName:t,TeamProject:r,DeploymentGroup:u,AgentName:o.name,Tags:f},protectedSettings:{PATToken:e}},id:"",type:"",name:""},c=JSON.stringify(h);return n.vmApiManager.createVmExtension("TeamServicesAgentExtension"+Date.now().toString(),c)},n.prototype._startMonitoringJobForVMExtensionUninstallation=function(n,t,i,r,u){var f=this;t.vmApiManager.getOperationResult(n).then((function(e){var h,s,c;e.statusCode!==202&&(!e.content||!e.content.status||e.content.status!="Accepted"&&e.content.status!="Running"&&e.content.status!="InProgress")?e.content.status==="Succeeded"?i?(t.notificationsHelper.updateNotificationDescription(o.vmCDRemovedFailedExtension),f.installTeamServicesAgentExtension(t,r,u)):(s=t.vmCDContext.configuredDeploymentGroupMachine,s?t.deploymentGroupWebApiManager.deleteDeploymentGroupMachine(s.account,s.teamProject,s.deploymentGroup.id,s.deploymentMachine.id).then((function(){f.notifyUninstallSuccess(t)})).catch((function(){var n=o.deleteDeploymentTargetFailed.format(s.deploymentMachine.agent.name,s.deploymentGroup.name);f.notifyUninstallFailure(t,n)})):f.notifyUninstallSuccess(t)):(c=e.message||"",i?(t.notificationsHelper.updateNotificationDescription(o.vmCDRemovingFailedExtensionFailed),f.installTeamServicesAgentExtension(t,r,u)):f.notifyUninstallFailure(t,c)):(h=1e4,!e.retryAfter||(h=e.retryAfter),setTimeout((function(){f._startMonitoringJobForVMExtensionUninstallation(n,t,i,r,u)}),h))}),(function(){e.LogHelper.LogError("_startMonitoringJobForVMExtensionUninstallation: getOperationResult call failed")}))},n.prototype._startMonitoringJobForVMExtensionInstallation=function(n,t){var i=this;t.vmApiManager.getOperationResult(n).then((function(r){var u,f;r.statusCode!==202&&(!r.content||!r.content.status||r.content.status!="Accepted"&&r.content.status!="Running"&&r.content.status!="InProgress")?r.content.status==="Succeeded"?i.notifyInstallSuccess(t):(f=r.message||"",i.notifyInstallFailure(t,f)):(u=1e4,!r.retryAfter||(u=r.retryAfter),setTimeout((function(){i._startMonitoringJobForVMExtensionInstallation(n,t)}),u))}),(function(){e.LogHelper.LogError("_startMonitoringJobForVMExtensionInstallation: getOperationResult call failed")}))},n.prototype._getVMOSType=function(n){return!!n&&!!n.properties&&!!n.properties.storageProfile&&!!n.properties.storageProfile.osDisk&&!!n.properties.storageProfile.osDisk.osType?n.properties.storageProfile.osDisk.osType:null},n})();t.VirtualMachineExtensionManager=h}));
define("ReleaseManagement/TypeScript/ViewModels/VmContinuousIntegration/VmContinuousDeliveryContext",["require","exports","o","ko","ReleaseManagement/TypeScript/Utilities/VirtualMachineExtensionManager","ReleaseManagement/TypeScript/Models/ContinuousIntegrationModel"],(function(n,t,i,r,u,f){"use strict";i.defineProperty(t,"__esModule",{value:!0});var e=(function(){function n(){this.continuousDeliveryStatus=r.observable(f.ContinuousDeliveryStatus.Undefined);this.vmExtensionManager=new u.VirtualMachineExtensionManager}return n})();t.VmContinuousDeliveryContext=e}));
define("ReleaseManagement/ReleaseManagementArea",["require","exports","o","ko","ReleaseManagement/TypeScript/Utilities/ReleaseManagementWebApiManager","ReleaseManagement/TypeScript/Utilities/DeploymentGroupWebApiManager","ReleaseManagement/TypeScript/Utilities/ReleaseManagementUtils","ReleaseManagement/TypeScript/Utilities/NotificationsHelper","ReleaseManagement/TypeScript/Utilities/AppServiceArmApiManager","ReleaseManagement/TypeScript/Utilities/VmssArmApiManager","ReleaseManagement/TypeScript/Utilities/VmArmApiManager","ReleaseManagement/TypeScript/ViewModels/VmContinuousIntegration/VmContinuousDeliveryContext"],(function(n,t,i,r,u,f,e,o,s,h,c,l){"use strict";i.defineProperty(t,"__esModule",{value:!0});"use strict";var a=(function(){function n(){this.webApiManager=new u.ReleaseManagementWebApiManager;this.deploymentGroupWebApiManager=new f.DeploymentGroupWebApiManager;this.rmUtils=e.ReleaseManagementUtils;this.notificationsHelper=new o.NotificationsHelper;this.appServiceArmManager=new s.AppServiceArmApiManager;this.vmssApiManager=new h.VmssArmAPIManager;this.vmApiManager=new c.VmArmAPIManager;this.refreshList=r.observable(!1);this.isContinuousDeploymentConfigured=r.observable(!1);this.vmssCDStatus=r.observable(null);this.chooseSourceBladeState=r.observable();this.chooseSourceBladeStateMessage=r.observable();this.continuousIntegrationBladeState=r.observable();this.continuousIntegrationBladeStateMessage=r.observable();this.linuxAppServiceSetupBladeState=r.observable();this.chooseImageBladeState=r.observable();this.chooseImageBladeStateMessage=r.observable();this.vmssTag="__CONTINUOUS_DELIVERY_INFO__";this.vmCDContext=new l.VmContinuousDeliveryContext;this.currentResourceUri=""}return n})();t.DataContext=a}))