define("MsPortalImpl/UI/Hubs/UI.ResourceMapManager",["require","exports","f","i","o","FxInternal/Di","FxHubs/RpcEndPoints","MsPortalImpl/Extension/ExtensionManager","MsPortalImpl/Services/Services.AssetTypes"],(function(n,t,i,r,u,f,e,o,s){"use strict";function et(n){return y.isSubscriptionId(n)?g.Subscriptions:y.isResourceGroupId(n)?g.ResourceGroups:y.buildResourceTypeFromResourceId(n)}function w(n,t){return{resourceId:n,assetId:null,extensionName:null,assetType:null,compositeDisplayName:null,icon:null,browseType:ut,viewModel:null,contracts:0,dynamicSelection:null,reason:i.getLogFriendlyMessage(t)}}function ot(n,t){i.disposeViewModelProperties(t);n.releaseViewModel(t)}function b(n){var t=rt(n.message,n.stack);return t.readyState=n.readyState,t.status=n.status,t.statusText=n.statusText,t}function lt(n){var t=(new Date).getTime();return t-n}function at(n,t){i.forEachKey(n,(function(i,r){(!t||t(i,r))&&delete n[i]}))}function st(n,t){t===void 0&&(t=ht);at(n,(function(n,i){return lt(i.queryTimeInMillisecondsSinceEpoch)>t}))}var l,h;u.defineProperty(t,"__esModule",{value:!0});var k=i.Base,v=k.Constants,c=r.Extension,d=v.ExtensionNames.Hubs,g=v.ResourceTypes,nt=k.Diagnostics,y=i.ViewModels.Services.ResourceTypes,a=r.TriggerableLifetimeManager,p=nt.createLog(n),tt="fulfilled",ht=6e4,it="ResourceMap$ResourceProviderViewModel",rt=nt.createIgnoreUnhandledRejectionError,ut=-1,ft=s.createViewModelDisposedError,ct;(function(n){n.mapAssetIdToResourceIdOverride=null;n.mapResourceIdToAssetIdOverride=null;n.mapResourceIdToDynamicSelectionAndIconOverride=null;n.getResourceAssetInformationOverride=null;n.signalResourcesChangedOverride=null})(l=t.Internal||(t.Internal={}));h=(function(){function n(n,t){this._storedResourceGroups={};this._storedResources={};this._extensionManager=n;this._assetTypeService=t}return n.prototype._getResourceProvider=function(){var n=this;return this._providerPromise?this._providerPromise:(this._providerPromise=this._extensionManager.getHubsExtension().then((function(t){return t.getViewModel(it).then((function(i){n._providerLifetime||(n._providerLifetime=new a);var r=!1;if(n._providerLifetime.registerForDispose((function(){r=!0;ot(t,i)})),!r)return ct=!1,i.content;throw ft("resource map provider",d,it);}))})).catch((function(t){n._providerLifetime||(n._providerPromise=null);throw t;})),this._providerPromise)},n.prototype._getResourceTypeCachePromise=function(){return this._resourceTypeCachePromise?this._resourceTypeCachePromise:(this._resourceTypeCachePromise=this._getResourceProvider().then((function(n){return Q(n.getResourceTypeCache()).then((function(n){return n}))})),this._resourceTypeCachePromise)},n.prototype._getResourceTypeMapping=function(n,t){var u=n.assetTypeManifest.resourceType,i=u&&u.mappingViewModel,r;return i?(r=n.extension,this._extensionManager.getExtensionByName(r).then((function(n){return n.getViewModel(i).then((function(u){var f=!1;if(t.registerForDispose((function(){f=!0;ot(n,u)})),!f)return u.content;throw ft("resource type mapping",r,i);}))}))):Q.reject(rt("The resource type does not have a resource type mapping view model."))},n.prototype._getResourceTypeMappingPacket=function(n){var r=this._assetTypeService,t=r.getAssetTypeByResourceType(n),i;return t?t.assetTypeManifest.resourceType.mappingViewModel?(i=new a,this._getResourceTypeMapping(t,i).then((function(r){return{resourceType:n,assetType:t,mapping:r,ltm:i}})).catch((function(){return i.dispose(),{resourceType:n}}))):Q({resourceType:n,assetType:t}):Q({resourceType:n})},n.prototype._getResourceAssetInformation=function(n,t,i){var o=this,s=l.getResourceAssetInformationOverride,r,f,e;return s?Q(s(n)):(r={},n.forEach((function(n){var t=et(n).toLowerCase();r[t]||(r[t]=[]);r[t].push(n)})),f=u.keys(r),f.sort(),e=[],f.forEach((function(n){e.push(o._getResourceTypeMappingPacket(n))})),this._getResourceTypeCachePromise().then((function(){return Q.allSettled(e).then((function(n){var t=[],u;return n.forEach((function(n){if(n.state===tt){var f=n.value,e=f.resourceType.toLowerCase(),u=f.assetType,s=f.mapping;r[e].sort();r[e].forEach((function(n){if(u){var r=function(t){return o._assetTypeService.mapResourceIdToDynamicSelectionAndIcon(n,i).then((function(i){var r=u.assetTypeManifest,e=r.name,f=r.browseType,o=r.viewModel,s=r.contracts;return{resourceId:n,assetId:t,extensionName:u.extension,assetType:e,compositeDisplayName:u.compositeDisplayName,icon:i.icon,browseType:f!==undefined?f:ut,viewModel:o,contracts:s,dynamicSelection:i.selection,isPreview:i.isPreview}})).catch((function(t){return p.error(t),w(n,t)}))};s?t.push(Q(s.mapResourceIdToAssetId(n)).then((function(n){return r(n)})).catch((function(t){return p.warning(t),w(n,t)}))):t.push(r(n))}else t.push(Q(w(n,new Error("No asset type for resource"))))}))}})),u=function(){n.forEach((function(n){n.state===tt&&n.value.ltm&&n.value.ltm.dispose()}))},Q.all(t).finally((function(){u()}))}))})))},n.prototype._signalResourcesChanged=function(n){var r=this,u=new a,t=n.map((function(n){return et(n)})),i;return t=t.unique(),i=[],t.forEach((function(n){var t=r._assetTypeService.getAssetTypeByResourceType(n);t&&t.assetTypeManifest.resourceType.mappingViewModel&&i.push(r._getResourceTypeMapping(t,u).then((function(n){return n.signalResourcesChanged?n.signalResourcesChanged():Q(!0)})))})),Q.all(i).finally((function(){u.dispose()}))},n.prototype._signalResourceGroupResourcesChanged=function(n,t){var r=this,i,u=[];t.resourcesInResourceGroup.forEach((function(n){var e,t,f;i=n.type;u.indexOf(i)===-1&&(u.push(i),e=r._assetTypeService,t=e.getAssetTypeByResourceType(i),t&&t.assetTypeManifest.resourceType.mappingViewModel&&(f=new a,r._getResourceTypeMapping(t,f).then((function(n){var t=n.signalResourcesChanged;if(t)return t()})).catch((function(n){f.dispose();p.error("Could not signal asset type "+t.compositeDisplayName.plural+": "+n)})).finally((function(){f.dispose()}))))}))},n.prototype._clearStoredResourceGroups=function(n){n===void 0&&(n=!1);n?st(this._storedResourceGroups):this._storedResourceGroups={}},n.prototype._clearStoredResources=function(n){n===void 0&&(n=!1);n?st(this._storedResources):this._storedResources={}},n.prototype.dispose=function(){var n=this._providerLifetime;n&&n.dispose();this._providerLifetime=this._providerPromise=this._storedResourceGroups=this._storedResources=null},n.prototype.processResourceGroupChange=function(){return this._clearStoredResourceGroups(),this._clearStoredResources(),Q(!0)},n.prototype.getResourceGroup=function(n,t,i){var r=this;return(this._clearStoredResourceGroups(!0),!t&&this._storedResourceGroups[n])?Q(this._storedResourceGroups[n].data):this._getResourceProvider().then((function(r){return Q(r.getResourceGroup(n,i,t))})).then((function(t){var i=t&&t.error;if(i)if(i.message)throw b(i);else throw i;return r._storedResourceGroups[n]={queryTimeInMillisecondsSinceEpoch:(new Date).getTime(),data:t.result},t.result}))},n.prototype.getResource=function(n,t,i){var r=this;return(this._clearStoredResources(!0),!t&&this._storedResources[n])?Q(this._storedResources[n].data):this._getResourceProvider().then((function(r){return Q(r.getResource(n,i,t))})).then((function(t){var i=t&&t.error;if(i)if(i.message)throw b(i);else throw i;return r._storedResources[n]={queryTimeInMillisecondsSinceEpoch:(new Date).getTime(),data:t.result},t.result}))},n.prototype.getResourceGroupQueryResults=function(n,t,i){return this._getResourceProvider().then((function(t){return Q(t.getResourceGroupResults(n,i))})).then((function(n){var t=n&&n.error;if(t)if(t.message)throw b(t);else throw t;return n.result}))},n.prototype.mapAssetIdToResourceId=function(n){var t=l.mapAssetIdToResourceIdOverride;return t?Q(t(n)):this._assetTypeService.mapAssetIdToResourceId(n)},n.prototype.mapResourceIdToAssetId=function(n){var t=l.mapResourceIdToAssetIdOverride;return t?Q(t(n)):this._assetTypeService.mapResourceIdToAssetId(n)},n.prototype.mapResourceIdToDynamicSelectionAndIcon=function(n,t){var i=l.mapResourceIdToDynamicSelectionAndIconOverride;return i?Q(i(n)):this._assetTypeService.mapResourceIdToDynamicSelectionAndIcon(n,t)},n.prototype.getResourceAssetInformation=function(n,t){return this._getResourceAssetInformation(n,!0,t)},n.prototype.signalResourcesChanged=function(n){var t=l.signalResourcesChangedOverride;return t?Q(t(n)):this._signalResourcesChanged(n)},n.prototype.processAssetDeletion=function(n,t,i,r){var u={reason:"ResourceMapManager.processAssetDeletion"};n.name===d&&t===v.AssetNames.ResourceGroups?(this.processResourceGroupChange(i,u),r&&this._signalResourceGroupResourcesChanged(i,r)):this.processResourceGroupChange(null,u)},n})();h=__decorate([f.Class(),__metadata("design:paramtypes",[o.ExtensionManager,s.AssetTypeService])],h);t.ResourceMapManager=h;t.mapAssetIdToResourceId=f.defineHandler(c.mapAssetIdToResourceIdEndPoint,(function(n){return n.diContainer.get(h).mapAssetIdToResourceId(n.messageArg)}));t.mapResourceIdToAssetId=f.defineHandler(c.mapResourceIdToAssetIdEndPoint,(function(n){return n.diContainer.get(h).mapResourceIdToAssetId(n.messageArg)}));t.mapResourceIdToDynamicSelectionAndIcon=f.defineHandler(c.mapResourceIdToDynamicSelectionAndIconEndPoint,(function(n){return n.diContainer.get(h).mapResourceIdToDynamicSelectionAndIcon(n.messageArg.resourceId,{reason:"mapResourceIdToDynamicSelectionAndIcon",extension:n.messageContext.srcWindowId})}));t.getResourceAssetInformation=f.defineHandler(c.getResourceAssetInformationEndPoint,(function(n){return n.diContainer.get(h).getResourceAssetInformation(n.messageArg,{reason:"getResourceAssetInformation",extension:n.messageContext.srcWindowId})}));t.getResourceAssetInformationForHubs=f.defineHandler(e.AssetTypes.getResourceAssetInformationEndPoint,(function(n){return n.diContainer.get(h).getResourceAssetInformation(n.messageArg,{reason:"getResourceAssetInformationForHubs",extension:n.messageContext.srcWindowId})}));t.getResource=f.defineHandler(c.getResourceEndPoint,(function(n){return n.diContainer.get(h).getResource(n.messageArg.resourceId,n.messageArg.skipCache,{reason:n.messageArg.invoker+":getResource",extension:n.messageContext.srcWindowId})}));t.getResourceGroup=f.defineHandler(c.getResourceGroupEndPoint,(function(n){return n.diContainer.get(h).getResourceGroup(n.messageArg.resourceGroupId,n.messageArg.skipCache,{reason:n.messageArg.invoker+":getResourceGroup",extension:n.messageContext.srcWindowId})}));t.signalResourcesChanged=f.defineHandler(c.signalResourcesChangedEndPoint,(function(n){return Q(n.diContainer.get(h).signalResourcesChanged(n.messageArg))}))}))