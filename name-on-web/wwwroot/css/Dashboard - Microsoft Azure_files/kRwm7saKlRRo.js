define("Permissions/Permission",["require","exports","f","o","a","Shared/AjaxExtensions","Shared/Utilities/KnockoutUtilities","Shared/Utilities"],(function(n,t,i,r,u,f,e,o){"use strict";function l(n){if(n){var t=n();if(t)return e.isTrue(t.isAvailable)}return!1}function a(n){if(n){var t=n();if(t)return e.isTrue(t.isFeatureEnabled)&&e.isTrue(t.isAvailable)}return!1}var h,c,s;r.defineProperty(t,"__esModule",{value:!0}),(function(n){n[n.Create=1]="Create";n[n.Read=2]="Read";n[n.Update=4]="Update";n[n.Delete=8]="Delete";n[n.InviteGuest=16]="InviteGuest"})(h=t.ActionType||(t.ActionType={})),(function(n){n[n.Application=0]="Application";n[n.Contact=1]="Contact";n[n.Contract=2]="Contract";n[n.Device=3]="Device";n[n.DirectoryRole=4]="DirectoryRole";n[n.DirectorySetting=5]="DirectorySetting";n[n.Domain=6]="Domain";n[n.Group=7]="Group";n[n.OAuth2PermissionGrant=8]="OAuth2PermissionGrant";n[n.Policy=9]="Policy";n[n.ServicePrincipal=10]="ServicePrincipal";n[n.SubscribedSku=11]="SubscribedSku";n[n.TenantDetail=12]="TenantDetail";n[n.User=13]="User";n[n.RiskyUser=14]="RiskyUser";n[n.ApplicationAssignment=15]="ApplicationAssignment";n[n.ApplicationProxyTenantSettings=16]="ApplicationProxyTenantSettings";n[n.ApplicationProxyAppSettings=17]="ApplicationProxyAppSettings";n[n.ApplicationProxyConnector=18]="ApplicationProxyConnector";n[n.ApplicationProxyConnectorGroup=19]="ApplicationProxyConnectorGroup";n[n.AuthenticationMethods=20]="AuthenticationMethods";n[n.AzureADConnect=21]="AzureADConnect";n[n.CompanyRelationships=22]="CompanyRelationships";n[n.Consent=23]="Consent";n[n.DeviceSettings=24]="DeviceSettings";n[n.DirectoryGroupSettings=25]="DirectoryGroupSettings";n[n.DynamicGroup=26]="DynamicGroup";n[n.GalleryApp=27]="GalleryApp";n[n.IdentityProtection=28]="IdentityProtection";n[n.Licenses=29]="Licenses";n[n.TrialLicenses=30]="TrialLicenses";n[n.LoginTenantBranding=31]="LoginTenantBranding";n[n.MdmApplication=32]="MdmApplication";n[n.MultiFactorAuthentication=33]="MultiFactorAuthentication";n[n.NotificationsUserSettings=34]="NotificationsUserSettings";n[n.PasswordResetPolicy=35]="PasswordResetPolicy";n[n.Reports=36]="Reports";n[n.SelfServiceAppAccess=37]="SelfServiceAppAccess";n[n.SingleSignOn=38]="SingleSignOn";n[n.UserProvisioning=39]="UserProvisioning";n[n.UserPassword=40]="UserPassword";n[n.SyncingDevice=41]="SyncingDevice";n[n.Bitlocker=42]="Bitlocker";n[n.AzureResource=43]="AzureResource";n[n.ClassicPolicy=44]="ClassicPolicy";n[n.UserProfileBasicProperties=45]="UserProfileBasicProperties";n[n.UserProfileRestrictedProperties=46]="UserProfileRestrictedProperties";n[n.ConditionalAccess=47]="ConditionalAccess"})(c=t.TargetObjectType||(t.TargetObjectType={}));s=(function(){function n(){}return n.FetchPermissions=function(n){var i=this,t=Q.defer(),r;return this._permissionsPromiseInitted&&!n?this._permissionsPromiseDeferred.promise.then((function(n){t.resolve(n)})).catch((function(n){t.reject(n)})):(r={forceRefresh:n},this._permissionTableCache.fetch(r,null).then((function(n){i._permissionsPromiseDeferred.resolve(n);t.resolve(n);i._permissionsPromiseInitted=!0})).catch((function(n){t.reject(n);i._permissionsPromiseDeferred.reject(n)}))),t.promise},n.CheckMultiplePermissions=function(t,r,u){if(u===void 0&&(u=!1),i.isNullOrUndefined(t))return null;return this.FetchPermissions(u).then((function(i){for(var r,f,e=i.data(),s=e.allowedActions(),h=e.notApplicableActions(),u=0,o=t;u<o.length;u++)r=o[u],f=n.CheckIsApplicablePermissionAndHasAccess(s,h,r.objectType,r.actionType),r.hasAccess=f.hasAccess,r.isApplicable=f.isApplicable;return t})).catch((function(n){o.isResponseUnauthorized(n)&&r.unauthorized();throw n;}))},n.CheckPermission=function(t,i,r,u){u===void 0&&(u=!1);return this.FetchPermissions(u).then((function(r){var u=r.data(),f=u.allowedActions(),e=u.notApplicableActions(),o=n.CheckIsApplicablePermissionAndHasAccess(f,e,t,i);return o.hasAccess})).catch((function(n){o.isResponseUnauthorized(n)&&r.unauthorized();throw n;}))},n.CheckIsApplicablePermissionAndHasAccess=function(t,r,u,f){var e={objectType:u,actionType:f,hasAccess:n.ContainsPermission(t,u,f),isApplicable:!n.ContainsPermission(r,u,f)};return i.isFeatureEnabled("ShowRBAC")&&console.log("AAD_IAM_ShowRBAC: hasAccess: "+e.hasAccess+" isApplicable: "+e.isApplicable+" targetObject:"+c[u]+", action:"+h[f]+", allowedActionsList:"+JSON.stringify(t)+", notApplicableActionsList:"+JSON.stringify(r)),e.hasAccess=e.hasAccess&&e.isApplicable,e},n.IsTenantRegionScopeAllowed=function(n){var t=this._isTenantRegionScopeAllowed.fetch({},n).then((function(n){return n.data()}));return Q(t)},n.CheckPermissionWithOwnerCheck=function(t,r,u,f,e){var s=this,o,h;return e===void 0&&(e=!1),h=this.FetchPermissions(e).then((function(e){var h=e.data(),v=h.allowedActions(),y=h.notApplicableActions(),l,c,a;return o=n.CheckIsApplicablePermissionAndHasAccess(v,y,t,r).hasAccess,o?o:(l=h.ownerConditionalActions(),c=s.ContainsPermission(l,t,r),c)?(a=s._isCurrentUserOwner.fetch({objectId:u},f).then((function(n){var t=n.data();return i.isFeatureEnabled("ShowRBAC")&&console.log("AAD_IAM_ShowRBAC: isOwner: "+t),t})),Q(a)):c})),Q(h)},n.ContainsPermission=function(n,t,i){var r;if(n){var f=c[t].toLowerCase(),e=h[i].toLowerCase(),u=n[f];if(u&&(r=u(),r&&r.length>0&&(r.indexOf(e)>-1||r.indexOf("*")>-1)))return!0}return!1},n})();s._permissionsPromiseInitted=!1;s._permissionsPromiseDeferred=Q.defer();s.UnauthorizedErrorTypeString="MsPortalFx.Errors.UnauthorizedDataError";s._getPermissionTableUriTemplate=i.Base.Resources.getAppRelativeUri("api/Permissions?forceRefresh={0}");s._getIsTenantRegionScopeAllowedUriTemplate=i.Base.Resources.getAppRelativeUri("api/Permissions/IsTenantRegionScopeAllowed");s._getIsCurrentUserOwner=i.Base.Resources.getAppRelativeUri("api/Permissions/{0}/isOwner");s._getUserSystemRoleTemplateIdsQuery=i.Base.Resources.getAppRelativeUri("api/Permissions/GetUserSystemRoleTemplateIds");s.businessScenarios=o.getBusinessScenarios();s._permissionTableCache=new i.Data.EntityCache({entityTypeName:PermissionObjects.DataModels.PermissionsTableType,sourceUri:function(n){return s._getPermissionTableUriTemplate.format(n.forceRefresh)},poll:!0,supplyData:function(n,t,i,r,u,e){return f.AuthenticatedToAdIbizaUx.trackedSupplyData(s.businessScenarios.permissions(),"GetPermissions","GetPermissions","Get permission tables",n,t,i,r,u,e)}});s._isTenantRegionScopeAllowed=new i.Data.EntityCache({sourceUri:function(){return s._getIsTenantRegionScopeAllowedUriTemplate},poll:!1,supplyData:function(n,t,i,r,u,e){return f.AuthenticatedToAdIbizaUx.trackedSupplyData(s.businessScenarios.permissions(),"IsTenantRegionScopeAllowed","IsTenantRegionScopeAllowed","Verify if region scope is within allowed list of values for given cloud",n,t,i,r,u,e)}});s._isCurrentUserOwner=new i.Data.EntityCache({sourceUri:function(n){return s._getIsCurrentUserOwner.format(n.objectId)},poll:!1,supplyData:function(n,t,i,r,u,e){return f.AuthenticatedToAdIbizaUx.trackedSupplyData(s.businessScenarios.permissions(),"IsCurrentUserOwner","IsCurrentUserOwner","Verify if current user is the owner of the given object",n,t,i,r,u,e)}});s.getUserSystemRoleTemplateIdsQuery=new i.Data.QueryCache({sourceUri:function(){return s._getUserSystemRoleTemplateIdsQuery},poll:!1,supplyData:function(n,t,i,r,u,e){return f.AuthenticatedToAdIbizaUx.trackedSupplyData(s.businessScenarios.permissions(),"GetUserSystemRoleTemplateIds","GetUserSystemRoleTemplateIds","Get user system role template ids",n,t,i,r,u,e)}});t.Permission=s;t.isFeatureAvailable=l;t.isFeatureEnabledAndAvailable=a}))