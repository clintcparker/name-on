define("ReleaseManagement/TypeScript/Utilities/ValidationUtils",["require","exports","f","o","Core/TypeScript/TFS.Azure.Context","Core/TypeScript/TFS.Azure","ReleaseManagement/TypeScript/Resources/ReleaseManagementResources","ReleaseManagement/TypeScript/Utilities/LogHelper","ReleaseManagement/TypeScript/Utilities/ReleaseManagementUtils","ReleaseManagement/TypeScript/Service/ServiceConstants","ReleaseManagement/TypeScript/Service/RMHttpClient","ReleaseManagement/TypeScript/Service/SecurityHttpClient","ReleaseManagement/TypeScript/Service/ContinuousDeliveryHttpClient","AzureProject/TypeScript/Utilities/AzureProjectLogHelper"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";r.defineProperty(t,"__esModule",{value:!0});var w=i.Base.Diagnostics.Log,b=(function(){function n(){}return n})(),k=(function(){function n(){}return n})(),d=(function(){function n(){}return n})(),p="ArmApiManager|{0}",y=(function(){function n(){}return n.getVstsPermissions=function(n,t){if(!n||!t)return o.LogHelper.LogError("Account or project is null while validating project permissions."),Q.reject("Account and project cannot be null");var i=f.getTfsContext({accountId:n.id()}),r=i.getHostUrl(),u=new l.SecurityHttpClient(r),s=new l.SecurityHttpClient(n.rmAccountUrl()),h=new c.RMHttpClient(n.rmAccountUrl());return h.getEnvironmentTemplates(t.id()).then((function(){var n=u.hasEditBuildDefinitionPermissions(t.id()),i=s.hasEditReleaseDefinitionPermissions(t.id());return Q.all([n,i]).then((function(n){var t="",i=n[0]&&n[0].value&&n[0].value[0],r=n[1]&&n[1].value&&n[1].value[0];return!i&&r?t=e.noBuildPermissions:i&&!r?t=e.noReleasePermissions:i||r||(t=e.noBuildOrReleasePermissions),{hasPermissions:i&&r,message:t}}))})).catch((function(n){o.LogHelper.LogError("getVstsPermissions: getEnvironmentTemplates call failed");throw n;}))},n.hasRoleAssignmentPermissionsAtScope=function(n){var r=this,t=Q.defer(),u=this._scopeLevelPermissionUri.format(n,this._authArmVersion);return i.Base.Net2.ajax({uri:u,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(n){if(n.error){t.reject(n.error);return}t.resolve(r._hasRoleAssignmentRights(n.value))}),(function(n){t.reject(n)})),t.promise},n.isSubscriptionEnabled=function(n){var r=this,t=Q.defer(),u=this._listSubscriptionsUri;return i.Base.Net2.ajax({uri:u,type:"GET",dataType:"json",cache:!1,contentType:"application/json",setAuthorizationHeader:!0}).then((function(i){if(i.error){t.reject(i.error);return}var u=i.value.filter((function(t){return t.subscriptionId===n})),f=!1;u.length>0&&(f=r._allowedSubscriptionStates.indexOf((!u[0].state?"":u[0].state).toLowerCase())>=0);t.resolve(f)}),(function(n){t.reject(n)})),t.promise},n._hasRoleAssignmentRights=function(n){var i,r,t;if(n.length==0)return!1;for(i=0,r=n;i<r.length;i++)if((t=r[i],t.actions=t.actions.map((function(n){return n.toLowerCase()})),t.notActions=t.notActions.map((function(n){return n.toLowerCase()})),t.actions.indexOf("*")>=0&&t.notActions.indexOf("microsoft.authorization/*")<0&&t.notActions.indexOf("microsoft.authorization/*/write")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/*")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0)||t.actions.indexOf("*/write")>=0&&t.notActions.indexOf("microsoft.authorization/*")<0&&t.notActions.indexOf("microsoft.authorization/*/write")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/*")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0||t.actions.indexOf("microsoft.authorization/*")>=0&&t.notActions.indexOf("microsoft.authorization/*/write")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/*")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0||t.actions.indexOf("microsoft.authorization/*/write")>=0&&t.notActions.indexOf("microsoft.authorization/roleassignments/*")<0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0||t.actions.indexOf("microsoft.authorization/roleassignments/*")>=0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0||t.actions.indexOf("microsoft.authorization/roleassignments/write")>=0&&t.notActions.indexOf("microsoft.authorization/roleassignments/write")<0)return!0;return!1},n.canCreateAadApp=function(){if(s.ReleaseManagementUtils.isFeatureEnabled("ValidateAadPermissions")&&!this._canCreateApp){var n=Q.defer(),t=u.getAzureTfsContext(),r=new a.ContinuousDeliveryHttpClient(t.extensionConfiguration.serverUrl),o=f.getCurrentDirectoryInfo(),h=i.Base.Security.getAuthorizationToken({resourceName:"self"});return Q.spread([o,h],(function(t,i){var u=i.header.slice(6),f={aadPermissions:{token:u,tenantId:t.tenantId}};r.getPermissionsResult(f).then((function(t){t.aadPermissions.value?n.resolve(""):n.resolve(e.noPermissionsToCreateApp.format(t.aadPermissions.message))})).catch((function(t){n.resolve("");w.writeEntry(2,"ValidationUtils","error: "+JSON.stringify(t))}))})).catch((function(t){n.resolve("");w.writeEntry(2,"ValidationUtils","error: "+JSON.stringify(t))})),n.promise}return Q.resolve("")},n.HasLinkAccountPermission=function(t){if(t==null)return o.LogHelper.LogError("Account is null while validating project permissions."),Q.reject("Account is empty.");var r=Q.defer(),u=t.spsAccountUrl(),f=n._collectionPermissionUriFormat.format(u,h.CollectionBasedPermissionNamespaceId,h.CollectionBasedWritePermission,h.AccountLinkSecurityNamespaceToken);return n._getAuthHeader("self").then((function(n){i.Base.Net2.ajax({uri:f,type:"GET",cache:!1,contentType:"application/json",setAuthorizationHeader:!1,headers:{Authorization:n}}).then((function(n){r.resolve(n)}),(function(n){var t=n&&n.message?n.message:n;r.reject(v.AzureProjectLogHelper.getDetailedError(t,p.format("HasLinkAccountPermission")))}))})).catch((function(n){r.reject(v.AzureProjectLogHelper.getDetailedError(n,p.format("HasLinkAccountPermission")))})),r.promise},n._getAuthHeader=function(n){var t=Q.defer(),u=i.getFeatureValue("authTokenOverride"),f,r;return!u?(i.Base.Security.getAuthorizationToken({resourceName:n}).then((function(n){t.resolve(n.header)})).catch((function(n){t.reject(v.AzureProjectLogHelper.getDetailedError(n,p.format("_getAuthHeader")))})),t.promise):(f="Basic {0}",r=":",r=r.concat(u),t.resolve(f.format(btoa(r))),t.promise)},n})();y._canCreateApp=!1;y._authArmVersion="?api-version=2016-07-01";y._allowedSubscriptionStates=["enabled","active"];y._scopeLevelPermissionUri="https://management.azure.com/{0}/providers/Microsoft.Authorization/permissions/{1}";y._listSubscriptionsUri="https://management.azure.com/subscriptions?api-version=2014-04-01";y._collectionPermissionUriFormat="{0}_apis/permissions/{1}/{2}?token={3}&alwaysAllowAdministrators=true&api-version=5.0-preview.1";t.ValidationUtils=y}))