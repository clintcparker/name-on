define("MsPortalImpl/Base/Base.HierarchyMap",["require","exports","f","a","ko"],(function(n,t,i,r,u){"use strict";var f;return (function(n){var t="##-##",i=(function(){function n(){this._observable=u.observableArray()}return n.prototype.addItem=function(n,i){if(n&&n.length){if(n.some((function(n){return!n})))throw new Error("Invalid path segment");else if(this._getItemIndex(n)>=0)throw new Error("Duplicate path '"+JSON.stringify(n)+"'.");}else throw new Error("Invalid path");this._observable.push({path:n,_pathKey:n.join(t),value:i})},n.prototype.removeItem=function(n){var t=this._getItemIndex(n);t>=0&&this._observable.splice(t,1)},n.prototype.removeItemsInPath=function(n){var t=[];this._getItemsWithPath(n,!0,(function(n,i){return!n&&t.push(i)}));this._observable(t)},n.prototype._getItemIndex=function(n){var i=n.join(t);return this._observable.peek().firstIndex((function(n){return n._pathKey===i}))},n.prototype.getItem=function(n){var t=this._getItemIndex(n);return t>=0?this._observable.peek()[t]:null},n.prototype.getItemsInPath=function(n){return this._getItemsWithPath(n,!0)},n.prototype.getItemsUnderPath=function(n){return this._getItemsWithPath(n,!1)},n.prototype.getObservable=function(){return this._observable},n.prototype._getItemsWithPath=function(n,i,r){var u=n.join(t);return this._observable.peek().filter((function(t){var f=t._pathKey.startsWith(u)&&(i||t.path.length>n.length);return r&&r(f,t),f}))},n})();n.HierarchyMap=i})(f||(f={})),f}));
define("MsPortalImpl/UI/Commands/UI.Commands.Blade",["require","exports","f","i","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.ShellCommands"],(function(n,t,i,r,u,f,e){"use strict";var o;return (function(n){function k(n){return t||(o=o||new r.TriggerableLifetimeManager,t=[],t[l]=new h(o,s.bladeRestore,l),t[a]=new h(o,s.bladeMaximize,a)),t[n]}function d(n){t&&(o&&o.dispose(),o=null,t=null);t=n}var c=i.Base.Images,y=i.Blades,p=y.Internal.DisplayState,s=u.ShellCommands,w=c.Blank(),b=(function(n){function t(t,i){var r=n.call(this,t,i,s.pinToStartboard,!0)||this;return r.commandName=e.CommandNames.PinBlade,r.icon(c.Pin()),r}return __extends(t,n),t.prototype.execute=function(t){var r=this,u=this._getComposition();return Q.all([i.require("MsPortalImpl/UI/UI.Desktop.Actions"),u.getPinOptions()]).spread((function(n,t){return n.pinBladeToStartboard(t,r._services)})).finally((function(){n.prototype.execute.call(r,t)}))},t})(e.ShellCommand),h,o,l,a,t,v;n.Pin=b;h=(function(n){function t(t,i,r){var u=n.call(this,t,null,i,!0)||this;return u.commandName=e.CommandNames.BladeDisplayState+p[r],u._targetState=r,u.icon(w),u}return __extends(t,n),t.prototype.execute=function(t){var i=f.getBladeContainerWidget($(this._currentContext.target));i&&i.options.displayState(this._targetState);n.prototype.execute.call(this,t)},t.prototype.bind=function(t){var i=f.getBladeContainerWidget($(t.target));n.prototype.bind.call(this,t);this.enabled(i&&this._targetState===i.options.displayState())},t})(e.ShellCommand);n.BladeDisplayStateCommand=h;l=1;a=2;n.getDisplayStateCommand=k;n.setDisplayStateCommands=d;v=(function(n){function t(t,i,r,u){var f=n.call(this,t,u,s.resetLayout,i!==!0)||this;return f.commandName=e.CommandNames.ResetLayout,f.icon(c.Refresh()),f.bind=function(t){n.prototype.bind.call(f,t);f.enabled(i!==!0&&r()!==0)},f}return __extends(t,n),t.prototype.execute=function(t){this._getComposition().resetLayout();n.prototype.execute.call(this,t)},t.prototype.bind=function(){},t})(e.ShellCommand);n.ResetLayout=v})(o||(o={})),o}));
define("MsPortalImpl/UI/Commands/UI.CommandBarManager",["require","exports","f","i","o","ko","FxInternal/Composition/ViewModel","MsPortalImpl/Base/Base.ImplUtils","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/UI/Compositions/UI.Composition.Selectable2Registrar"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v){"use strict";function d(n,t,i,r){var u=p(),f=p(),e=p(),o,h;return n.registerForDispose((function(){u().forEach(y);f().forEach(y);e().forEach(y)})),tt(n,t,i,e),o=s.getCommandGroupForDefinitionItem(i.finder,t.extension.name,t.bladeDefinition),o?g(n,t,i,o,r,u):nt(n,t,i,f),h=t.widget.options.commandBar.menuItems,w(n,(function(){var n=i.desktop.mode()===1?e():u();n.length||(n=f());h(n.slice())})),Q()}function g(n,t,i,r,u,f){var h=t.widget,e=r.commands.map((function(r){var f=new s.ExtensionCommandMenuItemImpl(n,t.extension,t,r,t.bladeDefinition,i,u);return f.activate(),f})),o=h.options.contextMenu.menuItems;o.push.apply(o,e);f(e)}function nt(t,i,u,s){var p=i.bladeDefinition.toolbar,a=p?p.source.valuesFrom[0]:null,h,l,y;a&&(h=i.children.mapMany((function(n){return n.children})).first((function(n){return n.locator.name===a.part})),y=f.observable(!0),i.uiBlockers.push(y),h.awaitComposed().then((function(){var p=h.getViewModel(0),d=c.getModelValue(p,a.property),y,g,nt;d.exists?(i.widget.options.renderCmdBarWhenNoCmd(!0),y=d.value.items,b(y)?(g=y.map(t,(function(n,t){return f.ignoreDependencies((function(){return k(n,t,h.locator,u)}))})),w(t,(function(){var n=g();f.ignoreDependencies((function(){v.registerOpenBladeCommands(y(),p,h,"commandBar2Selectables",undefined)?s(n):s([])}))}))):l="Invalid view model for the toolbar at '{0}' in part '{1}'. It is missing the items property"):e.isV2(p.content)||(l="Unable to find the view model for the toolbar at '{0}' in part '{1}'.");l&&(l=l.format(a.property,h.locator.toFriendlyString()),nt=r.createError(l),o.logToExtension(n,h.extension.name,2,nt))})).finally((function(){return y(!1)})))}function tt(n,t,i,r){var e=t.containerWidget,f=t.widget.options,u;f.locked()||i.desktop.mode.subscribeAndRun(n,(function(o){if(u&&u.dispose(),u=null,o===1){u=n.createChildLifetime();var c=new h.ResetLayout(u,f.locked(),f.displayState,i);c.activate();c.bind(new s.CompositionInstanceCommandContext(e.element[0],function(){return Q(e.getContentWidget())},t));r([c])}else r.removeAll().forEach(y)}))}u.defineProperty(t,"__esModule",{value:!0});var b=i.isObservableArray,it=i.Base.Diagnostics,p=f.observableArray,w=f.reactor,k=a.createItem,y=i.disposeDisposable;t.create=d}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade.Actions",["require","exports","o"],(function(n,t,i){"use strict";function f(n,t,i,f,e,o){var s=t()||r,h;e=e||r;f=f||r;h=o?e:n.menuBlade||i?u:i&&s!==f?s:e;t(h)}i.defineProperty(t,"__esModule",{value:!0});var r=1,u=2;t.applyDisplayState=f}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Lens",["require","exports","f","o","ko","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Part","MsPortalImpl/Widgets/Widgets.Lens","MsPortalImpl/Base/Base.EventTypes"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function w(n){var t=n.services.finder.locate(n.locator);return t&&t.isSummary}function b(n,t){var i=n.finder.locate(t),u=new c(n,t),r;return i&&i.partInstances&&(r=[],i.partInstances.forEach((function(i){var u=o.create(n,t.withPartInstance(i.name));r.push(u)})),u.addChildren(r)),u}var c;r.defineProperty(t,"__esModule",{value:!0});var l=i.Base,a=l.Diagnostics,v=f.CompositionType,y=h.default,p=a.createLog(n);c=(function(n){function t(t,i,r,u,f){var e=n.call(this,"Lens",t,i,r,u,f)||this;return e._childOnInputsSetsResolved=Q.defer(),e._childAboveTheFoldOnInputsSetsResolved=Q.defer(),e}return __extends(t,n),t.prototype.awaitChildrenOnInputsSetsResolved=function(){return this._childOnInputsSetsResolved.promise},t.prototype.awaitChildrenAboveTheFoldOnInputsSetsResolved=function(){return this._childAboveTheFoldOnInputsSetsResolved.promise},t.prototype.getCompositionType=function(){return v.Lens},t.prototype._compose=function(n,t,i){var r=this,f,l=Q({}),o=w(this),h;if(i=i||{},f=new s.ViewModel(this.id,this.widgetState()),u.computed(this,(function(){f.locked(n.options.locked())})),h=$("<div "+(o?"class='fxs-portal-border'":"")+"/>"),this.widget=new s.Widget(h,f),this._attachWidgetErrorEvent(),o?(f.locked(!0),n.setSummary(h)):n.addChild(this.widget),this.services.finder.locateAsync(this.locator.getExtensionLocator()).done((function(n){var t=r.services.finder.locate(r.locator),i;t&&t.title&&(i=t.title,i?f.title(i):p.error("Lens {0} in extension {1} is missing title.".format(r.locator.toString(),n.name)))})),this.children){var c=this.children.length,e=c,a=this.children.slice();a.forEach((function(n,t){var f=!t,u;n.awaitOnInputsSetComplete().finally((function(){c--;c||r._childOnInputsSetsResolved.resolve();n.getLoadDelayed()||(e--,e||r._childAboveTheFoldOnInputsSetsResolved.resolve())}));u=f&&(i.noDelayOnFirstPart||o);n.compose(r.widget,undefined,{delayLoadPromise:u?null:i.delayLoadPromise,noDelayOnFirstPart:i.noDelayOnFirstPart,delayLoad:i.delayLoad});n.getLoadDelayed()&&(e--,e||r._childAboveTheFoldOnInputsSetsResolved.resolve())}))}this.save();l.then((function(){t.resolve()}))},t.prototype.resetLayout=function(){var n=this,t=this.services.finder.locate(this.locator);t&&t.partInstances&&(this.removeChildren(),t.partInstances.forEach((function(t){var r=n.locator.withPartInstance(t.name),i=o.create(n.services,r),u={partId:i.id,lensId:n.id};n.addChildren([i]);i.compose(n.widget);n.widget.trigger(y.fxrearrange,null,u)})))},t})(e.Instance);t.Instance=c;t.create=b}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Blade",["require","exports","f","i","o","a","ko","$","MsPortalImpl/UI/UI.DialogManager","MsPortalImpl/Base/Base.EventTypes","MsPortalImpl/Resources/ImplScriptResources","MsPortalImpl/Base/Base.Router.Blade","MsPortalImpl/Base/Telemetry","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/Interactions/Interactions.FocusHandler","MsPortalImpl/Interactions/Interactions.PortalReader","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/Widgets/Widgets.Blade","MsPortalImpl/Widgets/Widgets.BladeContent","MsPortalImpl/Widgets/Widgets.CommandBar","MsPortalImpl/Widgets/Widgets.UIElementBase","MsPortalImpl/UI/Commands/UI.CommandBarManager","MsPortalImpl/UI/Commands/UI.Commands","MsPortalImpl/UI/Commands/UI.Commands.Blade","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/Compositions/UI.Composition.Blade.Actions","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.CompositionAwaiter","MsPortalImpl/UI/Compositions/UI.Composition.CompositionBinder","MsPortalImpl/UI/Compositions/UI.Composition.Lens","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/Compositions/UI.Composition.Security"],(function(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct,lt,at){"use strict";function pi(n){return n.getExtensionLocator()}function wi(n){var t=n&&pi(n);return t&&t.name}function gt(n){return n&&n.toFriendlyString()}function su(n,t,i){var r=new tr(n,t.locator),u={};if(!i)throw new Error("masterContainer is required when creating a blade.");return r.masterContainer=i,r.masterCommandId=t.masterCommandId,r.masterCommandName=t.masterCommandName,r.masterCommandExtension=t.masterCommandExtension,r.masterPartId=t.masterPartId,r.masterInvocationProperty=t.masterInvocationProperty,r.masterInputKeys=t.masterInputKeys,r.masterDetailsDefinition=t.masterDetailsDefinition,r.flags=t.flags,n.finder.tryLocate(t.locator,u)&&(r.bladeDefinition=u.value,r.extension=n.finder.locate(pi(t.locator))),r.setInputsViewModel(ht.CompositionBinder.createObservableModel(t.model)),r.bindings=t.bindings||[],r.restorationState=t.flags===undefined||t.flags&4?0:1,r}function ar(n){return!(n.menuBlade||n.style===12||(n.lenses||[]).some((function(n){return(n.partInstances||[]).some((function(n){return n.parameterProvider}))})))}function nr(n,t,i){var f=n.options,u,r;f.showTranslucentSpinner(!1);i.menuBlade&&(n.clearDetailContent({clearPlaceholderDetailContent:!0}),t.bladeWidth(2));u=t.contextMenu;r=u&&u.menuItems;r&&r.splice(0,r().length)}function vr(n){var t=n.effectiveInputs;return t&&t.length&&n.assetIdInputProperty&&n.assetType}function yr(n){var t=n&&n.options,i=t&&t.unauthorizedNoticeVm;return!!vi(i)}function pr(n,t,i){var e,r={exists:!1,value:undefined},u,f;return vr(n)&&(e=n.effectiveInputs.first((function(t){return t.property===n.assetIdInputProperty})),u=e&&e.valuesFrom,f=u&&u[0]&&u[0].property,f&&u[0].referenceType===1&&(r=lt.getModelValue(t,f),r.exists?r.value=ti(r.value):pt.error("Asset id property '"+f+"' does not exist in model for composition '"+i+"'. Model='"+hi(t)+"'"))),r}function ir(n){return{id:gt(n.locator),instanceId:n.instanceId}}function wr(n,t){for(var u,r=n.detailContainers,f=function(n){var f=r[n],i,u;if(t(f))return i=f.containerWidget,i&&(u=document.activeElement,u&&o.contains(i.element[0],u)||ci.setTimeout((function(){i.setFocus()}),150)),"break"},i=r.length-1;i>=0;i--)if(u=f(i),u==="break")break}function ii(n,t,i,r,u,f,e,o){var s=lt.getModelValue(i,r);s.exists?n.mapProperty(r,e||r).bind(t,i,!0,(function(){var n=ti(lt.getModelValue(i,r,!0).value);u(n||f)})):o||rt.isTraceEnabled&&pt.warning("The Blade VM with id "+t+" is missing the "+r+" field.")}function hu(n,t,i){var u=t?t.name:null,f=i?i.assetType:null,r=1;n.children.forEach((function(t){t.children.forEach((function(t){ni.trace({extension:u,source:gt(n.locator),action:vt.PartPosition,assetType:f,name:gt(t.locator),data:r});r++}))}))}function cu(n,t){function i(n){r(n||null)}var r=yt(),u=n.bladeDefinition;return dt(n,(function(){var f=ti(t.icon),r,e,o;f?i(f):u.assetType?(r=void 0,(r=n.assetId())?(e=n.extension,o={assetId:r,assetType:u.assetType,extensionName:e.name},n.services.assetTypeService.mapAssetIdToIconAndKind(o,{reason:"BladeIcon"}).then((function(n){i(n&&n.icon||k.defaultSvg)})).catch((function(){i(k.defaultSvg)}))):i(k.defaultSvg)):i()})),{icon:r}}function oi(n,t,i){fu&&pt.verbose("[BladeRebinding] "+t+" Blade: "+n+". Updated Properties: "+(hi(i,null,2)||"N/A"))}function lu(n,t,r){if(!n)return!1;var u=n.properties.filter((function(n){var t=n.compositionBindingDefinition;return t&&t.source&&t.source.modelType===1}));return u.length===0?!1:u.some((function(n){var u=ti(t[n.sourceProperty]),f=ti(r[n.sourceProperty]);return!i.deepEquals(u,f)}))}function au(n,t,i,r){var s=!1,u,f,o=e.observable(),h=function(t){var e=!1,h=t.onClick||t.onActivated,c,l;f&&(f.dispose(),f=undefined,u=undefined);c=n.detailContainers.first((function(t){return t.masterCommandName===gi.format(n.bladeDefinition.name)&&t.masterPartId===n.id}));c&&n.services.desktop.forceCloseBlade(c.id);t.selection?(e=!0,f=n.createChildLifetime(),u=tt.createOpenBladeCommand(f,n.services,n,n.bladeDefinition,n.extension,gi.format(n.bladeDefinition.name)),o(u.viewModel.container),o().selectable.selectedValue(t.selection),l=(n.detailContainers||[]).length<=0,r()&&l&&!s&&(u.execute(!1),s=!0)):h&&h.uri?(e=!0,f=n.createChildLifetime(),u=tt.createOpenLinkCommand(f,n.services,n,n.bladeDefinition,n.extension,gi.format(n.bladeDefinition.name),h)):t.onClick&&(e=!0);i.contentState(t.state);i.contentStateDisplayText(t.text);i.statusBar.activatable(e)},c=function(n){n&&n.state!==0||(n={text:"",state:0,selection:null});h(n)};return t.subscribeAndRun(n,c),dt(n,(function(){var r=o()&&o().selectable.isSelected(),n=vi(t);i.statusBar.activated(r);r&&n&&typeof n.onActivated=="function"&&n.onActivated()})),function(){u&&u.execute(!1);var n=vi(t);n&&typeof n.onClick=="function"&&n.onClick()}}function vu(){function r(){n&&(n.reject(new di.CanceledError("Throttler cancel pending promise")),ci.clearTimeout(i),n=null)}var n,t=0,i;return{rejectPendingPromise:r,throttle:function(){var f=Date.now(),e=f-t,o=e<sr,u;return t=f,r(),o?(u=n=Q.defer(),i=ci.setTimeout((function(){u===n&&(n.resolve(),n=null)}),sr),u.promise):Q()}}}function rr(n){return n.menuBlade&&n.menuBlade.isV2||n.templateBlade&&n.templateBlade.isV2||!!n.frameBlade}function br(n){n.subtitle("");n.titleSuffix("");n.subtitleSuffix("");n.description("");n.helpUri("");n.icon(fr.Blank());n.contentState(0);n.contentStateDisplayText("")}var ri,tr;u.defineProperty(t,"__esModule",{value:!0});var kr=r.Extension,kt=r.TelemetryContext,bi=kt.ContextType,ki=i.Base,di=i.Errors,dr=ki.Constants.BladeParameterNames,ur=ki.Diagnostics,ni=ur.Telemetry,fr=ki.Images,gr=fr.Shell,nu=i.Extension,tu=nu.SetRequirement,er=i.ViewModels,iu=er.Controls.Notice,ru=iu.ViewModel,wt=ni.ActionModifier,vt=a.Action,ui=a.Source,uu=i.Helpers,o=jQuery,ci=window,pt=ur.createLog(n),fi=c.Asset,li=c.Blade,si=c.Shell.Reader,gi="__{0}_StatusBarCommandDefinitionName__",fu=!!i.trace.bladerebind,or=Math.random()<.5,ei=i.isNullOrUndefined,eu="fxs-menublade",ai=f.isArray,sr=1e3,yt=e.observable,dt=e.reactor,ti=e.unwrap,hi=e.toJSON,hr=e.utils,vi=hr.peekObservable,ou=0,cr=i.forEachKey,lr=i.disposeDisposable,yi=JSON.stringify,bt=uu.Deferred;t.create=su,(function(n){n[n.ErrorUnrecoverable=1]="ErrorUnrecoverable";n[n.ErrorInitializing=2]="ErrorInitializing";n[n.ErrorLoadingExtension=3]="ErrorLoadingExtension";n[n.ErrorLoadingDefinition=4]="ErrorLoadingDefinition";n[n.ErrorLoadingExtensionAndDefinition=5]="ErrorLoadingExtensionAndDefinition"})(ri||(ri={}));tr=(function(n){function t(t,r,u,f,s){var h=n.call(this,"Blade",t,r,u,f,s)||this;h._disposablesEvents=[];h._widgetReadyToDisplayAwaiter=bt();h._partAwaiter=new st.CompositionAwaiter(!0);h._containerAwaiter=new st.CompositionAwaiter;h._bindingResult=yt();h._disabled=!1;h._rebinding=!1;h._composing=!1;h._initialized=!1;h._callbacks=[o.Callbacks(),o.Callbacks(),o.Callbacks()];h._initialOnInputsSetDeferred=Q.defer();h._bladeViewModelDeferred=bt();h._compositionDeferred=bt();h._lastInputsSetDeferred=Q.defer();h._lastInputsSetProperties={};h._markers={};h._perfData={};h._bladeSummaryCollapsed=!1;h._isOpenedByReferrer=yt(!1);h._autoOpenSettingsDisabled=!1;h.masterContainer=null;h.masterInputKeys=[];h.masterDetailsDefinition=null;h.detailContainers=[];h.bindings=[];h.editScopeId=yt();h.title=yt("");h.subtitle=yt("");h.titleSuffix=yt();h.subtitleSuffix=yt();h.description=yt("");h.helpUri=yt();h.helpContentUri=yt();h.shieldType=yt();h.uiBlockers=e.observableArray([]);h.icon=yt(gr.DefaultBlade());h.titleImageUri=yt();h.rebindThrottler=vu();h.assetId=yt();h.restorationState=0;var c=ou++,l=0,a=h._updateRebindSequenceNumber=function(){h.instanceId="Blade_"+i.sessionId+"_"+c+"_"+l++};return a(),h._shellViewModel={},h.title(b.getDefaultTitle(r&&r.name)),h._compositionDeferred.then((function(){if(h.bladeDefinition&&h.bladeDefinition.locked){var n=h.getParts();dt(h,(function(){var t=n.some((function(n){return n.triggeringLockedBladeSpinner()}));h.containerWidget.options.showTranslucentSpinner(t)}))}})),h}return __extends(t,n),t.prototype.shouldAlertOnClose=function(){return this.children.some((function(n){return n.children.some((function(n){return n.shouldAlertOnClose()}))}))},t.prototype.getAlertOnCloseMessages=function(){var n=[];return this.children.forEach((function(t){t.children.forEach((function(t){var i=t.getAlertMessage();i&&n.push(i)}))})),n},t.prototype.isRestorable=function(){return this.restorationState===0?!this.detailContainers.some((function(n){return n.restorationState===1})):!1},t.prototype.initialOnInputsSetPromise=function(){return this._initialOnInputsSetDeferred.promise},t.prototype.getViewModel=function(n,t){var i,r=this.locator,f,u;n=ei(n)?1:n;switch(n){case 1:i=this._shellViewModel;break;case 3:if(this.isComposed)this.bladeDefinition.viewModelName||pt.error("Blade '"+r+"' does not define an extension view model.");else throw new Error("Blade '"+this+"' needs to be composed before retrieving its extension view model.");i=this._extensionViewModel;break;case 2:if(this.isComposed)this.actionBar?i=this.actionBar.getViewModel():(pt.error("Blade '"+r+"' does not have an action bar."),i={});else throw new Error("Blade '"+this+"' needs to be composed before retrieving its action bar's view model.");break;case 4:f=this._getCommands();u=ut.findCommand(f,t,this+"");i=u&&u.getViewModel();break;default:pt.error("Invalid model type '"+n+"' for blade '"+r+"'.")}return i||{}},t.prototype.getDeepLink=function(n){var t=this;return Q(this.awaitComposed()).then((function(){return t.bladeDefinition.viewModelInputs&&t.initialOnInputsSetPromise()})).then((function(){var r,i;return t._useDetailContent||t.flags&1||(i=t.getInputPropertyBindings(),r=l.getDeepLink(t.services.diContainer,t.extension,t.bladeDefinition,i&&i.targetModel,t.selectedMenuItemId(),t.assetType,ti(t.assetId),t.isPinnable())),r||(t._useDetailContent||!n)&&t.masterContainer.getDeepLink()}))},t.prototype.selectedMenuItemId=function(){var n=this._menu;return n&&n.getSelectedId()},t.prototype.getViewModelAsync=function(n,t){var i=this;return(n=ei(n)?1:n,n===1)?bt().resolve(this._shellViewModel).promise():this._compositionDeferred.then((function(){if(n===4){var u=i._getCommands(),r=ut.findCommand(u,t,i+"");return r&&r.getViewModelAsync()}return n===3?i._extensionViewModelPromise:i.getViewModel(n)}))},t.prototype.setInputsViewModel=function(n){this._shellViewModel=n;var t=this.bladeDefinition;t&&ai(t.optionalInputs)&&t.optionalInputs.forEach((function(t){n[t]||(n[t]=yt())}))},u.defineProperty(t.prototype,"isInitialized",{get:function(){return this._initialized},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"eligibleForBinding",{get:function(){return!0},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"journeyPath",{get:function(){return this._journeyPath||(this._journeyPath=this._buildJourneyPath())},enumerable:!0,configurable:!0}),u.defineProperty(t.prototype,"dirtyAndNotSaving",{get:function(){return this.services.diContainer.get(w.EditScopeManager).getStateObservable(this.editScopeId())()===1},enumerable:!0,configurable:!0}),t.prototype.getCompositionType=function(){return ut.CompositionType.Blade},t.prototype.isDefaultTitle=function(){return b.getDefaultTitle(this.locator.name)===this.title()},t.prototype.canAutoOpenSettings=function(){return!this._autoOpenSettingsDisabled&&!this._isOpenedByReferrer()},t.prototype.getPermissionPromise=function(){return this._hasPermissionsDeferred.promise},t.prototype.matchesLocatorAndModel=function(n,t){var r=this.bladeDefinition,i;return!n.equals(this.locator)||!r?!1:(i=e.toJS(this._shellViewModel),n.equals(v.resourceMenu))?er.Services.ResourceTypes.compareResourceManagerId(t.id,i.id):(r.inputs||[]).every((function(n){return t[n]===i[n]}))},t.prototype.getInputsOnlyViewModel=function(){var n=this._shellViewModel,r=this.bladeDefinition,t=r&&r.outputs;return t&&t.length>0&&(n=i.clone(this._shellViewModel),t.forEach((function(t){delete n[t]}))),n},t.prototype.onAddingContent=function(n){return this.compose(n),Q()},t.prototype.onRemovingContent=function(n){n.clear()},t.prototype.canRemoveContent=function(){return this.services.desktop.tryCloseBlade(this.id)},u.defineProperty(t.prototype,"isDisabled",{get:function(){return this._disabled},enumerable:!0,configurable:!0}),t.prototype.isPinnable=function(){var n=this.bladeDefinition;return i.isFeatureEnabled("pinnable_default_off")?!!(n&&n.pinnable):n&&n.pinnable!==!1&&(n.pinnable===!0||!n.locked)},t.prototype.getPinOptions=function(){var f=this,t,i,r,u,e=this.detailContainers,n=e[0];return e.length===1&&n._useDetailContent&&n.isPinnable()?(t=this.getDeepLink(),i=n.locator,r=n.getViewModel(),u=n.getOnPinFunction()):(i=this.locator,r=this.getViewModel(),t=Q(undefined),u=this.getOnPinFunction()),Q.all([u,t]).spread((function(n,t){return{locator:i,deepLink:t,model:r,bladeTitle:f.containerWidget.options.title(),defaultMenuItemId:f.selectedMenuItemId(),onPin:n}}))},t.prototype.getOnPinFunction=function(){var n=this;return this.awaitOnInputsSetComplete().then((function(){var t=n._extensionViewModel&&n._extensionViewModel.content;return t&&t._msPortalFxV2ShellApi&&t._msPortalFxV2ShellApi().onPin}))},t.prototype.getAssetInstanceMetadataAsync=function(){var n=this;return this.awaitComposed().then((function(){var i=n.bladeDefinition,t;return vr(i)&&!n.isDisabled&&!n.isDisposed()&&(t=pr(i,n._shellViewModel,n.locator.toString()),t.exists)?{id:t.value,type:n.assetType}:undefined}))},u.defineProperty(t.prototype,"assetType",{get:function(){var n=this.bladeDefinition;return n&&n.assetType},enumerable:!0,configurable:!0}),t.prototype.offRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].remove(n)}))},t.prototype.onRebind=function(n,t,i){var r=this;[n,t,i].forEach((function(n,t){n&&r._callbacks[t].add(n)}))},t.prototype.save=function(t){this._composing||this._rebinding||yr(this.widget)||!this.masterContainer||n.prototype.save.call(this,t)},t.prototype.rebindAsync=function(n){var t=this;this._rebindStartTime=Date.now();this._endTraceWithState(vt.BladeRebind,wt.Cancel);this._updateRebindSequenceNumber();kt.provideContext((function(){t._creationState=kt.getState()}),bi.Blade,ir(this));this._bladeStartTelemetry(vt.BladeRebind,ut.tryGetAssetType(n));var e=this.widget,u=e&&e.element.findByClassName("fxs-blade-content")[0],r=u&&o(u).find(".fxs-part:first")[0];r&&(y.FocusHandler.Instance.registerContainerForFocus(u),y.FocusHandler.Instance.registerTargetForFocus(r));this.containerWidget.resetInternalState();var f=this.services.desktop,i,h=ut.deepSubset(this._shellViewModel,n),s=function(n){oi(t,"Rebind COMPLETED.");t._rebinding=!1;t.save();o(f).trigger(rt.DesktopManagerEvents.bladeRebound,{id:t.id});t.widget.options.loaded(!0);f.commandsEnabled(!0);d.toggleTemporarilyDisabledCommands(!1);r&&y.FocusHandler.Instance.notifyTargetReadyForFocus(r);t._endTraceWithState(vt.BladeRebind,n)};return oi(this,"Rebind STARTED.",n),this._rebindValidationPromise=null,this._waitToRebindPromise=null,h?(oi(this,"Updated properties are empty or are equal to the current blade properties. Aborting rebind.",n),this.rebindThrottler.rejectPendingPromise(),s(wt.Cancel),i=Q({})):(this._rebinding=!0,this._hasPermissionsDeferred=Q.defer(),this._autoOpenSettingsDisabled=this._useDetailContent,this.bladeDefinition&&!this.bladeDefinition.locked&&this.widget.options.loaded(!1),d.toggleTemporarilyDisabledCommands(!0),f.commandsEnabled(!1),i=this._waitToRebindPromise=this.rebindThrottler.throttle().then((function(){return t.isDisposed()?Q.reject(new di.CanceledError("Rebind Canceled. Blade is already disposed."+t)):i===t._waitToRebindPromise?(oi(t,"Rebind after throttle.",n),t._rebindAsync(n).finally((function(){i===t._waitToRebindPromise&&s(wt.Complete)}))):Q.reject(new di.CanceledError("Another rebind already started"))}))),i},t.prototype._bladeReadyEndTelemetry=function(n,t,i){this._endTraceWithState(vt.BladeReady,n,i);t&&(this.fullReadyTime=this._endTraceWithState(vt.BladeFullReady,n,i))},t.prototype._bladeRevealedEndTelemetry=function(n,t,i){this._endTraceWithState(vt.BladeRevealed,n,i);t&&this._endTraceWithState(vt.BladeFullRevealed,n,i)},t.prototype._bladeOpenEndTelemetry=function(n,t){this._endTraceWithState(vt.BladeOpened,n);t&&this._endTraceWithState(vt.BladeFullOpened,n)},t.prototype._endTraceWithState=function(n,t,i){var r=this,u=this._markers,f=function(){var s=u[n],l;if(s){var h=ni.endTrace(s,t,i),e="Menu"+n,f=r.masterContainer,c=f._markers;return r._useDetailContent&&e in c&&(delete c[e],l=Date.now()-(n==="BladeRebind"?f._rebindStartTime:f._readyStartTime),f.initialOnInputsSetPromise().finally((function(){kt.usingState((function(){var u=f.locator,s=r.locator,n=f._menu,c=n&&n.getResourceType()||f.assetType,a=n&&n.getTelemetryInfo()||{};ni.trace({name:gt(u),extension:wi(u),source:ui.Shell,action:e,actionModifier:t,data:o.extend({detailName:gt(s),detailExtension:r.extension&&r.extension.name,detailDuration:h,type:c},i||{},a),duration:l,journeyId:r._getTelemetryJourneyId()})}),r._masterBladeState)}))),delete u[n],h}};return this._creationState?kt.usingState(f,this._creationState):f()},t.prototype._bladeStartTelemetry=function(n,t,i){var o=this,s,h;this._bladeOpenEndTelemetry(wt.Cancel,!0);var r=this._perfData={includesExtensionLoadTime:!this.bladeDefinition},e=this.masterContainer,p=e&&e.locator,w=gt(p),b=e&&e.instanceId,c=e&&e.id,l=b||c,a=w||c;l&&(r.openedByBlade=l);a&&(r.openedByBladeName=a);or&&(r.preloadPartSettings=!0);i&&(i.autoOpenedByBlade&&(r.autoOpenedByBlade=i.autoOpenedByBlade),i.autoOpenedByPart&&(r.autoOpenedByPart=i.autoOpenedByPart));var v=this.extension,y=this.locator,u={telemetryData:r,extension:v&&v.name||wi(y),locator:gt(y),assetType:t},f=function(n,t){o._markers[n]=ni.startTrace({extension:t.extension,source:ui.Shell,action:n,data:t.telemetryData,name:t.locator,assetType:t.assetType,journeyId:o._getTelemetryJourneyId()});o._markers["Menu"+n]=""};n===vt.BladeLoaded&&(s=this.widget,h=s&&s.timer,h&&(r.delayTime=h()),f(vt.BladeFullOpened,u),f(vt.BladeFullReady,u),f(vt.BladeFullRevealed,u),f(vt.BladeOpened,u),f(vt.BladeReady,u),f(vt.BladeRevealed,u),this._readyStartTime=(new Date).getTime());f(n,u)},t.prototype._rebindAsync=function(n){var t=this,i=Q.defer(),r=this._rebindValidationPromise=bt((function(i){t.awaitComposed().then((function(){t._validateRebindProperties(n)?i.resolve():i.reject()}))})).promise(),u=function(i){cr(n,(function(n){lt.setModelValue(t._shellViewModel,n,i?i[n]:undefined)}));i&&(t._journeyPath=t._buildJourneyPath())};return this._useDetailContent||this.containerWidget.clearDetailContent({callback:function(){var n=t._menu;n&&n.setDefaultId({rebinding:!0})},setPlaceholderDetailContent:!!this.bladeDefinition.menuBlade&&!this.detailContainers.length}),r.fail((function(){i.reject()})).done((function(){var s=t._bindingsToExtensionViewModel&&t._bindingsToExtensionViewModel.properties.map((function(n){return n.compositionBindingDefinition})).filter((function(n){return!!n})),o,e,f;t._lastInputsSetDeferred.reject();t._lastInputsSetDeferred=Q.defer();o=(s||[]).filter((function(n){return!n.optional}));t._lastInputsSetProperties=lt.mapSourceModelToTargetModel(n,o,1,t+"");lu(t._bindingsToExtensionViewModel,t._shellViewModel,n)||t._lastInputsSetDeferred.resolve();try{t.isDisposed()?i.reject():r&&r!==t._rebindValidationPromise?i.reject():(oi(t,"Updating blade properties.",n),e=t._callbacks,e[0].fire(n),f=t._bindingResult()&&t._bindingResult().inputsWatcherConfig,f&&ht.CompositionBinder.turnOnInputsSetSuppressionOn(f),u(undefined),t._clearEditScopeId(),t.setInputsViewModel(t._shellViewModel),(t.bladeDefinition.optionalInputs||[]).forEach((function(n){t._shellViewModel[n](undefined)})),u(n),t._setEditScope(),f&&ht.CompositionBinder.turnOnInputsSetSuppressionOff(f),e[2].fire(n),t._lastInputsSetDeferred.promise.finally((function(){oi(t,"Inputs set promise completed.",n);t.save();e[1].fire(n);i.resolve()})),t.bladeDefinition.viewModelInputs||t._hasPermissionsDeferred.resolve())}catch(h){i.reject(h)}})),i.promise},t.prototype.onDetailContainersChanged=function(){var n=this;this.services.finder.locateAsync(this.locator).then((function(t){n._widgetsCreated&&n._initWidgetFromDefinition(t)}))},t.prototype._compose=function(n,t,i){var r=this;if(!this.isComposed&&!this._composing){if(this._composing=!0,this._loadingHandle=p.read(si.bladeLoading,1,"blade"),this._bladeStartTelemetry(vt.BladeLoaded,i&&i.assetType,i),this._compositionDeferred.then((function(){t.resolve();yr(r.widget)||r._setupCommandBarAndContextMenu();r.compositionTime=r._endTraceWithState(vt.BladeLoaded,wt.Complete)}),(function(){t.reject();r._endTraceWithState(vt.BladeLoaded,wt.Cancel)})),this.unrecoverableErrorMessage){this._composeErrorBlade(n,i,ri.ErrorUnrecoverable,this.unrecoverableErrorMessage);return}var f=this.services.finder,e=this.bladeDefinition?o.Deferred().resolve(this.bladeDefinition).promise():ft.QtoJ(f.locateAsync(this.locator)),s=this.extension?o.Deferred().resolve(this.extension).promise():ft.QtoJ(f.locateAsync(pi(this.locator))),u=this.masterContainer;u&&u.bladeDefinition&&u.bladeDefinition.menuBlade&&!u.containerWidget.isMenuBladeLoadingDetailBlade()||this._loadingSignalToTopBar(n.element);e.then((function(t){return r.bladeDefinition=t,r.isDisposed()||(r._initWidgets(t,n,i),r._showLoadingIndicator()),s.then((function(u){if(r.extension=u,!r.isDisposed()){var f=r._validateDefinition(t);f?(r.bindings=r.bindings.concat(ht.CompositionBinder.mapInputBindingDefinitions(t.bindings,r,(function(n){n.source.scope===lt.ReferenceScope.CurrentContainer&&(n.autoRebindWhenSourceDisposes=!0)}))),r._createChildrenFromDefinition(t),r.save(),r._initialized=!0,r._composeBlade(u,t)):r._composeErrorBlade(n,i,ri.ErrorInitializing,"Unable to initialize blade from definition.")}})).catch((function(t){var u=ri.ErrorLoadingExtensionAndDefinition;s.state()!=="rejected"&&(u=ri.ErrorLoadingDefinition);r._composeErrorBlade(n,i,u,t)}))})).catch((function(t){var u=ri.ErrorLoadingExtensionAndDefinition;e.state()!=="rejected"&&(u=ri.ErrorLoadingExtension);r._composeErrorBlade(n,i,u,t)})).finally((function(){r._loadedSignalToTopBar()}))}},t.prototype._loadedSignalToTopBar=function(){this._loadingHintDisposer&&(this._loadingHintDisposer(),this._loadingHintDisposer=null)},t.prototype._loadingSignalToTopBar=function(n){var t=this;this._loadedSignalToTopBar();this._loadingHintDisposer=function(){n.trigger(h.default.fxloadingontopbar,{id:t.id,cancel:!0})};n.trigger(h.default.fxloadingontopbar,{id:this.id,cancel:!1})},t.prototype._showLoadingIndicator=function(){var n=this;this.widget.options.loaded(!1);this._hasPermissionsDeferred=Q.defer();Q.allSettled([this._hasPermissionsDeferred.promise,this._compositionDeferred.promise()]).finally((function(){n.widget.options.loaded(!0);n._widgetReadyToDisplayAwaiter.resolve()}))},t.prototype._rejectPermissionsPromise=function(){this._hasPermissionsDeferred?this._hasPermissionsDeferred.reject():this.widget&&this.widget.options.loaded(!0)},t.prototype._validateRebindProperties=function(n){var t="",i=this.bladeDefinition.templateKeyInputs||[];return i.some((function(t){return!n.hasOwnProperty(t)}))?t="Properties to rebind must include all blade inputs marked as keys.":i.some((function(t){return ai(n[t])}))&&(t="Properties to rebind cannot be of Array type."),t&&pt.error("[Blade Rebind] "+t+" Rebind properties:'"+yi(n)+"', Blade keys:'"+yi(i)+"'."),!t},t.prototype._summaryCollapsed=function(){var s=this,u=!1,f,n,t,e,o=this.services,i=bt();return(this.bladeDefinition.lenses||[]).some((function(i){return f=s.locator.withLens(i.name),n=o.finder.locate(f),n&&n.isSummary&&n.partInstances&&(u=!0,t=n.partInstances[0],e=f.withPartInstance(t.name)),u})),u?o.sharedSettings.querySetting(2,"[PartIdentityState]-"+e.toString()).then((function(n){return n?r.fromSerializableObject(n):null}),(function(){return null})).then((function(n){n&&n.content&&n.content.collapsed!==undefined?i.resolve(!!n.content.collapsed):t.inline&&t.inline.options?i.resolve(!!t.inline.options.collapsed):i.resolve(null)})):i.resolve(!0),i.promise()},t.prototype._checkIfOpenedByReferrer=function(n,t){var i=dr.ReferrerInfo,r=n.indexOf(i)>-1,u=ti(t[i])!==undefined;return r&&u},t.prototype._composeBlade=function(n,t){var i=this,u,r;or&&this._summaryCollapsed();!t.assetType||this.containerWidget.options.associatedWithAsset(!0);u=this.services.desktop;r=this._journey=u.getActiveJourney();this._setupViewModel();t.editScopeType&&r&&r.observeEditScopeChanges(this,{editScopeId:this.editScopeId,ownerType:this.locator.type,ownerLocatable:this,disposeOnSelectionChange:!1});this._isOpenedByReferrer(this._checkIfOpenedByReferrer(t.optionalInputs||[],this._shellViewModel));this._setupInputBindings();this._setupExtensionViewModel();this._setupUnauthorizedListener();this._setupPreviewListener(n,t);this._trackAssetIdChange();this._waitForNoticeIfAny(t.waitForInputsSet).then((function(n){n&&i._composeAndRestoreLayout().then((function(){i.detailContainers.forEach((function(n){n.notifyContainer(i)}));i.masterContainer&&i.masterContainer.notifyContainer(i);hu(i,i.extension,t);i.save();i.actionBar?i.actionBar.awaitComposed().then((function(){i._compositionDeferred.resolve()})):i._compositionDeferred.resolve()}),(function(){i._compositionDeferred.reject()}))}));this.onRebind();this.containerWidget.bladeDefinitionLoaded=!0;this.containerWidget.trigger(h.default.fxbladerepos)},t.prototype._waitForNoticeIfAny=function(n){var t=this;return n?this.awaitOnInputsSetComplete().then((function(){if(ei(t._extensionViewModel))return!1;var n=vi(t._extensionViewModel.container._msPortalFxNotice),i=ei(n);return i||(t._renderNotice(n),t._compositionDeferred.resolve()),i})):bt().resolve(!0).promise()},t.prototype._buildJourneyPath=function(){var r=this,n=this.masterContainer,u=n&&n.journeyPath||[],t={model:{}};return(this.masterInputKeys||[]).forEach((function(n){t.model[n]=ti(r._shellViewModel[n])})),u.concat([ot.getBladeOpenerJourneyPathSegment(this),i.toSortedString(t),this.locator.toString(),])},t.prototype._initWidgets=function(n,t,r){var nt,rt,p,ft;r=r||{};var u,f,s=null,h=null,l=this.masterContainer,c=l&&l.containerWidget,ot=c&&c.options,a=l&&l.bladeDefinition,w=this._useDetailContent||!!(a&&a.menuBlade),st=n.style===12,d=!!n.menuBlade,g=(this.flags&16)!=0,e=this._useDetailContent=w&&ar(n)||g,ht=w&&!e;if(this._autoOpenSettingsDisabled=e,(g||e)&&(h=new k.ViewModel(this.id),h.displayState=c.options.displayState,h.applyViewSettings(this.widgetState()),u=c,u.options.isMenuBlade(!0),i.isFeatureEnabled("pinnable_default_off")&&(u.options.pinEnabled(!1),u.options.pinVisible(!1))),g?f=u.openBladeInPlace(this,h):e?f=u.setDetailContent(h):(s=new b.ViewModel(this.id,this.widgetState(),{name:this.locator.name,extensionName:this.locator.getExtensionLocator().name}),s.asSubJourney=(this.flags&8)!=0,u=new b.Widget(o("<section/>"),s),f=u.getContentWidget(),r.index>=0?t.insertChild(u,r.index):t.addChild(u)),this._widgetsCreated=!0,this.containerWidget=u,this.widget=f,nt=this.services.desktop.getActiveJourney(),nt){var ct=nt.blades,tt=ct[ct.length-2],v=tt&&tt.masterContainer,lt=v&&v.containerWidget,it=lt&&lt.options,at=v&&v.bladeDefinition,vt=at&&at.menuBlade,yt=vt&&ar(tt.bladeDefinition)&&!it.useActivationStyle,pt=ot&&ot.fullWidthExtensionOptOut,wt=it&&it.fullWidthExtensionOptOut;(!pt&&ht||!wt&&yt)&&s&&(s.asSubJourney=!0)}f.options.isV2Blade(rr(n));e?f.element.data(ut.CompositionInstanceDataName,this):u.element.data(ut.CompositionInstanceDataName,this);this._attachEventHandlers(u,f,e,ht,w,c);this.widgetState(f.saveViewSettings());rt=u.options.fullWidthExtensionOptOut=!i.isFeatureEnabled("noextensionoptout")&&wi(this.locator).toLowerCase()in i.getEnvironmentValue("fullWidthOptOutExtensions");st&&f.options.bladeStyle(12);p=st;p||(p=(e||d)&&!rt);ft=p?2:n.initialDisplayState;u.options.maximizeOrRestoreEnabled(ft!==2);et.applyDisplayState(n,u.options.displayState,e,a&&a.initialDisplayState,ft,rt);this._initContainerWidgetFromDefinition(n,u.options);this._initWidgetFromDefinition(n);e&&n.initialDisplayState===1&&f.setContentWidth();u.options.showBladeIcon(!!n.assetType);f.initializeLayout();u.initializeLayout({setPlaceholderDetailContent:d&&!this.detailContainers.length,callback:function(n){d&&n.addClass(eu)}});y.FocusHandler.Instance.registerContainerForFocus(f.element.findByClassName("fxs-blade-content")[0]);f.options.locked(n.locked||!1)},t.prototype._initContainerWidgetFromDefinition=function(){var i=this._useDetailContent,n=this.masterContainer,t=n&&n.bladeDefinition;t&&t.menuBlade&&!i&&n.containerWidget.options.displayState(1)},t.prototype._initWidgetFromDefinition=function(n){var r=ei(n.width)?1:n.width,t,i;if(this.containerWidget.options.useActivationStyle=!!n.activationStyle,t=this.widget.options,t.bladeWidth(r),t.bladeStyle(n.style),this.flags&1){t.displayState(1);this.containerWidget.setContextPaneWidth(n.contextPaneWidth);i=void 0;switch(n.style){case 12:i=12;break;case 6:case 8:case 4:case 3:case 9:case 10:i=4;break;default:i=7}t.bladeStyle(i)}t.displayState()!==2&&this._widgetReadyToDisplayAwaiter.resolve()},t.prototype._composeErrorBlade=function(n,t,i,r){var f=this.locator,a=this.bladeDefinition||{name:f.name,lenses:[],locked:!0},e,o,u,s,c,l;this._widgetsCreated||this._initWidgets(a,n,t);e=this.containerWidget;o=e.options;o.locked(!0);o.titleImageUri(undefined);u=this.widget.options;br(u);u.title(li.error);u.disabled(!0);s=f&&f.name;u.disabledMessageTitle(s&&li.errorTitleFormat.format(s));c=f&&pi(f);l=c&&kr.getWindowId(c);u.disabledMessageSubtitle(l);nr(e,u,a);ni.trace({extension:l,source:ui.Shell,action:vt.BladeLoadErrored,actionModifier:ri[i],name:gt(f),data:{details:r},journeyId:this._getTelemetryJourneyId()});this._compositionDeferred.reject();this._rejectPermissionsPromise();pt.error("Blade '"+this+"' has been turned to error mode. Details: "+(r||"N/A"));this._loadingHandle&&(this._loadingHandle(),this._loadingHandle=null);this._loadingErrHandle=p.read(si.bladeError.format(this.title()||si.unknown),1,"blade");e.bladeDefinitionLoaded=!0;e.trigger(h.default.fxbladerepos)},t.prototype.disableForAssetDeleted=function(n,t){var e,r,u,f,o,i;if(this._useDetailContent){this.masterContainer.disableForAssetDeleted(n,t);return}if(e="Blade "+this+" "+(n?"closed":"disabled")+" because asset deleted. Reason: "+t,n)pt.warning(e),this.services.desktop.forceCloseBlade(this.id);else{for(this._disabled=!0,this._releaseResources(),r=this.children.length-1;r>=0;r--)this.removeChild(this.children[r]);u=this.containerWidget;f=u&&u.options;f&&(o=fi.deletedTitle,f.disabled(!0),f.titleImageUri(undefined),i=this.widget.options,br(i),i.title(o),i.disabledMessageTitle(o),i.disabledMessageSubtitle(fi.deletedSubTitle),nr(u,i,this.bladeDefinition));this.bindings=[];this._compositionDeferred.reject();this._rejectPermissionsPromise();pt.warning(e)}this.save()},t.prototype.resetLayout=function(n){var t=this;return Q(this.awaitComposed()).then((function(){var i=t.detailContainers[0],r,u,f,e;return i&&i._useDetailContent?i.resetLayout(n):(r=t.services,u=r.desktop,n?f=Q(6):(e=new s.MessageBox(li.resetConfirmationTitle,li.resetConfirmationText,4),f=r.getService("DialogManager").then((function(n){return n.showDialog(o(t.widget.getForm()),e,t.locator)}))),f.then((function(n){var i,r;if(n===6){if(i=u.discardEditsOfBlade(t,{includeSelf:!0,includeDescendants:!0,force:!0}),!i.successful){pt.error("Unexpectedly failed to discard changes on the blade with id: '"+t.id+"'");return}if(r=u.closeChildBlades(t),!r.successful){pt.error("Unexpectedly failed to close child blades of the blade with id: '"+t.id+"'");return}t.widget.options.loaded(!1);t.children.forEach((function(n){n.children.forEach((function(n){n.clearIdentitySettings()}))}));t.removeChildren();t._createChildrenFromDefinition(t.bladeDefinition);t._removeRedirectParts();t._composeChildren();t.save();t.widget.options.loaded(!0)}})))}))},t.prototype._setupCommandBarAndContextMenu=function(){var n=this.widget.options,i=this.bladeDefinition,t;lr(this._commandBarLifetime);t=this._commandBarLifetime=this.createChildLifetime();nt.create(t,this,this.services,this._shellViewModel);this._composeShellCommands(n.contextMenu.menuItems,i.locked,n.displayState);t.registerForDispose((function(){n.commandBar.menuItems([]);n.contextMenu.menuItems([])}))},t.prototype._setupInputBindings=function(){var n=this;ht.CompositionBinder.setupPropertyBindings(this,this.getInputPropertyBindings(),this.bindings);this.getInputPropertyBindings().addPropertyChangedHandler((function(){n.save()}))},t.prototype.getComposedParts=function(){return this._partAwaiter.resolvedCompositions},t.prototype.getParts=function(){return i.mapMany(this.children,(function(n){return n.children}))},t.prototype.getInputPropertyBindings=function(){return this._inputPropertyBindings||(this._inputPropertyBindings=new lt.PropertyBindings(this+"",this._shellViewModel)),this._inputPropertyBindings},t.prototype.awaitComposedPart=function(n,t){return this._partAwaiter.await(n,t)},t.prototype.notifyPartComposed=function(n){this._partAwaiter.resolve(n)},t.prototype.awaitWidgetReadyToDisplay=function(){return this._widgetReadyToDisplayAwaiter.promise()},t.prototype.getWaitingCompositions=function(){return this._partAwaiter.waitingCompositions},t.prototype.awaitOnInputsSetComplete=function(){return this._lastInputsSetDeferred.promise},t.prototype.dispose=function(t){var r=this,u=this.locator,f=this.extension,i=vt.BladeClosed;cr(this._markers,(function(n,t){t&&r._endTraceWithState(n,wt.Cancel)}));this._markers[i]=ni.startTrace({extension:f&&f.name||wi(u),source:ui.Shell,action:i,name:gt(u),journeyId:this._getTelemetryJourneyId()});this._releaseResources(t);this.masterContainer&&!this.masterContainer.isDisposed()&&this.masterPartId&&this.masterContainer.awaitComposedPart(null,ut.getIdMatchFunc(this.masterPartId)).done((function(n){n.notifyDetailBladeClosed(r)}));n.prototype.dispose.call(this,t);this._endTraceWithState(i,wt.Complete);[this._loadingHandle,this._loadedHandle,this._loadingErrHandle].forEach((function(n){return n&&n()}));this._loadingHandle=this._loadedHandle=this._loadingErrHandle=null;p.read(si.bladeClosed.format(this.title()||""),1,"blade");this._loadedSignalToTopBar()},t.prototype._releaseResources=function(n){lr(this._disposablesEvents);this._disposablesEvents=[];[this._inputPropertyBindings,this._bindingsToBladeWidgetModel,this._bindingsToExtensionViewModel].forEach((function(n){n&&(n.unbind(),n=null)}));n||this._disposeEditScopes();this._extensionViewModel&&this.extension&&(i.disposeViewModelProperties(this._extensionViewModel),this.extension.releaseViewModel(this._extensionViewModel),this._extensionViewModel=null);this._callbacks.forEach((function(n){n.empty()}));this._journey=null},t.prototype.awaitContainer=function(n,t){return this._containerAwaiter.await(n,t)},t.prototype.onInvocationStarted=function(){this._autoOpenSettingsDisabled=!0},t.prototype.notifyContainer=function(n){this._containerAwaiter.resolve(n)},t.prototype.getDiagnosticsData=function(){return o.extend(n.prototype.getDiagnosticsData.call(this),{title:hi(this.title),detailBlades:this.detailContainers.map((function(n){return n.id})),bindings:ht.CompositionBinder.mapBindingsToFriendlyObjects(this.bindings)})},t.prototype.getAssetId=function(){var i=this;if(!this.bladeDefinition||!this.bladeDefinition.assetIdInputProperty)return Q.reject();var r=function(n){var t=i._tryGetAssetIdFromBinding();t&&t.exists?n.resolve(ti(t.value)):n.reject()},n=this._bindingResult,u=function(t){n().allInputsSet()?r(t):n().allInputsSet.subscribe(i,(function(n){n&&!t.promise.isFulfilled()&&r(t)}))},t=Q.defer();return n()?u(t):n.subscribe(this,(function(n){n&&!t.promise.isFulfilled()&&u(t)})),t.promise},t.prototype.setViewModelForTemplateOrMenuBlade=function(n){this._bladeViewModelDeferred.resolve(n)},t.prototype.setInputsSetPromise=function(n){var t=this;n.finally((function(){t._initialOnInputsSetDeferred.resolve();t._lastInputsSetDeferred.resolve()}))},t.prototype._trackAssetIdChange=function(){var n=this,t;this.bladeDefinition.menuBlade?(t=this.children.mapMany((function(n){return n.children})).first(),dt(this,(function(){n.assetId(t.assetId())}))):this.bladeDefinition.templateBlade?dt(this,(function(){var t=pr(n.bladeDefinition,n._shellViewModel,n.locator.toString());t.exists&&n.assetId(t.value)})):dt(this,(function(){var i=n._bindingResult(),t;i&&i.allInputsSet()&&(t=n._tryGetAssetIdFromBinding(),t&&t.exists&&n.assetId(ti(t.value)))}))},t.prototype._tryGetAssetIdFromBinding=function(){var t=this,n=this._bindingResult().propertyBindings.properties.first((function(n){return n.targetProperty===t.bladeDefinition.assetIdInputProperty}));return n?lt.getModelValue(n.sourceModel,n.sourceProperty):null},t.prototype._setupViewModel=function(){var n=this;(this.bladeDefinition.outputs||[]).forEach((function(t){n._shellViewModel.hasOwnProperty(t)||(n._shellViewModel[t]=yt(undefined))}));this._setEditScope()},t.prototype._setEditScope=function(){if(this.bladeDefinition.editScopeType){var n=this._journey&&this._journey.ambientSettings.getItem(this.journeyPath);if(n&&n.value&&n.value.editScope)this.editScopeId(n.value.editScope.editScopeId);else{this.editScopeId(i.getUniqueId());this.services.diContainer.get(w.EditScopeManager).onEditScopeCreated(this.editScopeId())}this._shellViewModel[ut.EditScopeIdPropertyName]||(this._shellViewModel[ut.EditScopeIdPropertyName]=yt());this._shellViewModel[ut.EditScopeIdPropertyName](this.editScopeId())}},t.prototype._updateForHasPermissions=function(n){var t=this;return this._extensionViewModelPromise.then((function(){var r,i;t.isDisposed()?pt.warning("Blade '"+t.locator.toString()+"' disposed when checking permissions."):(r=t._extensionViewModel.container,n?(r.unauthorizedMessage(null),t._hasPermissionsDeferred.resolve()):(i=r.unauthorized(),i&&i.finally?i.finally((function(){t._hasPermissionsDeferred.reject()})):t._hasPermissionsDeferred.reject()))}))},t.prototype._setupExtensionViewModel=function(){var n=this,h=this.widget,f,r,u=this.bladeDefinition,s=!!u.templateBlade||!!u.menuBlade||!!u.frameBlade,l=function(t){return f=n._createBindViewModelConfiguration(t),r=ht.CompositionBinder.createBindViewModelResult(f)};if(u.viewModelName||s){var a=bt().resolve(this.extension).promise(),t=this+"-["+u.viewModelName+"]",o=u.viewModelInputs;this._extensionViewModelPromise=a.then((function(i){var f;return o?(l(t),f=r.inputsWatcherConfig?ft.QtoJ(ht.CompositionBinder.loadOnInputsSetParameters(r.inputsWatcherConfig)):bt().resolve(null).promise()):f=bt().resolve(null).promise(),f.then((function(t){o&&(n._earlyOnInputsSet=!!t);var f=kt.provideContext((function(){return n._creationState=kt.getState(),s?n._bladeViewModelDeferred.promise():ft.QtoJ(i.getViewModel(u.viewModelName,{onInputsSetParameters:t}))}),bi.Blade,ir(n));return(kt.provideContext((function(){n._masterBladeState=kt.getState()}),bi.Blade,n.masterContainer?ir(n.masterContainer):null),t)?f.then((function(n){return ht.CompositionBinder.notifyOnInputsSetCalled(r.inputsWatcherConfig,t,n.onInputsSetPromise),n})):f}))})).done((function(h){var g=n+"-[WidgetModel]",a=h.content,w,d,y;if(n._extensionViewModel=h,n.isDisposed())n._releaseResources();else if(!n.isDisabled){dt(n,(function(){var t=h.container.notFoundMessage();i.isNullOrWhiteSpace(t)||n._renderNotice({noticeTitle:t,noticeImageType:3,bladeTitle:c.Container.notFound,bladeSubtitle:"",shouldDisableBlade:!0})}));o||s||(n._initialOnInputsSetDeferred.resolve(),n._lastInputsSetDeferred.resolve());o?(f||l(t),f.bindableTarget.viewModel=h,r.inputsWatcherConfig&&ht.CompositionBinder.setupAllInputsSetWatcherFromExtendedConfig(r.inputsWatcherConfig),n._bindingsToExtensionViewModel=r.propertyBindings,n._bindingResult(r)):n._hasPermissionsDeferred.resolve();var nt=n.containerWidget.options,v=n.widget.options,p=n._bindingsToBladeWidgetModel=new lt.PropertyBindings(g,{title:v.title,subtitle:v.subtitle,titleSuffix:v.titleSuffix,subtitleSuffix:v.subtitleSuffix,description:v.description,helpUri:v.helpUri,icon:v.icon,titleImageUri:nt.titleImageUri,contentState:v.contentState,contentStateDisplayText:v.contentStateDisplayText});dt(n,(function(){v.shieldType(n.shieldType())}));dt(n,(function(){v.isUiBlocked(n.uiBlockers().some((function(n){return n()})))}));h.container.helpContentUri.subscribeAndRun(n,n.helpContentUri);w=void 0;d=void 0;rr(u)?(w=cu(n,a),d=null):(w=a,d=k.defaultSvg);y=b.widgetProperties;ii(p,t,a,y.title,n.title,b.getDefaultTitle(n.locator.name));ii(p,t,a,y.subtitle,n.subtitle,"");ii(p,t,a,y.titleSuffix,n.titleSuffix,"","titleSuffix",!0);ii(p,t,a,y.subtitleSuffix,n.subtitleSuffix,"","subtitleSuffix",!0);ii(p,t,a,y.description,n.description,"");ii(p,t,a,y.helpUri,n.helpUri,"");ii(p,t,w,y.icon,n.icon,d);ii(p,t,a,y.titleImageUri,n.titleImageUri,undefined);a.statusBar?n._onStatusBarClick=au(n,a.statusBar,n.widget.options,n._isOpenedByReferrer):(ii(p,t,a,y.contentState,e.observable(0),0),ii(p,t,a,y.contentStateDisplayText,e.observable(""),""));dt(n,(function(){var n=v.icon(),t=rr(u)?!n:i.deepEquals(n,k.defaultSvg);v.hasIcon(!t)}))}})).fail((function(t){pt.error("Unable to get extension view model for blade '"+n.locator.toString()+"'. Error: "+t);h.options.title(b.getDefaultTitle(n.locator.name));n._hasPermissionsDeferred.resolve()}))}else h.options.title(b.getDefaultTitle(this.locator.name)),this._initialOnInputsSetDeferred.resolve(),this._hasPermissionsDeferred.resolve()},t.prototype._createBindViewModelConfiguration=function(n){var t=this;return{bindableTarget:{viewModelName:n},inputs:this.bladeDefinition.viewModelInputs,referenceComposition:this,inputsSetCalled:function(n,i){i.finally((function(){(o.isEmptyObject(t._lastInputsSetProperties)||ut.deepSubset(n,t._lastInputsSetProperties))&&t._lastInputsSetDeferred.resolve();t._initialOnInputsSetDeferred.resolve()}))},customInputBindingValidator:function(n){if(n.valuesFrom[0].referenceType!==1&&n.valuesFrom[0].referenceType!==5&&!n.optional)return"Blade view model binding can only use 'BladeInput' and 'Constant' reference types."},beforeViewModelPropertyUpdate:function(n){var i=t.bladeDefinition,r;return((i.optionalInputs||[]).forEach((function(t){n[t]===undefined&&delete n[t]})),i.permissions&&!i.templateBlade)?(r=t.locator.toString(),at.checkPermissions(i.permissions,tu.All,n,i.assetType,t.extension.name,t.services,r).then((function(n){return t._updateForHasPermissions(n).then(null,(function(n){pt.error(n)})),n}))):(t._hasPermissionsDeferred.resolve(),Q(!0))}}},t.prototype._setupUnauthorizedListener=function(){var n=this,t=this._extensionViewModelPromise;t&&t.done((function(t){var r=t.container;r.unauthorizedMessage.subscribeAndRun(n,(function(t){if(!ei(t)){var u=n.widget.options,e=u.title()||fi.unauthorizedMessage,o=u.subtitle(),f=i.isObject(t),r=f?t:{},s=!f&&t!==i.Resources.Strings.ViewModels.Container.unauthorizedText?t:r.noticeDescription||fi.unauthorizedDescription;n._renderNotice({noticeHeader:r.noticeHeader||fi.unauthorizedHeader,noticeTitle:r.noticeTitle||fi.unauthorizedMessage,noticeDescription:s,noticeCallToActionText:r.noticeCallToActionText||"",noticeCallToActionUri:r.noticeCallToActionUri||"",noticeImageType:3,bladeTitle:e,bladeSubtitle:o,shouldDisableBlade:!0})}}))}))},t.prototype._setupPreviewListener=function(n,t){var r=this,i=this.containerWidget.options;n.isPreview()?i.showPreviewTag(!0):t.assetType?this.services.assetTypeService.getAssetTypePromise(n.name,t.assetType).then((function(n){i.showPreviewTag(n.isPreview)})):this._extensionViewModelPromise&&this._extensionViewModelPromise.then((function(n){var t=n.container;t.preview.subscribe(r,i.showPreviewTag);i.showPreviewTag(t.preview())}))},t.prototype._renderNotice=function(n){var r,u,f,t,i;if(!this.bladeDefinition.templateBlade)for(r=this.children.length-1;r>=0;r--)this.removeChild(this.children[r]);u=this.containerWidget;f=u&&u.options;f&&(t=this.widget.options,t.contentState(0),t.contentStateDisplayText(""),n.bladeTitle!==undefined&&t.title(n.bladeTitle),n.bladeSubtitle!==undefined&&t.subtitle(n.bladeSubtitle),t.titleSuffix(""),t.subtitleSuffix(""),nr(u,t,this.bladeDefinition),i=new ru(this.widget.ltm),i.header(n.noticeHeader),i.title(n.noticeTitle),i.description(n.noticeDescription),i.imageType(n.noticeImageType),i.callToActionText(n.noticeCallToActionText),i.callToActionUri(n.noticeCallToActionUri),t.unauthorizedNoticeVm(i));n.shouldDisableBlade&&(this._disabled=!0,this.bindings=[],this._releaseResources());this._compositionDeferred.resolve()},t.prototype._disposeEditScopes=function(){var r=this,i=this.editScopeId(),n,t;if(i)this.services.diContainer.get(w.EditScopeManager).onEditScopeDisposed(i);n=this._journey;n&&(t=this.journeyPath,n.ambientSettings.getItemsInPath(t).forEach((function(n){if(n.value&&n.value.editScope)r.services.diContainer.get(w.EditScopeManager).onEditScopeDisposed(n.value.editScope.editScopeId)})),n.ambientSettings.removeItemsInPath(t))},t.prototype._clearEditScopeId=function(){if(this.bladeDefinition.editScopeType){var n=this.editScopeId(),t=n&&this.services.diContainer.get(w.EditScopeManager).getStateObservable(n);if(t&&t()===0)this.services.diContainer.get(w.EditScopeManager).onEditScopeDisposed(n);this.editScopeId(undefined);this._shellViewModel[ut.EditScopeIdPropertyName](undefined)}},t.prototype._createChildrenFromDefinition=function(n){var i=this,t;n.lenses&&(t=[],n.lenses.forEach((function(n){var u=i.locator.withLens(n.name),r=ct.create(i.services,u);n.isSummary?t.unshift(r):t.push(r)})),this.addChildren(t))},t.prototype._removeRedirectParts=function(){var n=this,t=this.children.filter((function(t){var i=t.children.filter((function(t){var i={},r=n.services.finder.tryLocate(t.locator,i),u=i.value;return r&&!!u.redirectMode})),r=t.children.length&&i.length===t.children.length;return i.forEach((function(n){t.removeChild(n)})),r}));t.forEach((function(t){n.removeChild(t)}))},t.prototype._composeChildren=function(n){var t=this;n===void 0&&(n=this.children);var r=[],f=[],i=[],e=[],u=[],s=[],c=[],h=this._summaryCollapsed();n&&n.length&&n.forEach((function(o,l){var a=Q.defer(),y=a.promise,v=!l;v?n[l].awaitChildrenAboveTheFoldOnInputsSetsResolved().finally((function(){a.resolve()})):n[l-1].awaitChildrenOnInputsSetsResolved().finally((function(){a.resolve()}));ci.setTimeout(a.resolve,12e3);c.push(a);h.then((function(n){t._bladeSummaryCollapsed=n;o.compose(t.widget,{delayLoadPromise:y,noDelayOnFirstPart:v,delayLoad:function(){return!1}});r.push(o.awaitComposed());i.push(o.awaitOnInputsSetComplete());u.push(o.awaitContentRevealed());o.children.concat([o]).forEach((function(n){r.push(n.awaitComposed());i.push(n.awaitOnInputsSetComplete());u.push(n.awaitContentRevealed());n.getLoadDelayed()||(f.push(n.awaitComposed()),e.push(n.awaitOnInputsSetComplete()),s.push(n.awaitContentRevealed()))}))}))}));h.finally((function(){var l=function(n,i){return o.when.apply(o,n).then((function(){t._bladeOpenEndTelemetry(wt.Complete,i)}))},n=function(n,i,r,u){Q.allSettled(n).then((function(n){t._traceBladeComplete(i,n,r,u)}))},h,c;l(f,!1);l(r,!0).finally((function(){t._composing=!1;t.save()}));h=t._bladeReadyEndTelemetry;n(e,!1,h);n(i,!0,h);Q.all(i).then((function(){t._loadingHandle&&(t._loadingHandle(),t._loadingHandle=null);t._loadedHandle=p.read(si.bladeReady.format(t.title()||""),1,"blade")}));c=t._bladeRevealedEndTelemetry;n(s,!1,c,!0);n(u,!0,c,!0)}))},t.prototype.getPerfData=function(){return i.extend2(this._perfData,this._menu&&this._menu.getTelemetryInfo())},t.prototype._traceBladeComplete=function(n,t,i,r){this._initializeTelemetryDetails(t,r);var u=this._perfData;i.call(this,u.rejectedPromises?wt.Cancel:wt.Complete,n,u)},t.prototype._initializeTelemetryDetails=function(n,t){var u=n.filter((function(n){return n.state==="rejected"})),i=this._perfData,r;t&&(i.anyPartContentRevealedCalled=n.some((function(n){return!!n.value})));i.lockedBlade=!!this.bladeDefinition.locked;i.useDetailContent=this._useDetailContent;r=0;this.bladeDefinition.style===12?r=4:this.bladeDefinition.templateBlade?r=1:this.bladeDefinition.frameBlade?r=2:!this.bladeDefinition.menuBlade||(r=3);i.bladeType=r;i.resource=location.hash.split("?")[0];u.length===0?i.earlyOnInputsSetBlade=this._earlyOnInputsSet:i.rejectedPromises=u.length},t.prototype._composeAndRestoreLayout=function(){var n=this,f=this.containerWidget,r,u,e,t;return this._removeRedirectParts(),this._composeChildren(),r=bt().resolve().promise(),u=this.bladeDefinition.actionBar,!this._rebinding&&u&&(e=this.locator.withBladeActionBar(u.name),t=bt(),r=t.promise(),i.tryImmediateResolve(i.require("MsPortalImpl/UI/Compositions/UI.Composition.BladeActionBar"),(function(i){var r=n.actionBar=i.create(n.services,e);r.parent=n;r.compose(n.widget);n.registerForDispose(n.actionBar);t.resolve()}),(function(n){t.reject(n)}))),f.options.displayState()===2&&f.refreshDisplayState(),r},t.prototype._getCommands=function(){if(!this.isComposed||!this.widget)throw new Error("Blade '"+this+"' needs to be composed before retrieving its commands.");return this.widget.options.commandBar.menuItems()},t.prototype._attachEventHandlers=function(n,t,r,u,f,e){var s=this,y=n.element,v=t.element,c=n.options,l;if(!r){v.on(h.default.fxregistermenu,(function(t,r){var e=s._defaultMenuItemId,l=s.masterContainer,h,u,f;!e&&l.getCompositionType()===ut.CompositionType.Startboard&&i.startsWith(s.masterInvocationProperty,"container.")&&(h=l.getComposedParts().first(ut.getIdMatchFunc(s.masterPartId)),e=h&&h.defaultMenuItemId);u=a.ActionModifier.Default;f=gt(s.locator);r.onItemClick((function(n,t){ni.trace({name:n,action:"MenuItemClick",actionModifier:u,source:ui.Blade,journeyId:s._getTelemetryJourneyId(),data:o.extend({blade:f,type:r.getResourceType()||s.assetType},t)})}));r.setDefaultId({recommendedId:s._defaultMenuItemId||e});r.onSearchMiss((function(n){kt.usingState((function(){ni.trace({name:f,action:"MenuBladeSearchMiss",actionModifier:u,source:ui.Blade,data:o.extend({blade:f,type:r.getResourceType()||s.assetType},n),journeyId:s._getTelemetryJourneyId()})}),s._creationState)}));s.initialOnInputsSetPromise().finally((function(){var n=r.getResourceType()||s.assetType;kt.usingState((function(){ni.trace({action:"MenuBladeInfo",actionModifier:u,source:ui.Blade,data:o.extend({blade:gt(s.locator),type:n},r.getTelemetryInfo()),journeyId:s._getTelemetryJourneyId()})}),s._creationState);n&&c.associatedWithAsset(!0)}));dt(s,(function(){n.options.titleSuffix(r.selectedItemText())}));s._menu=r}));c.close=function(){var t=s.services.desktop.tryCloseBlade(s.id,1),n,i;return t&&u&&(n=s.services.desktop.getActiveJourney().blades,i=n[n.length-1],i._menu.selectDefaultItem()),s._bladeOpenEndTelemetry(wt.Cancel,c.loaded()),t};c.pinblade=function(){l&&l.dispose();l=s.createChildLifetime();var t=new it.Pin(l,s.services);t.bind(new tt.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},s));t.execute(!1)};f&&e&&e.clearDetailContent({clearPlaceholderDetailContent:!0});c.maximizeOrRestore=function(t,i){var u=n.options.displayState(),r;if(!i||!i.forceMaximize||u!==2){switch(u){case 2:r=it.getDisplayStateCommand(1);break;case 1:r=it.getDisplayStateCommand(2)}r.activate();r.bind(new tt.CompositionInstanceCommandContext(n.element[0],function(){return Q(n.getContentWidget())},s));r.execute(!1)}}}t.options.commandBar.itemSelected=function(n,r){var u=r.item,e,o,f;u&&u.enabled()&&!u.unauthorized()&&(e=r.popupTarget,o=e?{getForm:function(){return e},showForm:i.noop,hideForm:i.noop}:t,u.bind(new tt.CompositionInstanceCommandContext(t.element[0],function(){return Q(o)},s)),u.execute(!1),f=r.item.commandDefinition,f&&f.details&&wr(s,(function(n){return n.masterCommandName===f.name})))};this._disposablesEvents.push(v.setEvents([g.Widget.viewSettingsChanged,function(n,t){s.widgetState(t);s.save(1);n.stopPropagation()},],[h.default.fxbladestatusbarclicked,function(){s._onStatusBarClick&&s._onStatusBarClick()},]),y.setEvents([h.default.fxensurebladevisible,function(n,t){wr(s,(function(n){return!n.masterCommandName&&n.masterPartId===t.masterPartId}))},],[h.default.fxsummarycollapsed,function(){return s._bladeSummaryCollapsed},]))},t.prototype._composeShellCommands=function(n,t,i){var e=[],o=this.services,r=this.containerWidget.options,u,f;this.isPinnable()&&(u=new it.Pin(this,o),r.pinVisible(!0),f=this.bladeDefinition,f&&f.hasOnPinMethod?this.getOnPinFunction().then((function(){u.activate();r.pinEnabled(!0)})):(u.activate(),r.pinEnabled(!0)));e.push(it.getDisplayStateCommand(1),new it.ResetLayout(this,t,i,o));hr.arrayPushAll(n,e)},t.prototype._validateDefinition=function(n){var u=this,t=!0,i=[],r="A blade cannot be the owner of an edit scope and also receive an edit scope id from an external source.";return n.assetType&&!n.assetIdInputProperty?(i.push("'assetIdInputProperty' is required if 'assetType' is defined on blade definition."),t=!1):ht.CompositionBinder.modelHasProperties(this+"",n.inputs,this.getViewModel())?n.inputs&&n.outputs&&(t=!n.inputs.some((function(t){var r=n.outputs.indexOf(t)>=0;return r&&i.push("Property '"+t+"' cannot be marked as input and output."),r}))):t=!1,t=t&&ht.CompositionBinder.validateInputBindings(this,n.bindings,i,(function(t){return t.valuesFrom[0].referenceType===1?"Blade bindings cannot reference BladeInputs.":ai(n.inputs)&&n.inputs.indexOf(t.property)>=0?"Blade bindings that target a blade input are not supported. Inputs: '"+hi(n.inputs)+"'. Bindings: '"+hi(n.bindings)+"'.":!!n.editScopeType&&t.property===ut.EditScopeIdPropertyName?"Declaring an 'editScopeType' and an input binding with '"+ut.EditScopeIdPropertyName+"' as a target property is not supported. "+r+" Bindings: "+yi(u.bindings):void 0})),t&&!!n.editScopeType&&ai(this.masterInputKeys)&&this.masterInputKeys.indexOf(ut.EditScopeIdPropertyName)>=0&&(t=!1,i.push("Declaring an 'editScopeType' and receiving an '"+ut.EditScopeIdPropertyName+"' from invocation values is not supported. "+r+(" Invocation Properties: "+yi(this.masterInputKeys)+"."))),t&&ht.CompositionBinder.modelHasPropertiesWithValue(this+"",n.templateKeyInputs,this.getViewModel()),i.length&&pt.error(i[0]+" Blade:'"+this.locator+"'."),t},t.prototype._getTelemetryJourneyId=function(){var n=this._journey||this.services.desktop.getActiveJourney();return n&&n.id},t})(ft.Instance);t.Instance=tr}));
define("MsPortalImpl/UI/Compositions/UI.Composition.Journey",["require","exports","f","o","ko","MsPortalImpl/Base/Base.HierarchyMap","MsPortalImpl/Services/Services.EditScopeManagement","MsPortalImpl/UI/Compositions/UI.Composition","MsPortalImpl/UI/Compositions/UI.Composition.Base","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/Widgets/Widgets.Journey","MsPortalImpl/UI/Compositions/UI.Composition.Blade"],(function(n,t,i,r,u,f,e,o,s,h,c){"use strict";function l(n,t){return n.id===t.id}function y(n){return function(t){return l(n,t)}}function p(n,t){return new a(n,t)}var v,a;r.defineProperty(t,"__esModule",{value:!0});v=o.CompositionType;a=(function(n){function t(t,i,r,e,o,s){var h=n.call(this,"Journey",t,null,r,e,o)||this;return h.journeyBlades=u.observableArray(),h.lastModifiedTime=u.observable(Date.now()),h._store=8,h.originTile=i,h._updateBladesMetadata(),s=h._ambientSettings=s||new f.HierarchyMap,h._setupEditScopeReactor(h.originTile),h}return __extends(t,n),r.defineProperty(t.prototype,"ambientSettings",{get:function(){return this._ambientSettings},enumerable:!0,configurable:!0}),t.prototype.getCompositionType=function(){return v.Journey},t.prototype.getDeepLink=function(){var n=this;return Q(this.awaitComposed()).then((function(){var t=n.blades,i=t.length;return i?t[i-1].getDeepLink():n.originTile.getPartsContainer().getDeepLink()}))},t.prototype.setBladeTitles=function(n){this._bladeTitles=n},t.prototype.isStartedWithContextBlade=function(){var n=this.children;return n.length>0&&!!(n[0].flags&1)},t.prototype.observeEditScopeChanges=function(n,t){this._observeEditScopeChanges(n,t,!0)},t.prototype._observeEditScopeChanges=function(n,t,i){var r=this;u.computed(n,(function(){var s=t.editScopeId&&t.editScopeId(),f,l,a,o;if(s){var y=r.services.diContainer.get(e.EditScopeManager).getStateObservable(s),v=y(),h=v===2,c=v===1||h,n=t.ownerLocatable.journeyPath,u=r._ambientSettings;c?(f=void 0,l=u.getItem(n),l?(a=l.value,a&&(o=a.editScope,o&&(o.dirty!==c||o.saving!==h)&&(u.removeItem(n),f=!0))):f=!0,f&&u.addItem(n,{type:t.ownerType,editScope:{editScopeId:s,dirty:c,saving:h,disposeOnSelectionChange:t.disposeOnSelectionChange,disposeOnJourneyDiscard:i}})):u.removeItem(n)}}))},t.prototype.addChild=function(t,i){n.prototype.addChild.call(this,t,i)},t.prototype.removeChildAt=function(t,i){n.prototype.removeChildAt.call(this,t,i);this._updateBladesMetadata()},t.prototype._addChildrenInternal=function(t,i){n.prototype._addChildrenInternal.call(this,t,i);this._updateBladesMetadata()},t.prototype._setupEditScopeReactor=function(n){var t=this;n&&n.awaitComposed().done((function(){if(!t.isDisposed()&&n.partDefinition.editScopeType){var i=n,r={editScopeId:n.editScopeId,ownerType:n.locator.type,ownerLocatable:n,disposeOnSelectionChange:!1};t._observeEditScopeChanges(i,r,!1)}}))},t.prototype._updateBladesMetadata=function(){var t=this.journeyBlades;if(t){var u=t(),r=i.unique(this.children,l),n=[];u.forEach((function(t){var i=r.first(y(t));i&&(n.push(t),t.subtitle(i.subtitle()),t.title(i.title()))}));n=i.pushUnique(n,r,l);t(n)}},t.prototype._compose=function(n,t){if(!n.getJourneyWidget()){var i=new c.ViewModel(this.id);this.widget=new c.Widget(n.getJourneyArea(),i)}t.resolve()},r.defineProperty(t.prototype,"blades",{get:function(){return this.children},enumerable:!0,configurable:!0}),t})(s.Instance);t.Instance=a;t.create=p}));
define("MsPortalImpl/UI/Compositions/UI.Composition.BladeInvocationHandler",["require","exports","f","o","a","ko","MsPortalImpl/Extension/Extension.Definition.Locator","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpenerBase","MsPortalImpl/UI/Compositions/UI.Composition.BladeOpener.Helpers","MsPortalImpl/UI/Compositions/UI.Composition.PropertyBinding","MsPortalImpl/UI/UI.DesktopManager","MsPortalImpl/UI/Compositions/UI.Composition.Journey","MsPortalImpl/UI/Compositions/UI.Composition.Blade"],(function(n,t,i,r,u,f,e,o,s,h,c){"use strict";var l;return (function(t){function g(n,t,i){function o(){return i.previousInvocationPromise}function s(n,r){var u=i.disableInvocation,e=r.invocationInput;f.unwrap(u)&&(y(l,"Invocation disabled. changes will be ignored and blade(s) not opened",t,e,r.value),n.indicateTaskComplete());return}function h(n,r){var c=r.propertyChanges,o,s,h;if(i.isThrottled()){n.indicateTaskComplete();return}if(o=c[0].propertyArrayEdits,o&&o.length>0&&(s=i.isThrottled,h=t.invocationThrottleDuration,h))return s(!0),u=!0,Q.delay(h).then((function(){e||(u=!1,s(!1),r.value=f.toJS(a(t.masterModel,r.invocationInput.source.property).value))}))}function c(){if(i.selectable2)return Q(t.referenceExtension.processMessages())}function v(n,r){var f=r.invocationInput,s=i.container,e=r.value,u,o;return(y(l,"Executing invocation property change",t,f,e),s.onInvocationStarted(),u=nt(t,i,e,s,i.detailsBladeLocator,i.registrationInfo),u.succeeded?(i.resettingMasterArrayValue=!1,i.prevValue=e):i.resettingMasterArrayValue?(l.error("Resetting value of master '{0}' also caused a prompt".format(t.masterModelId),0,i.prevValue),i.resettingMasterArrayValue=!1):(i.resettingMasterArrayValue=f.opensMultipleBlades,tt(t,f,i.prevValue)),r.reboundBlade=u.reboundBlade,o=u.bladeOpenPromise,o)?o.then((function(n){r.openedBlades=n})):null}function p(){!e&&u&&i.isThrottled(!1);e=!0}var u=!1,e=!1,r;return n.registerForDispose(p),r=[],r[0]=o,r[1]=s,r[2]=h,r[3]=c,r[4]=v,r}function nt(n,t,r,u,f,e){var s=e.invocationInput,c=!0,o=s.opensMultipleBlades&&r,a,h,v,y,p;if(s.opensDynamicBlades&&(a="[BladeOpener]  Selectable is configured to open use dynamic invocation. Value of <null> is unexpected.",h=!1,r===null&&(r=undefined,h=!0),o&&(v=o.length,r=o=o.filter((function(n){return n!==null})),h=o.length!==v),y=i.isDevelopmentMode||i.trace.diagnostics,y&&h&&l.error(a+" \n Master Model id: "+n.masterModelId+"\n Property: "+s.source.property)),r===undefined||o&&o.length===0)p=n.getCloseOwnedDetailBladesHandler(s)||rt.bind(this,n,t,s),c=p();else return it(n,t,r,u,f,e);return{succeeded:c,bladeOpenPromise:undefined,reboundBlade:undefined}}function tt(n,t,i){var e=n.referenceExtension,r=function(){return e.processMessages()};r().then((function(){var v="Set invocation property '"+t.source.property+"' of master '"+n.masterModelId+"' to value.",y;l.verbose("START: "+v,i);var s=t.source.property,o=b(n,t),c=o&&o.isSelected;if(o&&c&&i!==undefined?(y=ut(o,n.masterModelId),y.setInternalSelectedValue(i),c()||c(!0)):h.setModelValue(n.masterModel,s,i),s.indexOf("activatedItems")>=0){var w=s.replace("activatedItems","selectedItems"),p=a(n.masterModel,w),e=p.exists&&p.value;f.isObservable(e)&&u.isArray(e())&&r().then((function(){e.splice.apply(e,[0,e().length].concat(i))}))}l.verbose("END: "+v,i)}))}function it(n,t,r,e,h,a){var y=a.invocationInput,at=a.additionalInputs,rt=t.detailBladesTracker,vt=a.detailsDefinition,p=i.Helpers.Deferred(),b=function(){p.resolve([])},nt=r,tt=!0,ut=n.getCloseOtherDetailBladesHandler(y,vt)||s.tryCloseOtherDetailBlades.bind(this,n,t,y,at),ft=function(t){return n.onBladesOpening(t)},et=n.services.desktop,ot,g,it,lt;if(y.opensMultipleBlades&&!u.isArray(r))l.error("ViewModel property '"+y.source.property+"' of master '"+n.masterModelId+"' is marked as opening multiple blades, but its value is not an array. Value: "+JSON.stringify(r)+"."),b();else if(y.opensMultipleBlades&&nt.length>1)g=r.map((function(i){return w(n,h,i,a,e,!!t.selectable2)})),(tt=ut(g))?(ft(g),et.openMultipleBlades(e.id,g).done((function(n){p.resolve(n)})),t.previousInvocationPromise=Q(p.promise()).finally((function(){t.previousInvocationPromise=undefined}))):b();else if(!u.isArray(r)||nt.length){var st=y.opensMultipleBlades?nt[0]:r,k=w(n,h,st,a,e,!!t.selectable2),yt=t.selectable2&&r.flags&64,pt=k&&k.flags&2;if(tt=ut(yt?[]:[k])){var ht=rt.getBlades(),ct=void 0,d=ht[0];ht.length===1&&d.widget&&!pt==!(d.flags&2)&&(ct=!0,it=v(n.referenceComposition.locator.toString(),st,y),c.isTraceEnabled&&l.verbose("[BladeOpener] Rebinding blade.\n  "+d+".\n  New Model: "+f.toJSON(it)),ot=d,lt=d.rebindAsync(it),t.selectable2?lt.finally(b):b());ct||(ft([k]),et.openSingleBlade(e.id,k).done((function(n){p.resolve([n])})),t.previousInvocationPromise=Q(p.promise()).finally((function(){t.previousInvocationPromise=undefined})))}else b()}return p.done((function(i){var e=t.selectable2,s=a.invocationOutputs,h,r,c,v;i=i||[];h=i.filter((function(n){return e||n&&!(n.flags&2)}));r=h.length===1?h[0]:undefined;rt.track(i);e&&r?o.bindOutputsToSelectable2("Selectable2Outputs",e,r,e.getOutputProperties(),e.getOutputsChangedHandler()):h.length>0&&u.isArray(s)&&s.length>0&&(r?r.awaitComposed().then((function(){n.addOutputBindings(r,s)})):(c=i.map((function(n){return n.getDiagnosticsData()})),v="Unable to create output binding with detail blade, multiple detail blades found."+("\nMaster Model Debug Id: "+n.masterModelId+".")+("\nOutput Arguments: "+f.toJSON(s,null,2))+("\nDetail Blades: "+f.toJSON(c,null,2)),l.error(v)))})),{succeeded:tt,bladeOpenPromise:Q(p.promise()),reboundBlade:ot}}function w(n,t,i,u,f,e){var c=u.invocationInput,l=u.detailsDefinition,k=u.additionalInputs,p=v(n.masterModelId,i,c),w=c.opensDynamicBlades?ft(n,i):t,h,o,y;w=s.getMappedBladeLocator(n.services,w,p,f);var a,b,d=!1,g=!!l.asSubJourney,nt=!1;return c.opensDynamicBlades&&i&&(a=i.openInContextPane,b=i.persistentContextPane,e&&(d=!!(i.flags&2),g=!!(i.flags&8),nt=!!(i.flags&128))),a===undefined&&(a=l.openInContextPane,b=l.persistentContextPane),h=a?1:0,b&&(h|=2),d||(h|=4),g&&(h|=8),nt&&(h|=16),o={locator:w,masterInvocationProperty:c.source.property,bindings:k.slice(0),model:p,masterInputKeys:r.keys(p),masterDetailsDefinition:l,flags:h},k.forEach((function(n){o.model[n.targetProperty]=n.source.constantValue})),n.configureBindings&&o.bindings&&o.bindings.length&&n.configureBindings(o.bindings),n.configureBladeDescriptor(o),y=n.referenceComposition&&n.referenceComposition.partDefinition,i&&(i.assetType&&i.detailBladeInputs?o.originAssetType=i.assetType:i.originAssetType&&i.detailBladeInputs&&i.detailBlade?(o.originAssetType=i.originAssetType,o.originAssetTypeExtension=i.originExtension):y&&(o.originAssetType=y&&y.assetType,o.originAssetTypeExtension=n.referenceExtension&&n.referenceExtension.name)),o}function rt(n,t,i,r){var o=n.services.desktop,h=t.detailBladesTracker,l,f,e,a;if(!o.getActiveJourney())return!0;var u=h.getBlades().filter((function(t){return!t.isDisposed()&&t.masterInvocationProperty===i.source.property&&n.isBladeOpenedByMaster(t)})),v=r||s.shouldSkipPromptForBladesWithEdits(n,u),c=v||o.confirmBladesCanClose(u.map((function(n){return n.id})));if(c)for(l=b(n,i)||{},f=u.length-1;f>=0;f--)e=u[f],a=l._msPortalFxDelayedBladeSelection,n.removeOutputBindings(e),h.untrack(e),o.forceCloseBlade(e.id,1,{openBlade:a});return c}function ut(n,t){var i=n;if(n)return i.lock&&i.setInternalSelectedValue&&i.isLocked||(l.error("selectable is not a framework implementation, view model = '"+t+"'"),i={lock:p,setInternalSelectedValue:function(t){n.selectedValue(t)},isLocked:p}),i}function b(n,t){var i=t.source.property.lastIndexOf("."),r=i>0?t.source.property.substring(0,i):"";return a(n.masterModel,r).value}function ft(n,t){var i=n.referenceExtension;return o.mapDynamicSelectionToBladeLocator(n.services,t,k.forExtension(i.name),n.masterModelId)}var k=e.Locator,d=i.Base.Diagnostics,v=s.mapMasterModelToBladeModel,y=o.traceInvocationChange,l=d.createLog(n),p=i.noop,a=h.getModelValue;t.factory=g})(l||(l={})),l}))