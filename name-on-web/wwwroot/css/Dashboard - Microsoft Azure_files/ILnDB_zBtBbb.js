define("HubsExtension/Notifications/NotificationsAreaFunctions",["require","exports","f","i","o","ko","FxHubs/HubsSettingsSchema","HubsExtension/ArmHelpers/ArmApisStartup","HubsExtension/Common/UserSettingsHelper","HubsExtension/Notifications/EventSubscriptionService"],(function(n,t,i,r,u,f,e,o,s,h){"use strict";function c(n){return n.toLowerCase()}function ot(n){var i=t.lastFetchTimes||{},r;return i[n]||(r=new Date,r.setDate(r.getDate()-7),i[c(n)]=r),t.lastFetchTimes=i,i[n]}function st(n,i){if(n){var r=t.lastFetchTimes||{};r[c(n)]=i;t.lastFetchTimes=r}}function ht(){b||(b=kt.setTimeout((function(){b=null;var n={},i=t.lastFetchTimes;i&&(n[tt]=i);g.writeSettings(n)}),ti))}function vt(n){var t=n.map((function(n){var t=n.properties,i,r;if(t&&(i=ri(t.level,n.status),i&&(r=t.description,r)))return{timestamp:n.timestamp,status:i,title:n.operationName,description:r,correlationIds:[n.correlationId],isServerEvent:!0,additionalProperties:{subscriptionId:t.subscriptionId}}}));t=t.filter(i.notNullOrUndefined);t&&t.length&&w.invoke(p.client,y.Shell,t)}function ii(n){var u=n.map((function(n){return n.subscriptionId})),e=tt;u.length&&g.readSettings([e]).then((function(r){var u=i.convertArrayToMap(n,(function(n){return n.subscriptionId}),i.identity),f=ft(r,(function(n,t,i){var r=Date.parse(t);!isNaN(r)&&u[n]&&(i[c(n)]=new Date(t))}),{});t.lastFetchTimes=f})).finally((function(){var e=!0,n=t.defaultPollingInterval,h=o.getEventDigestsApi,s=function(){var l=[],a=u.map((function(n){var t=new Date,r=fi(ot(n),t,1),u=parseInt(i.getFeatureValue("eventsoverlapminutes")),f;return u&&r.setMinutes(r.getMinutes()-(u>5?5:u)),f=h(n,r,t,e?"Category eq 'Recommendation'":v),st(n,t),f}));e=!1;o.callBatchWithContinuation(a,(function(i){f.utils.arrayPushAll(l,i);n=t.defaultPollingInterval}),(function(i){var f=i.reason||{},e=r.Azure.buildSimplifiedError(f.jqXHR||i.reason||i),o=f.httpStatusCode||e.status,s=((f.content||{}).error||{}).code||e.code||"",h=JSON.stringify(e);if(o===0){ut.verbose(h);n=gt;return}if(!!~[401,403,404].indexOf(o)||o===400&&(c(s)==="disallowedprovider"||c(s)==="disallowedoperation")){var a=i.api,l=/\/subscriptions\/(.*?)\/.*/gi.exec(a);l&&u.remove(l[1]);n=t.defaultPollingInterval}ut.warning(h)}),!0,ni,{responseIsArrayType:!0}).finally((function(){var r=[],o=[],u=[],e;l.forEach((function(n){var t=n&&n.eventSource||{},i=n&&n.resourceProviderName||{};c(t.value||"")===rt?r.push(n):c(i.value||"")==="azure.health"?u.push(n):o.push(n)}));e=o.map(ui).filter((function(n){return!!n}));i.isFeatureEnabled("showservicehealthevents")&&u.length&&t.handleServiceHealthEvents(u);r.length&&t.handleRecommendationEvents(r);e.length&&t.handleServerEvents(f.toJS(e));Q.delay(n).then(s)})).finally((function(){l.length&&ht()}))};s()}))}function ri(n,t){var i,r;return n?(i=dt[c(n)],i===v&&t&&c(t)==="failed"&&(i=1),r=et!==v&&et<=i,!r)?null:i?l.Error:l.Warning:null}function ui(n){var t=n.operationName||a,i=n.resourceProviderName||a;if(t.value&&i.value){var r=n.status||a,u=n.subStatus||a,f=n.eventName||a,e=n.eventSource||a,o={operationName:t.value,source:i.value,assetId:n.resourceUri,status:r.value,subStatus:u.value,correlationId:n.correlationId,timestamp:n.eventTimestamp&&new Date(n.eventTimestamp),properties:{correlationId:n.correlationId,description:n.description,eventChannels:n.eventChannels,eventDataId:n.eventDataId,eventName:f.value,eventNameLocalized:f.localizedValue||"",eventSource:e.value,eventSourceLocalized:e.localizedValue,eventTimestamp:n.eventTimestamp,level:n.level,operationId:n.operationId,operationName:t.value,operationNameLocalized:t.localizedValue,resourceGroupName:n.resourceGroupName,resourceProviderName:i.value||"",resourceProviderNameLocalized:i.localizedValue||"",resourceUri:n.resourceUri,status:r.value,statusLocalized:r.localizedValue,submissionTimestamp:n.submissionTimestamp,subscriptionId:n.subscriptionId,subStatus:u.value||"",subStatusLocalized:u.localizedValue||""}};return ft(n.properties,(function(n,t,i){i.hasOwnProperty(n)||(i[n]=t)}),o.properties),o}}function fi(n,t,i){n=n<t?n:t;var r=new Date(t.getTime());return r.setDate(r.getDate()-i),n<r?r:n}var ct,lt,at;u.defineProperty(t,"__esModule",{value:!0});var k=i.Base,yt=k.Diagnostics,p=r.Rpc,y=k.Constants,d=r.NotificationManager,pt=r.Hubs.Notifications,wt=i.Hubs.Notifications,l=wt.NotificationStatus,bt=e.Keys,g=s.UserSettingsHelper,kt=window,nt=i.isFeatureEnabled("fasteventservice"),tt=bt.lastRecommendationsFetchTime,it="recommendationExpirationDate",rt="recommendation",ut=yt.createLog(n),v=undefined,dt={warning:0,error:1,critical:2},ft=i.forEachKey,a={localizedValue:v,value:v};t.defaultPollingInterval=nt?2e3:6e5;var gt=nt?5e3:12e5,ni=o.makeResourceManagerTelemetry("Notifications.load"),w=pt.addClientNotificationsDefinition,et=1,b,ti=3e5;t.getLastFetchTime=ot;t.setLastFetchTime=st;t.writeLastFetchTimesToUserSettings=ht;ct=function(n){if(n&&n.length>0){var t=[];n.forEach((function(n){var u=n.eventName,f=n.description,r,e,o;if(u&&f){e=c(n.level||"");switch(e){case"warning":r=l.Warning;break;case"error":r=l.Error;break;default:r=l.Information}o=i.isFeatureEnabled("azurehealth")?"#blade/Microsoft_Azure_Health/AzureHealthBrowseBlade":i.isFeatureEnabled("servicenotificationsblade")?"#blade/Microsoft_Azure_Monitoring/ServiceNotificationsBlade":"#blade/HubsExtension/ServicesHealthBlade";t.push({timestamp:new Date(n.eventTimestamp),status:r,title:u.localizedValue||u.value,description:f,correlationIds:[n.correlationId],isServerEvent:!0,uri:o})}}));t.length&&w.invoke(p.client,y.Shell,t)}};t.handleServiceHealthEvents=ct;lt=function(n){if(n&&n.length){var t=[],r=[];n.forEach((function(n){var f=n.operationName,e=n.resourceUri,o=n.properties,s;f&&n.description&&o&&o[it]&&e&&(s=new Date(n.properties[it]),s>=new Date&&(r.push(i.Assets.mapResourceIdToDynamicSelectionAndIcon(e).then((function(r){var e=r.selection,o={},s=u.keys(n.properties).filter((function(n){return n.startsWith(rt)}));s.forEach((function(t){o[t]=n.properties[t]}));e.detailBladeInputs=e.detailBladeInputs||{};i.extend(e.detailBladeInputs,{referrerInfo:o});t.push({timestamp:new Date(n.eventTimestamp),status:l.Information,title:f.localizedValue||f.value,description:n.description,correlationIds:[n.correlationId],linkedBlade:e,isRecommendation:!0,additionalProperties:o,isServerEvent:!0})}),(function(){}))),Q.allSettled(r).then((function(){t&&t.length&&w.invoke(p.client,y.Shell,t)}))))}))}};t.handleRecommendationEvents=lt;at=function(n){n&&n.length&&(d.addServerEventsEndPoint.invoke(d.rpcClient,y.Shell,{serverEvents:n.slice(0,100)}),vt(n),h.matchEvents(n))};t.handleServerEvents=at;t.publishClientNotifications=vt;t.loadNotifications=ii}))